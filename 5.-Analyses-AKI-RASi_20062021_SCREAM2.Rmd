---
title: Analyses for study on discontinuing RASi after an episode of AKI in SCREAM2
author: "Roemer J. Janse"
date: "20th of June 2021"
output:
  word_document: 
    toc: yes
    toc_depth: 6
    fig_width: 4
    fig_height: 3
  pdf_document:
    toc: yes
    toc_depth: 6
  html_document:
    toc: yes
    toc_depth: 6
header-includes:
- \usepackage{subfig}
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
geometry: left=0.6cm,right=0.6cm,top=0.6cm,bottom=0.6cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, evaluate = TRUE, tidy = TRUE,
                      cache = FALSE, autodep = TRUE, 
                      warning = FALSE, message = FALSE,
                      out.width = '800px', dpi = 300)


# packages
pacman::p_load("dplyr","tidyr","Gmisc","knitr", "broom", "ggplot2","survival","reshape2","data.table","tableone", "broom", "formatR", 
               "xtable","kableExtra","pander","epiR","forestplot","biostat3","paf","Hmisc","summarytools","twang", "survey", "KMunicate", 
               "cowplot", "patchwork", "gridExtra", "ggpubr", "stringr")
options(knitr.table.format = 'markdown')

```

```{r data settings}
# This is used to load the data
# You need to adjust this to your own directory
rm(list = ls()) 

if(.Platform$OS.type == "windows"){
  load("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/population.Rdata")
} else {
  load("~/Onedrive/Documents/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/population.Rdata")
}

cohort1 <- filter(population, cohort == 1)
cohort2 <- filter(population, cohort == 2)
cohort1_lab <- filter(population, cohort == 1 & lab_outcome == 1)
cohort2_lab <- filter(population, cohort == 2 & lab_outcome == 1)

```


# 0. Data dictionary
```{r}
view(dfSummary(cohort1)) # in the right of your screen you will see a figure appearing. Click on "Show in new window" to enlarge

```


# 1. Main analyses
## 1.1. Baseline characteristics
```{r include=FALSE}
# This code is used to make the baseline table. We will do this before and after the propensity score weighting

# Specify which variables in the dataset you want to include in the baseline table
listvar <- c("age", "age_cat", "female", "educ_cat", "adm_egfr", "adm_egfr_cat", "comorb_dm", "comorb_ht", "comorb_mi", "comorb_arr",
             "comorb_cd", "comorb_pvd", "comorb_ihd", "comorb_copd", "comorb_ca", "comorb_ld",  "comorb_chf", "comorb_dl", "comorb_hyth", 
             "comorb_eh", "comorb_vhd", "med_bb", "med_ccb", "med_ld", "med_td", "med_pd", "med_nsaid", "med_al", "med_ab",  "med_nt", 
             "med_ara", "med_hl", "med_aa", "med_dx", "med_ac", "med_dm", "med_op", "kontakt_all", "kontakt_all_cat", "kontakt_cv",
             "kontakt_cv_cat", "ovr_all", "ovr_all_cat", "ovr_cv", "ovr_cv_cat", "slv_all", "slv_all_cat", "slv_cv", "slv_cv_cat", 
             "hosp_cv", "hosp_rs", "hosp_gi", "hosp_id", "hosp_ca", "hosp_op", "hosp_hm", "hosp_gu", "hosp_ip", 
             "hosp_ns", "hosp_hk", "hosp_od", "pc_sp", "pc_cs", "pc_cc", "pc_ar", "pc_pn", "pc_lf", "pc_mi", "pc_ns", "dur", "AKI_acoa", 
             "crit_type", "AcutDial", "creat_mean", "creat_peak", "potass_mean", "potass_peak", "acr", "acr_cat", "chol") 

# specify which variables are continuous
continuous <- c("age","adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur", "creat_mean", 
                "creat_peak", "potass_mean", "potass_peak", "acr", "chol") 

catvar <- listvar[!listvar %in% continuous] # specify that all other variables except the ones specified previously are categorical

# Give labels to the variables
labels <- c("Number of individuals",
            "Median age (IQR) (years)", 
            "Age category (years)", "< 50", "50-59", "60-69", "70-79", "> 80",
            "Female", 
            "Highest level of education achieved", "Compulsory school", "Secondary school", "University", "Missing",
            "Median eGFR before admission (IQR) (ml/min/1.73 m2)",
            "CKD categories", "G1", "G2", "G3a", "G3b", "G4",
            "Diabetes mellitus",
            "Hypertension",
            "Myocardial infarction",
            "Arrythmia",
            "Cerebrovascular disease",
            "Peripheral vascular disease",
            "Ischemic heart disease",
            "Chronic obstructive pulmonary disease",
            "Cancer",
            "Liver disease",
            "Chronic heart failure",
            "Dyslipidemia",
            "Hypothyroidism", 
            "Extracranial hemorrhage",
            "Valvular heart disease",
            "Beta blockers",
            "Calcium channel blockers",
            "Loop diuretics",
            "Thiazide diuretics",
            "Potassium-sparing diuretics",
            "NSAIDs",
            "Antilipids",
            "Alpha blockers",
            "Nitrate",
            "MRAs",
            "Hydralazine",
            "Antiarrythmics",
            "Digoxin",
            "Anticoagulants",
            "Diabetes medication",
            "Opioids",
            "Median primary care context contacts (IQR)",
            "Amount of primary care contex contacts", "Zero", "One", "Two", "Three or more",
            "Cardiovascular primary care context contacts (IQR)",
            "Amount of cardiovascular primary care contex contacts", "Zero", "One", "Two", "Three or more",
            "Median specialist care context contacts (IQR)",
            "Amount of specialist care contex contacts", "Zero", "One", "Two", "Three or more",
            "Median cardiovascular specialist context care contacts (IQR)",
            "Amount of cardiovascular specialist care contex contacts", "Zero", "One", "Two", "Three or more",
            "Median number of hospitalizations (IQR)",
            "Amount of hospitalizations", "Zero", "One", "Two", "Three or more",
            "Median number of cardiovascular hospitalizations (IQR)",
            "Amount of cardiovascular hospitalizations", "Zero", "One", "Two", "Three or more",
            "Cardiovascular disease",
            "Respiratory disease",
            "Gastrointestinal, metabolic, and endocrine disease",
            "Infectious disease",
            "Cancer",
            "Musculoskeletal and connective tissue disease",
            "Hematologic disease",
            "Genitourinary disease",
            "Injury or poisoning",
            "Neurological disease",
            "Hyperkalemia",
            "Other disease",
            "Sepsis",
            "Cardiac surgery",
            "Cardiac catherization",
            "Abdominal aortic aneurysm repair",
            "Pneumonia",
            "Liver failure",
            "Acute myocardial infarction",
            "Non-cardiac surgery",
            "Median duration of stay (IQR) (days)",
            "AKI as cause of admission",
            "Stage of AKI KDIGO", "N17", "Stage II", "Stage III",
            "Need for acute dialysis",
            "Median of average creatinine during hospitalization (IQR) (umol/L)",
            "Median of peak creatinine during hospitalization (IQR) (umol/L)",
            "Mean potassium (mmol/L)",
            "Peak potassium (mmol/L)",
            "Albumin-creatinine ratio (mg/mmol)",
            "Albumin-creatinine ratio categories", "< 3", "3-29", "30-69", "> 70", "Missing",
            "Total cholesterol (mmol/L)") 

# Makes overall baseline table
# For more information what is specified here, please see:
# https://www.rdocumentation.org/packages/tableone/versions/0.12.0/topics/CreateTableOne 
# https://www.rdocumentation.org/packages/tableone/versions/0.12.0/topics/print.TableOne
table_overall <- CreateTableOne(vars = listvar, data = cohort1, factorVars = catvar) # 
table_overall <- print(table_overall, printToggle = FALSE, noSpaces = TRUE, catDigits = 0, contDigits = 1, pDigits = 3,
                       nonnormal = c("age", "adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur",
                                     "creat_mean", "creat_peak", "acr")) 
table_overall <- as.matrix(table_overall)
row.names(table_overall) <- labels

# Makes baseline table stratified by treatment level
table_stratified <- CreateTableOne(vars = listvar, data = cohort1, factorVars = catvar, smd = TRUE, strata = "stopping")
table_stratified <- print(table_stratified, printToggle = FALSE, noSpaces = TRUE, catDigits = 0, contDigits = 1, pDigits = 3,
                          nonnormal = c("age", "adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur",
                                        "creat_mean", "creat_peak", "acr"), smd = TRUE) 
table_stratified <- as.matrix(table_stratified[, c(2, 1, 5)])
row.names(table_stratified) <- labels

# Combine tables and add notes
table1 <- cbind(table_overall,table_stratified) 
colnames(table1) <- c("Overall","Stopped RASi","Continued RASi","SMD")

# remove objects
rm(listvar, continuous, catvar, labels, table_overall, table_stratified)

```


## 1.2 Total number of events, person years, and incidence rates
```{r include=FALSE}
# This is a piece of code to get the overall incidence of the outcome (not stratified by treatment)
incid_num_ovr <- function(outcome, time2outcome, cohort){
  incid_ovr <- survRate(Surv((time2outcome / (365.25 * 100)), outcome) ~ 0) %>%
    mutate(tstop = tstop * 100) %>% mutate_at(vars(rate, lower, upper), funs(round(., 1))) %>% mutate_at(vars(tstop), funs(round(., 0)))
  incid_ovr <- as.data.frame(incid_ovr) %>% mutate(rate = gsub(pattern = " ", replacement = "", x = rate),
                                                   lrate = nchar(rate),
                                                   rate = ifelse(lrate == 1 | lrate == 2, paste(rate, ".0", sep = ""), rate),
                                                   lower = gsub(pattern = " ", replacement = "", x = lower),
                                                   llower = nchar(lower),
                                                   lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                                   upper = gsub(pattern = " ", replacement = "", x = upper),
                                                   lupper = nchar(upper),
                                                   upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                                   rate = paste(rate, " (", lower, "-", upper,")", sep = ""))
  incid_ovr <- incid_ovr[, 1:4] %>% dplyr::select(event, tstop, rate) %>% 
    mutate(n = nrow(cohort)) %>% relocate(n, .before = event)
  return(incid_ovr)
}

# This is a piece of code to get the incidence stratified by treatment
incid_num_str <- function(outcome, time2outcome, cohort_stopping, cohort){
  ir <- survRate(Surv((time2outcome / (365.25 * 100)), outcome) ~ cohort_stopping) %>% 
    mutate(tstop = tstop * 100) %>% mutate_at(vars(rate, lower, upper), funs(round(., 1))) %>% mutate_at(vars(tstop), funs(round(., 0)))
  ir <- as.data.frame(ir) %>% mutate(rate = gsub(pattern = " ", replacement = "", x = rate),
                                     lrate = nchar(rate),
                                     rate = ifelse(lrate == 1 | lrate == 2, paste(rate, ".0", sep = ""), rate),
                                     lower = gsub(pattern = " ", replacement = "", x = lower),
                                     llower = nchar(lower),
                                     lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                     upper = gsub(pattern = " ", replacement = "", x = upper),
                                     lupper = nchar(upper),
                                     upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                     rate = paste(rate, " (", lower, "-", upper,")", sep = "")) 
  ir <- ir[, 2:4] %>% dplyr::select(event, tstop, rate)
  x <- as.data.frame(count(cohort, stopping))
  n <- rbind(x$n[[1]], x$n[[2]])
  ir <- cbind(n, ir)
  return(ir)
}

# Incidence table function
inctab <- function(event, time2event, cohort_stopping, cohort){
  incid_overall <- incid_num_ovr(event, time2event, cohort)
  colnames(incid_overall) <- c("N", "Events","py","Incidence rate per 100 py")
  rownames(incid_overall) <- c("Overall")
  
  incid_stratified <- incid_num_str(event, time2event, cohort_stopping, cohort)
  colnames(incid_stratified) <- c("N", "Events","py","Incidence rate per 100 py")
  rownames(incid_stratified) <- c("Continued RASi","Stopped RASi")
  
  incidence_table <- as.matrix(rbind(incid_overall, incid_stratified))
  return(incidence_table)
}

# Title function
tabtitle <- function(titlename){
  title <- transpose(as.data.frame(c("", "", "", "")))
  colnames(title) <- c("N", "Events","py","Incidence rate per 100 py")
  rownames(title) <- c(titlename)
  return(title)
}

# Outcomes
title_comp <- tabtitle("Composite of mortality and MACE")
incidence_table_comp <- inctab(cohort1$event_comp, cohort1$time2comp, cohort1$stopping, cohort1)
title_death <- tabtitle("Mortality")
incidence_table_death <- inctab(cohort1$event_mort, cohort1$time2death, cohort1$stopping, cohort1)
title_aki <- tabtitle("Recurrent AKI")
incidence_table_aki <- inctab(cohort1$event_aki, cohort1$time2aki, cohort1$stopping, cohort1)
title_hf <- tabtitle("Heart failure hospitalisation")
incidence_table_hf <- inctab(cohort1$event_hf, cohort1$time2hf, cohort1$stopping, cohort1)
title_eskd <- tabtitle("ESKD")
incidence_table_eskd <- inctab(cohort1_lab$event_eskd, cohort1_lab$time2eskd, cohort1_lab$stopping, cohort1_lab)
title_ckd <- tabtitle("CKD progression")
incidence_table_ckd <- inctab(cohort1_lab$event_ckd, cohort1_lab$time2ckd, cohort1_lab$stopping, cohort1_lab)
title_hkmod <- tabtitle("Moderate hyperkalemia")
incidence_table_hkmod <- inctab(cohort1_lab$event_hk_moderate, cohort1_lab$time2hk_moderate, cohort1_lab$stopping, cohort1_lab)
title_mace <- tabtitle("MACE")
incidence_table_mace <- inctab(cohort1$event_mace, cohort1$time2mace, cohort1$stopping, cohort1)

incidence_table <- as.matrix(rbind(title_comp, incidence_table_comp, 
                                   title_death, incidence_table_death, title_aki, incidence_table_aki, title_hf, incidence_table_hf, 
                                   title_eskd, incidence_table_eskd, title_ckd, incidence_table_ckd, 
                                   title_hkmod, incidence_table_hkmod, title_mace, incidence_table_mace))
kable(incidence_table)

rm(title_comp, incidence_table_comp, title_death, incidence_table_death, title_aki, 
   incidence_table_aki, title_hf, incidence_table_hf, title_eskd, incidence_table_eskd, title_ckd, incidence_table_ckd, title_hkmod, 
   incidence_table_hkmod, title_mace, incidence_table_mace)

### Components of primary outcomes
title_comp_death <- tabtitle("Death")
incidence_table_comp_death <- inctab(cohort1$event_comp_death, cohort1$time2comp_death, cohort1$stopping, cohort1)
title_comp_mi <- tabtitle("Myocardial infarction")
incidence_table_comp_mi <- inctab(cohort1$event_comp_mi, cohort1$time2comp_mi, cohort1$stopping, cohort1)
title_comp_stroke <- tabtitle("Stroke")
incidence_table_comp_stroke <- inctab(cohort1$event_comp_stroke, cohort1$time2comp_stroke, cohort1$stopping, cohort1)

incidence_table_components <- as.matrix(rbind(title_comp_death, incidence_table_comp_death, title_comp_mi, incidence_table_comp_mi,
                                              title_comp_stroke, incidence_table_comp_stroke))

```


## 1.3. Unadjusted Cox regression model
```{r include=FALSE}
# Unadjusted Cox model with univariabele regression
# Function to create model and table
coxunadjusted <- function(event, time2event, cohort_stopping){
  cox_unadjusted <- coxph(Surv(time2event, event) ~ as.factor(cohort_stopping)) 
  dat <- summary(cox_unadjusted) # outputs coefficients of unadjusted Cox model and HR's with confidence intervals
  
  # This code is just used to put the hazard ratios and confidence intervals in a table
  table_unadj <- format(round(cbind(dat$coef, exp(confint(cox_unadjusted))),2), nsmall = 2) %>% as.data.frame() %>%
    filter(row_number() == 1) 
  table_unadj <- table_unadj[, c(2, 6:7)] 
  colnames(table_unadj) <- c("HR","lower","upper") 

  table_unadj <- as.data.frame(table_unadj) %>% mutate(HR = gsub(pattern = " ", replacement = "", x = HR),
                                                       lHR = nchar(HR),
                                                       HR = ifelse(lHR == 1 | lHR == 2, paste(HR, ".0", sep = ""), HR),
                                                       lower = gsub(pattern = " ", replacement = "", x = lower),
                                                       llower = nchar(lower),
                                                       lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                                       upper = gsub(pattern = " ", replacement = "", x = upper),
                                                       lupper = nchar(upper),
                                                       upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                                       HR = paste(HR, " (", lower, "-", upper,")", sep = "")) 
  table_unadj <- as.data.frame(table_unadj[, 1])  
  colnames(table_unadj) <- "Crude HR (95% CI)"
  return(table_unadj)
}

# Outcomes
table_unadj_comp <- rbind("", "", "1 (Reference)", coxunadjusted(cohort1$event_comp, cohort1$time2comp, cohort1$stopping))
table_unadj_death <- rbind("", "", "1 (Reference)", coxunadjusted(cohort1$event_mort, cohort1$time2death, cohort1$stopping))
table_unadj_aki <- rbind("", "", "1 (Reference)", coxunadjusted(cohort1$event_aki, cohort1$time2aki, cohort1$stopping))
table_unadj_hf <- rbind("", "", "1 (Reference)", coxunadjusted(cohort1$event_hf, cohort1$time2hf, cohort1$stopping))
table_unadj_eskd <- rbind("", "", "1 (Reference)", coxunadjusted(cohort1_lab$event_eskd, cohort1_lab$time2eskd, cohort1_lab$stopping))
table_unadj_ckd <- rbind("", "", "1 (Reference)", coxunadjusted(cohort1_lab$event_ckd, cohort1_lab$time2ckd, cohort1_lab$stopping))
table_unadj_hkmod <- rbind("", "", "1 (Reference)", coxunadjusted(cohort1_lab$event_hk_moderate, cohort1_lab$time2hk_moderate, 
                                                                  cohort1_lab$stopping))
table_unadj_mace <- rbind("", "", "1 (Reference)", coxunadjusted(cohort1$event_mace, cohort1$time2mace, cohort1$stopping))

cox_table_unadjusted <- rbind(table_unadj_comp, table_unadj_death, table_unadj_aki, table_unadj_hf, table_unadj_eskd, table_unadj_ckd,
                              table_unadj_hkmod, table_unadj_mace)

rm(table_unadj_death, table_unadj_aki, table_unadj_hf, table_unadj_eskd, table_unadj_ckd, 
   table_unadj_hkmod, table_unadj_mace, table_unadj_comp)

### Components of primary outcome
table_unadj_comp_death <- rbind("", "", "1 (Reference)", coxunadjusted(cohort1$event_comp_death, cohort1$time2comp_death, cohort1$stopping))
table_unadj_comp_mi <- rbind("", "", "1 (Reference)", coxunadjusted(cohort1$event_comp_mi, cohort1$time2comp_mi, cohort1$stopping))
table_unadj_comp_stroke <- rbind("", "", "1 (Reference)", coxunadjusted(cohort1$event_comp_stroke, cohort1$time2comp_stroke, 
                                                                        cohort1$stopping))

cox_table_unadjusted_comp <- rbind(table_unadj_comp_death, table_unadj_comp_mi, table_unadj_comp_stroke)

```


## 1.4. Weighting
### 1.4.1. Estimating overlap weights
```{r}
### Normal cohort
## Create propensity score (needed for denominator): chance of receiving treatment given covariates
# Create logistic regression using covariates
denom.fit <- glm(stopping ~ age + age_cat + female + educ_cat + adm_egfr + adm_egfr_cat + comorb_dm + comorb_ht + comorb_mi + comorb_arr +
                 comorb_cd + comorb_pvd + comorb_ihd + comorb_copd + comorb_ca + comorb_ld + comorb_chf + comorb_dl + comorb_hyth + 
                 comorb_eh + comorb_vhd + med_bb + med_ccb + med_ld + med_td + med_pd + med_nsaid + med_al + med_ab + med_nt + med_ara + 
                 med_hl + med_aa + med_dx + med_ac + med_dm + med_op + kontakt_all + kontakt_cv + slv_all + slv_cv + ovr_all + ovr_cv + 
                 kontakt_all_cat + kontakt_cv_cat + slv_all_cat + slv_cv_cat + ovr_all_cat + ovr_cv_cat + hosp_cv + hosp_rs + hosp_gi + 
                 hosp_id + hosp_ca + hosp_op + hosp_hm + hosp_gu + hosp_ip + hosp_ns + hosp_hk + hosp_od + 
                 pc_sp + pc_cs + pc_cc + pc_ar + pc_pn + pc_lf + pc_mi + pc_ns + dur + AKI_acoa + crit_type + AcutDial + creat_mean +
                 creat_peak, family = binomial(), data = cohort1)

# Fill in regression formula per person to create propensity score
pred_denom <- predict(denom.fit, type = "response")

# Add propensity score to dataframe
cohort1$ps <- pred_denom
normalize0 <- sum(cohort1$ps[which(cohort1$stopping == 0)])
normalize1 <- sum(cohort1$ps[which(cohort1$stopping == 1)])

# Calculating overlap weights
# Weighted pseudopopulation will be as large as original population
cohort1$ow <- ifelse(cohort1$stopping == 0, pred_denom / normalize0,  (1 - pred_denom) / normalize1)
summary(cohort1$ow)

### Lab cohort
## Create propensity score (needed for denominator): chance of receiving treatment given covariates
# Create linear regression using covariates
denom.fit <- glm(stopping ~ age + age_cat + female + educ_cat + adm_egfr + adm_egfr_cat + comorb_dm + comorb_ht + comorb_mi + comorb_arr +
                 comorb_cd + comorb_pvd + comorb_ihd + comorb_copd + comorb_ca + comorb_ld + comorb_chf + comorb_dl + comorb_hyth + 
                 comorb_eh + comorb_vhd + med_bb + med_ccb + med_ld + med_td + med_pd + med_nsaid + med_al + med_ab + med_nt + med_ara + 
                 med_hl + med_aa + med_dx + med_ac + med_dm + med_op + kontakt_all + kontakt_cv + slv_all + slv_cv + ovr_all + ovr_cv + 
                 kontakt_all_cat + kontakt_cv_cat + slv_all_cat + slv_cv_cat + ovr_all_cat + ovr_cv_cat + hosp_cv + hosp_rs + hosp_gi + 
                 hosp_id + hosp_ca + hosp_op + hosp_hm + hosp_gu + hosp_ip + hosp_ns + hosp_hk + hosp_od + pc_sp + pc_cs + pc_cc + pc_ar + 
                 pc_pn + pc_lf + pc_mi + pc_ns + dur + AKI_acoa + crit_type + AcutDial + creat_mean + creat_peak, family = binomial(), 
                 data = cohort1_lab)

# Fill in regression formula per person to create propensity score
pred_denom <- predict(denom.fit, type = "response")

# Add propensity score to dataframe
cohort1_lab$ps <- pred_denom
normalize0 <- sum(cohort1_lab$ps[which(cohort1_lab$stopping == 0)])
normalize1 <- sum(cohort1_lab$ps[which(cohort1_lab$stopping == 1)])

# Calculating overlap weights
# Weighted pseudopopulation will be as large as original population
cohort1_lab$ow <- ifelse(cohort1_lab$stopping == 0, pred_denom / normalize0,  (1 - pred_denom) / normalize1)
summary(cohort1_lab$ow)

```


### 1.4.2. Baseline characteristics after weighting
```{r}
# Create a weighted survey design object
cohort1Svy <- svydesign(ids = ~ lopnr, weights = ~ ow, data = cohort1)

# Specify which variables in the dataset you want to include in the baseline table
listvar <- c("age", "age_cat", "female", "educ_cat", "adm_egfr", "adm_egfr_cat", "comorb_dm", "comorb_ht", "comorb_mi", "comorb_arr",
             "comorb_cd", "comorb_pvd", "comorb_ihd", "comorb_copd", "comorb_ca", "comorb_ld",  "comorb_chf", "comorb_dl", "comorb_hyth", 
             "comorb_eh", "comorb_vhd", "med_bb", "med_ccb", "med_ld", "med_td", "med_pd", "med_nsaid", "med_al", "med_ab",  "med_nt", 
             "med_ara", "med_hl", "med_aa", "med_dx", "med_ac", "med_dm", "med_op", "kontakt_all", "kontakt_all_cat", "kontakt_cv",
             "kontakt_cv_cat", "ovr_all", "ovr_all_cat", "ovr_cv", "ovr_cv_cat", "slv_all", "slv_all_cat", "slv_cv", "slv_cv_cat", 
             "hosp_cv", "hosp_rs", "hosp_gi", "hosp_id", "hosp_ca", "hosp_op", "hosp_hm", "hosp_gu", "hosp_ip", 
             "hosp_ns", "hosp_hk", "hosp_od", "pc_sp", "pc_cs", "pc_cc", "pc_ar", "pc_pn", "pc_lf", "pc_mi", "pc_ns", "dur", "AKI_acoa", 
             "crit_type", "AcutDial", "creat_mean", "creat_peak", "potass_mean", "potass_peak", "acr", "acr_cat", "chol") 

# specify which variables are continuous
continuous <- c("age","adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur", "creat_mean", 
                "creat_peak", "potass_mean", "potass_peak", "acr", "chol") 

catvar <- listvar[!listvar %in% continuous] # specify that all other variables except the ones specified previously are categorical

# Give labels to the variables
  labels <- c("Number of individuals",
              "Median age (IQR) (years)", 
              "Age category (years)", "< 50", "50-59", "60-69", "70-79", "> 80",
              "Female", 
              "Highest level of education achieved", "Compulsory school", "Secondary school", "University", "Missing", 
              "Median eGFR before admission (IQR) (ml/min/1.73 m2)",
              "CKD categories", "G1", "G2", "G3a", "G3b", "G4",
              "Diabetes mellitus",
              "Hypertension",
              "Myocardial infarction",
              "Arrythmia",
              "Cerebrovascular disease",
              "Peripheral vascular disease",
              "Ischemic heart disease",
              "Chronic obstructive pulmonary disease",
              "Cancer",
              "Liver disease",
              "Chronic heart failure",
              "Dyslipidemia",
              "Hypothyroidism",
              "Extracranial hemorrhage",
              "Valvular heart disease",
              "Beta blockers",
              "Calcium channel blockers",
              "Loop diuretics",
              "Thiazide diuretics",
              "Potassium-sparing diuretics",
              "NSAIDs",
              "Antilipids",
              "Alpha blockers",
              "Nitrate",
              "MRAs",
              "Hydralazine",
              "Antiarrythmics",
              "Digoxin",
              "Anticoagulants",
              "Diabetes medication",
              "Opioids",
              "Median primary care context contacts (IQR)",
              "Amount of primary care contex contacts", "Zero", "One", "Two", "Three or more",
              "Cardiovascular primary care context contacts (IQR)",
              "Amount of cardiovascular primary care contex contacts", "Zero", "One", "Two", "Three or more",
              "Median specialist care context contacts (IQR)",
              "Amount of specialist care contex contacts", "Zero", "One", "Two", "Three or more",
              "Median cardiovascular specialist context care contacts (IQR)",
              "Amount of cardiovascular specialist care contex contacts", "Zero", "One", "Two", "Three or more",
              "Median number of hospitalizations (IQR)",
              "Amount of hospitalizations", "Zero", "One", "Two", "Three or more",
              "Median number of cardiovascular hospitalizations (IQR)",
              "Amount of cardiovascular hospitalizations", "Zero", "One", "Two", "Three or more",
              "Cardiovascular disease",
              "Respiratory disease",
              "Gastrointestinal, metabolic, and endocrine disease",
              "Infectious disease",
              "Cancer",
              "Musculoskeletal and connective tissue disease",
              "Hematologic disease",
              "Genitourinary disease",
              "Injury or poisoning",
              "Neurological disease",
              "Hyperkalemia",
              "Other disease",
              "Sepsis",
              "Cardiac surgery",
              "Cardiac catherization",
              "Abdominal aortic aneurysm repair",
              "Pneumonia",
              "Liver failure",
              "Acute myocardial infarction",
              "Non-cardiac surgery",
              "Median duration of stay (IQR) (days)",
              "AKI as cause of admission",
              "Stage of AKI KDIGO", "N17", "Stage II", "Stage III",
              "Need for acute dialysis",
              "Median of average creatinine during hospitalization (IQR) (umol/L)",
              "Median of peak creatinine during hospitalization (IQR) (umol/L)",
              "Mean potassium (mmol/L)",
              "Peak potassium (mmol/L)",
              "Albumin-creatinine ratio (mg/mmol)",
              "Albumin-creatinine ratio categories", "< 3", "3-29", "30-69", "> 70", "Missing",
              "Total cholesterol (mmol/L)")  

# Characteristics stratified by treatment group
table_weighted <- svyCreateTableOne(vars = listvar, data = cohort1Svy, factorVars = catvar, strata = "stopping")
table_weighted <- print(table_weighted, printToggle = FALSE, 
                        nonnormal = c("age", "adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur",
                                      "creat_mean", "creat_peak", "acr"), noSpaces = TRUE, 
                        catDigits = 1, contDigits = 1, pDigits = 3, smd = TRUE)
table_weighted <- as.matrix(table_weighted[, c(2, 1, 5)])
row.names(table_weighted) <- labels
colnames(table_weighted) <- c("Stopped RASi", "Continued RASi", "SMD")

# kable(table_weighted, align = "c", caption = title)

rm(listvar, continuous, catvar, labels, cohort1Svy) 

table1_final <- cbind(table1, table_weighted)

```


### 1.4.3. SMDs for categories before and after weighting
```{r}
stand_diff <- function(pT, pC){
  d <- (pT-pC)/(sqrt((pT*(1-pT)+pC*(1-pC))/2))
  return(d)
}

# Function for calculating SMD
fillSMD <- function(weighted = NULL, row){
  # Determine whether the SMD is for the column of the weighted or unweighted population
  if(is.null(weighted)) stop("Indicate whether the SMD is for the weighted or unweighted population")
  col <- ifelse(weighted == FALSE, 4, 7)
  
  # Retrieve proportion reported in table
  pT <- as.numeric(gsub("[()]", "", str_match(table1_final[row, (col - 2)], "\\(\\d+.*\\d*\\)"))) / 100
  pC <- as.numeric(gsub("[()]", "", str_match(table1_final[row, (col - 1)], "\\(\\d+.*\\d*\\)"))) / 100
  
  # Calculate SMD
  smd <- round(stand_diff(pT, pC), 3)
  smd <- ifelse(smd < 0, smd * (-1), smd)
  smd <- ifelse(smd == 0, "<0.001", smd)
  smd <- ifelse(nchar(smd) == 3, paste(smd, "00", sep = ""), smd)
  smd <- ifelse(nchar(smd) == 4, paste(smd, "0", sep = ""), smd)
  
  # Fill in SMD
  table1_final[row, col] <- smd
  return(table1_final)
}

# Get rownumbers which need a SMD
table_rownumbers <- table1_final
colnames(table_rownumbers) <- c("ovr", "t1", "c2", "smd1", "t2", "c2", "smd2")
table_rows <- as.data.frame(table_rownumbers) %>% dplyr::select(smd1) %>% mutate(rownr = 1:nrow(table1_final)) %>% 
  filter(smd1 == "" & rownr != 1)
rows <- table_rows$rownr

# Fill SMD for each rownumber
for(i in rows){
  table1_final <- fillSMD(weighted = FALSE, row = i)
  table1_final <- fillSMD(weighted = TRUE, row = i)
}

## Start only showing percentages
# Check which data contains means (SD), as these should not have their mean deleted
table_rownumbers <- as.data.frame(table_rownumbers) %>% dplyr::select(ovr, smd1) %>% mutate(rownr = 1:nrow(table1_final))

# Omit rows 118, 119, and 127, in addition to all rows without brackets
rows <- filter(table_rownumbers, !(rownr == 118 | rownr == 119 | rownr == 127) & grepl("[()]", ovr))$rownr

for(c in c(1:3, 5:6)){
  for(i in rows){
    table1_final[i, c] <- gsub("[()]", "", str_match(table1_final[i, c], "\\(\\d+.*\\d*\\)"))
  }
}

# We want only cholesterol, ACR, and potassium to show decimals, so here we round everything
# These are rows 118, 119, 120, and 127 we want to exclude (i.e., keep decimals)
# Lots of variables are already rounded during creation of the table, thus now we only specify only those we want to round.
# These are variables median age, median egfr, median healthcare contacts (all 6), duration of stay, and average and peak creatinine
# Means and medians have different patterns. Here, I only have to take care of medians, but take care to specify different patterns if also
# changing means.
rows <- c(2, 15, 53, 59, 65, 71, 77, 83, 109, 116, 117)

for(c in c(1:3, 5:6)){
  for(i in rows){
    value <- as.character(round(as.numeric(gsub(" \\[\\d+.\\d, \\d+.\\d\\]", "", table1_final[i, c])), digits = 0))
    q1 <- as.character(round(as.numeric(gsub(", \\d+.\\d\\]", "", gsub("\\d+.\\d \\[", "", table1_final[i, c]))), digits = 0))
    q3 <- as.character(round(as.numeric(gsub("\\]", "", gsub("\\d+.\\d \\[\\d+.\\d, ", "", table1_final[i, c]))), digits = 0))
    table1_final[i, c] <- paste(value, " [", q1, ", ", q3, "]", sep = "")
  }
}

kable(table1_final, caption = "Baseline characteristics before and after weighting")

rm(i, c, table_rownumbers, rows)

```


### 1.4.4. Weighted Kaplan Meier curves
```{r include = FALSE}
# Taken from KMunicate source code
# Edouard Fu modified this code (and I modified it some more):
# 1. Legend position: Left upper corner instead of right upper corner if reverse is true
# 2. Legend headings: not 0/1 but Continued/Stopped RASi
# 3. The risk table shows unweighted numbers, but the plot itself is weighted. For this I introduced both fit and fit2 (KMunicate only 
#    specified fit)
# 4. Add specifiable plot title in bold and increase distance to plot
# 5. Removed censored and event rows to only display risk rows
# Removed some annotation to clean up the code, for annotation: https://github.com/ellessenne/KMunicate-package/blob/master/R/KMunicate.R

#' @keywords internal
.fortify <- function(fit) {
  fit <- survival::survfit0(x = fit)
  out <- data.frame(
    time = fit$time,
    n.risk = fit$n.risk,
    n.event = fit$n.event,
    n.censor = fit$n.censor,
    surv = fit$surv,
    lower = fit$lower,
    upper = fit$upper
  )
  if ("strata" %in% names(fit)) {
    out$strata <- rep(names(fit$strata), times = as.numeric(fit$strata))
    out$strata <- factor(out$strata, levels = names(fit$strata), labels = gsub(".*=", "", names(fit$strata)))
  }
  return(out)
}

#' @keywords internal
.fortify_summary <- function(fit2, time_scale, risk_table) {
  summ <- summary(fit2, times = time_scale, extend = TRUE)
  
  d <- data.frame(
    time = summ$time,
    n.risk = summ$n.risk,
    n.event = summ$n.event,
    n.censor = summ$n.censor
  )
  if ("strata" %in% names(fit2)) {
    d$strata <- summ$strata
    d$strata <- factor(d$strata, levels = levels(d$strata), labels = gsub(".*=", "", levels(d$strata)))
  }
  # Use cumulative n.event and n.censor if risk_table == "KMunicate"
  if (risk_table == "KMunicate") {
    if ("strata" %in% names(fit2)) {
      dsplit <- split(x = d, f = d$strata)
    } else {
      dsplit <- list(d)
    }
    dsplit <- lapply(dsplit, function(x) {
      x$n.event <- cumsum(x$n.event)
      x$n.censor <- cumsum(x$n.censor)
      # Solve (for now) inconsistency between n.risk and the rest
      # Trusting n.censor and n.event for now...
      # See (and follow-up) over at:
      # - https://github.com/ellessenne/KMunicate-package/issues/6
      # - https://github.com/therneau/survival/issues/119
      x$n.risk <- max(x$n.risk) - x$n.censor - x$n.event
      x
    })
    d <- do.call(rbind, dsplit)
  }
  
  # Return d
  return(d)
}

KMunicate <- function(fit, fit2, time_scale, .risk_table = "KMunicate", .reverse = FALSE, .theme = NULL, 
                      .color_scale = 
                      scale_color_manual(values = c(rgb(0, 101, 172, maxColorValue = 255), rgb(243, 110, 53, maxColorValue = 255))), 
                      .fill_scale = 
                      scale_fill_manual(values = c(rgb(0, 101, 172, maxColorValue = 255), rgb(243, 110, 53, maxColorValue = 255))),
                      .linetype_scale = NULL, .annotate = NULL, .xlab = "Time", 
                      .ylab = ifelse(.reverse, "Estimated (1 - survival)", "Estimated survival"), .alpha = 0.25, 
                      .rel_heights = NULL, .ff = NULL, .risk_table_base_size = 11, .size = NULL, .legend_position = c(0, 1), title,
                      .ylim, .breaks = 0.25, .zoom = NULL, .xmin_zoom = NULL, .xmax_zoom = NULL, .ymin_zoom = NULL, .ymax_zoom = NULL,
                      .breaks_zoom = 0.05){
  
  ### Check arguments
  arg_checks <- checkmate::makeAssertCollection()
  # 'fit' must be of class 'survfit'
  checkmate::assert_class(x = fit, classes = "survfit", add = arg_checks)
  # 'time_scale' must be a numeric vector
  checkmate::assert_numeric(x = time_scale, add = arg_checks)
  # '.reverse' must be a logical value
  checkmate::assert_logical(x = .reverse, len = 1, add = arg_checks)
  # '.risk_table' must be a vector of strings, can be NULL
  checkmate::assert_string(x = .risk_table, null.ok = TRUE, add = arg_checks)
  # '.risk_table' must have specific values
  if (!is.null(.risk_table)) {
    .risk_table <- match.arg(.risk_table, choices = c("KMunicate", "survfit", NULL))
    checkmate::assert_true(x = .risk_table %in% c("KMunicate", "survfit"), add = arg_checks)
  }
  # '.theme' must be of class 'theme', 'gg' and must pass ggplot2::is.ggtheme()
  checkmate::assert_class(x = .theme, classes = c("theme", "gg"), null.ok = TRUE, add = arg_checks)
  if (!is.null(.theme)) checkmate::assert_true(x = ggplot2::is.theme(.theme), add = arg_checks)
  # '.color_scale', '.fill_scale', '.linetype_scale', '.annotate' must pass ggplot2::is.ggproto()
  if (!is.null(.color_scale)) checkmate::assert_true(x = ggplot2::is.ggproto(.color_scale), add = arg_checks)
  if (!is.null(.fill_scale)) checkmate::assert_true(x = ggplot2::is.ggproto(.fill_scale), add = arg_checks)
  if (!is.null(.linetype_scale)) checkmate::assert_true(x = ggplot2::is.ggproto(.linetype_scale), add = arg_checks)
  if (!is.null(.annotate)) checkmate::assert_true(x = ggplot2::is.ggproto(.annotate), add = arg_checks)
  # '.xlab', '.ylab' must be a string
  checkmate::assert_string(x = .xlab, add = arg_checks)
  checkmate::assert_string(x = .ylab, add = arg_checks)
  # '.alpha' must be a number
  checkmate::assert_number(x = .alpha, add = arg_checks)
  # '.rel_heights' must be a numeric vector or NULL
  checkmate::assert_numeric(x = .rel_heights, null.ok = TRUE, add = arg_checks)
  # '.ff' must be a string or NULL
  checkmate::assert_string(x = .ff, null.ok = TRUE, add = arg_checks)
  # '.risk_table_base_size', '.size' must be a number
  checkmate::assert_number(x = .risk_table_base_size, add = arg_checks)
  checkmate::assert_number(x = .size, null.ok = TRUE, add = arg_checks)
  # '.legend_position' must be a numeric vector of length 2, or a single string "none"
  checkmate::assert_true(x = (is.numeric(.legend_position) & length(.legend_position) == 2) | (is.character(.legend_position) & 
                                                             length(.legend_position) == 1), add = arg_checks)
  # Report
  if (!arg_checks$isEmpty()) checkmate::reportAssertions(arg_checks)
  
  ### Fortify data
  data <- .fortify(fit) %>% mutate(strata = ifelse(strata == 0, "Continued RASi", "Stopped RASi"))
  # If .reverse, use 1 - survival probability
  if(.reverse){
    data$surv <- 1 - data$surv
    data$lower <- 1 - data$lower
    data$upper <- 1 - data$upper
  }
  
  ### Create plot
  ## Main plot
  plot <- ggplot2::ggplot(data, ggplot2::aes(x = time, y = surv, ymin = lower, ymax = upper)) + labs(title = title) + 
    theme(plot.title = element_text(margin = margin(0, 0, 10, 0), face="bold", size = 12, hjust = 0.5))

  if ("strata" %in% names(fit)) {
    plot <- plot + pammtools::geom_stepribbon(ggplot2::aes(fill = strata), alpha = .alpha)
    if (!is.null(.size)) {
      plot <- plot +
        ggplot2::geom_step(ggplot2::aes(color = strata, linetype = strata), size = .size)
    } else {
      plot <- plot +
        ggplot2::geom_step(ggplot2::aes(color = strata, linetype = strata))
    }
  } else {
    if (!is.null(.size)) {
      plot <- plot + pammtools::geom_stepribbon(alpha = .alpha, size = .size)
    } else {
      plot <- plot + pammtools::geom_stepribbon(alpha = .alpha)
    }
    plot <- plot +
      ggplot2::geom_step()
  }
  plot <- plot +
    ggplot2::scale_x_continuous(breaks = time_scale) +
    ggplot2::scale_y_continuous(breaks = seq(0, 1, by = .breaks)) + 
    ggplot2::coord_cartesian(ylim = c(0, 1), xlim = range(time_scale)) +
    ggplot2::labs(color = "", fill = "", linetype = "", x = .xlab, y = .ylab)
  if (!is.null(.theme)) {
    plot <- plot + .theme
  } else if (!is.null(.ff)) {
    plot <- plot + ggplot2::theme_gray(base_family = .ff)
  }
  plot <- plot +
    ggplot2::theme(legend.position = .legend_position, legend.background = ggplot2::element_blank(), legend.key = ggplot2::element_blank(), 
                   plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm")) 
  if (length(.legend_position) > 1) {
    plot <- plot +
      ggplot2::theme(legend.justification = .legend_position)
  }
  if (!is.null(.color_scale)) {
    plot <- plot + .color_scale
  }
  if (!is.null(.fill_scale)) {
    plot <- plot + .fill_scale
  }
  if (!is.null(.linetype_scale)) {
    plot <- plot + .linetype_scale
  }
  if (!is.null(.annotate)) {
    plot <- plot + .annotate
  }
  
  ## Zoom plot
  zoom <- ggplot2::ggplot(data, ggplot2::aes(x = time, y = surv, ymin = lower, ymax = upper))

  if ("strata" %in% names(fit)) {
    zoom <- zoom + pammtools::geom_stepribbon(ggplot2::aes(fill = strata), alpha = .alpha)
    if (!is.null(.size)) {
      zoom <- zoom +
        ggplot2::geom_step(ggplot2::aes(color = strata, linetype = strata), size = .size)
    } else {
      zoom <- zoom +
        ggplot2::geom_step(ggplot2::aes(color = strata, linetype = strata))
    }
  } else {
    if (!is.null(.size)) {
      zoom <- zoom + pammtools::geom_stepribbon(alpha = .alpha, size = .size)
    } else {
      zoom <- zoom + pammtools::geom_stepribbon(alpha = .alpha)
    }
    zoom <- zoom +
      ggplot2::geom_step()
  }
  zoom <- zoom +
    ggplot2::scale_x_continuous(breaks = time_scale) +
    ggplot2::scale_y_continuous(breaks = seq(.ylim[[1]], .ylim[[2]], by = .breaks_zoom)) +
    ggplot2::coord_cartesian(ylim = .ylim, xlim = range(time_scale)) +
    ggplot2::labs(color = "", fill = "", linetype = "", x = "", y = "")
  if (!is.null(.theme)) {
    zoom <- zoom + .theme
  } else if (!is.null(.ff)) {
    zoom <- zoom + ggplot2::theme_gray(base_family = .ff)
  }
  zoom <- zoom +
    ggplot2::theme(legend.position = c(-2, -2), legend.background = ggplot2::element_blank(), legend.key = ggplot2::element_blank(), 
                   plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm")) 
  if (length(.legend_position) > 1) {
    zoom <- zoom +
      ggplot2::theme(legend.justification = .legend_position)
  }
  if (!is.null(.color_scale)) {
    zoom <- zoom + .color_scale
  }
  if (!is.null(.fill_scale)) {
    zoom <- zoom + .fill_scale
  }
  if (!is.null(.linetype_scale)) {
    zoom <- zoom + .linetype_scale
  }
  if (!is.null(.annotate)) {
    zoom <- zoom + .annotate
  }
  
  ### Add plots together if requested
  if (!is.null(.zoom)){
    
  plot <- plot + annotation_custom(grob = ggplotGrob(zoom), xmin = .xmin_zoom, xmax = .xmax_zoom, ymin = .ymin_zoom, ymax = .ymax_zoom)
  
  }
  
  # Create tables if requested
  if (!is.null(.risk_table)) {
    ### Create tables
    table_data <- .fortify_summary(fit2 = fit2, time_scale = time_scale, risk_table = .risk_table) %>%
      dplyr::select(-n.event, -n.censor) %>% arrange(time, strata) %>% relocate(strata, .before = n.risk)
    table_data$strata <- factor(table_data$strata, levels = c(1, 0), labels = c("Stopped RASi   ", "Continued RASi   "))
    
    ### Create table 'plots'
    if (!("strata" %in% names(fit2))) {
      table_data$strata <- "Overall"
    }
    tds <- list(table_data)
    tds <- lapply(seq_along(tds), function(i) {
      p <- ggplot2::ggplot(tds[[i]], ggplot2::aes(x = time, y = strata, label = n.risk))
      if (is.null(.ff)) {
        p <- p + ggplot2::geom_text(size = .risk_table_base_size / 3)
      } else {
        p <- p + ggplot2::geom_text(mapping = ggplot2::aes(family = .ff), size = .risk_table_base_size / 3)
      }
      p <- p +
        ggplot2::scale_x_continuous(breaks = time_scale) +
        ggplot2::coord_cartesian(xlim = range(time_scale)) +
        ggplot2::theme_void(base_size = .risk_table_base_size) +
        ggplot2::theme(plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"))
      if (is.null(.ff)) {
        p <- p + ggplot2::theme(axis.text.y = ggplot2::element_text(face = "plain"),
                                plot.title = ggplot2::element_text(face = "bold"))
      } else {
        p <- p + ggplot2::theme(axis.text.y = ggplot2::element_text(face = "plain", family = .ff), plot.title = 
                 ggplot2::element_text(family = .ff, face = "bold"))
      }
      p <- p +
        ggplot2::labs(title = "At risk")
    })
    
    ### Process relative heights
    if (is.null(.rel_heights)) {
      .rel_heights <- c(3, rep(1, length(tds)))
    }
    
    ### Combine plot and tables
    KMunicate_plot <- cowplot::plot_grid(plotlist = c(list(plot), tds), align = "hv", axis = "tlbr", ncol = 1, rel_heights = .rel_heights)
  } else {
    KMunicate_plot <- plot
  }
  
  ### Return
  return(KMunicate_plot)
}

# Theme function
theme_min <- function(){
    theme(panel.background = element_blank(),
          axis.line.x.bottom = element_line(colour = "black", size = 0.5),
          axis.line.y.left = element_line(colour = "black", size = 0.5),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())
}

# Plotting function
# .zoom_mar function is order of xmin, xmax, ymin, ymax
km_plots <- function(time2event, event, stopping, weights, ylab, title, file,
                     .breaks = 0.25, .zoom = NULL, .ylim = c(0, 0), .zoom_mar = c(0, 0, 0, 0), .breaks_zoom){
  time_scale <- seq(0, max(time2event/365.25), by = 1)
  km_before_weighting <- survfit(Surv((time2event/365.25), event) ~ stopping) 
  km_after_weighting <- survfit(Surv((time2event/365.25), event) ~ stopping, weights = weights)

  KMunicate(fit = km_after_weighting, fit2 = km_before_weighting, time_scale = time_scale, .risk_table = "survfit", 
            .ylab = ylab, .xlab = "Time (years)", .theme = theme_min(), title =  title, 
            .legend_position = c(0, 1.1), .risk_table_base_size = 9, .reverse = TRUE, .breaks = .breaks, .zoom = .zoom,
            .ylim = .ylim, .xmin_zoom = .zoom_mar[[1]], .xmax_zoom = .zoom_mar[[2]], .ymin_zoom = .zoom_mar[[3]], 
            .ymax_zoom = .zoom_mar[[4]], .breaks_zoom = .breaks_zoom)
  
  setwd("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Figures/Workable Figures")

  ggsave(file, width = 5, height = 5, dpi = 600)
}

# Start creating plots
# Composite outcome
# To change file type, change extension in the file name (e.g., .pdf to .jpeg), DPI can be changed in the function above.
km_plots(cohort1$time2comp, cohort1$event_comp, cohort1$stopping, cohort1$ow, "Absolute risk of death or MACE", 
         "A. Composite of mortality and MACE",
         "km_comp.pdf", .breaks = 0.2)

# Mortality
km_plots(cohort1$time2death, cohort1$event_mort, cohort1$stopping, cohort1$ow, "Absolute risk of death", "A. Mortality",
         "km_mortality.pdf", .breaks = 0.2)

# Recurrent AKI
km_plots(cohort1$time2aki, cohort1$event_aki, cohort1$stopping, cohort1$ow, "Absolute risk of recurrent AKI", "B. Recurrent AKI",
         "km_aki.pdf", .breaks = 0.2, .zoom = TRUE, .ylim = c(0, 0.25), .zoom_mar = c(1.3, 5, 0.25, 1), .breaks_zoom = 0.05)

# Heart failure
km_plots(cohort1$time2hf, cohort1$event_hf, cohort1$stopping, cohort1$ow, "Absolute risk of heart failure hospitalization", 
         "A. Heart failure hospitalization", "km_hf.pdf", .breaks = 0.2)

# End-stage kidney disease
km_plots(cohort1_lab$time2eskd, cohort1_lab$event_eskd, cohort1_lab$stopping, cohort1_lab$ow, "Absolute risk of ESKD", "D. ESKD",
         "km_eskd.pdf", .breaks = 0.2, .zoom = TRUE, .ylim = c(0, 0.15), .zoom_mar = c(1.3, 5, 0.25, 1), .breaks_zoom = 0.05)

# CKD progression
km_plots(cohort1_lab$time2ckd, cohort1_lab$event_ckd, cohort1_lab$stopping, cohort1_lab$ow, "Absolute risk of CKD progression", 
         "B. CKD progression", "km_ckd.pdf", .breaks = 0.2, .zoom = TRUE, .ylim = c(0, 0.35), .zoom_mar = c(1.3, 5, 0.35, 1), 
         .breaks_zoom = 0.05)

# Moderate hyperkalemia
km_plots(cohort1_lab$time2hk_moderate, cohort1_lab$event_hk_moderate, cohort1_lab$stopping, cohort1_lab$ow, 
         "Absolute risk of hyperkalemia", "C. Moderate hyperkalemia", "km_hkmod.pdf", .breaks = 0.2)

# MACE 
km_plots(cohort1$time2mace, cohort1$event_mace, cohort1$stopping, cohort1$ow, "Absolute risk of MACE", "G. MACE",
         "km_mace.pdf", .breaks = 0.2, .zoom = TRUE, .ylim = c(0, 0.25), .zoom_mar = c(1.3, 5, 0.25, 1), .breaks_zoom = 0.05)

``` 


### 1.4.5. Adjusted Cox regression model using overlap weighting adjustment
```{r}
# Weighted Cox models using OW
# Function for model
coxweighted <- function(event, time2event, cohort_stopping, cohort_weight){
  cox_weighted <- coxph(Surv(time2event, event) ~ as.factor(cohort_stopping), weights = cohort_weight, robust = TRUE)

   # This code is just used to put the hazard ratios and confidence intervals in a table
  table_weighted <- format(round(cbind(summary(cox_weighted)$coef, exp(confint(cox_weighted))), 2), nsmall = 2) %>% 
    as.data.frame() %>% filter(row_number() == 1) 
  table_weighted <- table_weighted[, c(2, 7:8)] 
  colnames(table_weighted) <- c("HR","lower","upper") 
  
  table_weighted <- as.data.frame(table_weighted) %>% mutate(HR = gsub(pattern = " ", replacement = "", x = HR),
                                                             lHR = nchar(HR),
                                                             HR = ifelse(lHR == 1 | lHR == 2, paste(HR, ".0", sep = ""), HR),
                                                             lower = gsub(pattern = " ", replacement = "", x = lower),
                                                             llower = nchar(lower),
                                                             lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                                             upper = gsub(pattern = " ", replacement = "", x = upper),
                                                             lupper = nchar(upper),
                                                             upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                                             HR = paste(HR, " (", lower, "-", upper,")", sep = ""))  
  table_weighted <- as.data.frame(table_weighted[, 1]) 
  colnames(table_weighted) <- "Overlap Weights Adjusted HR (95% CI)"
  
  table_weighted <- rbind("", "", "1 (Reference)", table_weighted)
  
  return(table_weighted)
}

# Outcomes with overlap weights
cox_weighted_comp <- coxweighted(cohort1$event_comp, cohort1$time2comp, cohort1$stopping, cohort1$ow)
cox_weighted_death <- coxweighted(cohort1$event_mort, cohort1$time2death, cohort1$stopping, cohort1$ow)
cox_weighted_aki <- coxweighted(cohort1$event_aki, cohort1$time2aki, cohort1$stopping, cohort1$ow)
cox_weighted_hf <- coxweighted(cohort1$event_hf, cohort1$time2hf, cohort1$stopping, cohort1$ow)
cox_weighted_eskd <- coxweighted(cohort1_lab$event_eskd, cohort1_lab$time2eskd, cohort1_lab$stopping, cohort1_lab$ow)
cox_weighted_ckd <- coxweighted(cohort1_lab$event_ckd, cohort1_lab$time2ckd, cohort1_lab$stopping, cohort1_lab$ow)
cox_weighted_hkmod <- coxweighted(cohort1_lab$event_hk_moderate, cohort1_lab$time2hk_moderate, cohort1_lab$stopping, cohort1_lab$ow)
cox_weighted_mace <- coxweighted(cohort1$event_mace, cohort1$time2mace, cohort1$stopping, cohort1$ow)
cox_weighted_ow <- rbind(cox_weighted_comp, cox_weighted_death, cox_weighted_aki, cox_weighted_hf, cox_weighted_eskd, 
                         cox_weighted_ckd, cox_weighted_hkmod, cox_weighted_mace)

# Doubly robust estimates
# Function for model in normal cohort
coxweighted_dr_normal <- function(event, time2event, cohort_stopping, cohort_weight){
  cox_weighted <- coxph(Surv(time2event, event) ~ as.factor(cohort_stopping) +
                            cohort1$age + cohort1$age_cat + cohort1$female + cohort1$educ_cat + cohort1$adm_egfr + cohort1$adm_egfr_cat + 
                            cohort1$comorb_dm + cohort1$comorb_ht + cohort1$comorb_mi + cohort1$comorb_arr + cohort1$comorb_cd + 
                            cohort1$comorb_pvd + cohort1$comorb_ihd + cohort1$comorb_copd + cohort1$comorb_ca + cohort1$comorb_ld + 
                            cohort1$comorb_chf + cohort1$comorb_dl + cohort1$comorb_hyth +  cohort1$comorb_eh + cohort1$comorb_vhd + 
                            cohort1$med_bb + cohort1$med_ccb + cohort1$med_ld + cohort1$med_td + cohort1$med_pd + cohort1$med_nsaid + 
                            cohort1$med_al + cohort1$med_ab + cohort1$med_nt + cohort1$med_ara + cohort1$med_hl + cohort1$med_aa + 
                            cohort1$med_dx + cohort1$med_ac + cohort1$med_dm + cohort1$med_op + cohort1$kontakt_all + cohort1$kontakt_cv + 
                            cohort1$slv_all + cohort1$slv_cv + cohort1$ovr_all + cohort1$ovr_cv + cohort1$kontakt_all_cat + 
                            cohort1$kontakt_cv_cat + cohort1$slv_all_cat + cohort1$slv_cv_cat + cohort1$ovr_all_cat + cohort1$ovr_cv_cat + 
                            cohort1$hosp_cv + cohort1$hosp_rs + cohort1$hosp_gi + cohort1$hosp_id + cohort1$hosp_ca + cohort1$hosp_op + 
                            cohort1$hosp_hm + cohort1$hosp_gu + cohort1$hosp_ip + cohort1$hosp_ns + cohort1$hosp_hk + cohort1$hosp_od + 
                            cohort1$pc_sp + cohort1$pc_cs + cohort1$pc_cc + cohort1$pc_ar + cohort1$pc_pn + cohort1$pc_lf + cohort1$pc_mi + 
                            cohort1$pc_ns + cohort1$dur + cohort1$AKI_acoa + cohort1$crit_type + cohort1$AcutDial + cohort1$creat_mean + 
                            cohort1$creat_peak, weights = cohort_weight, robust = TRUE)

   # This code is just used to put the hazard ratios and confidence intervals in a table
  table_weighted <- format(round(cbind(summary(cox_weighted)$coef, exp(confint(cox_weighted))), 2), nsmall = 2) %>% 
    as.data.frame() %>% filter(row_number() == 1) 
  table_weighted <- table_weighted[, c(2, 7:8)] 
  colnames(table_weighted) <- c("HR","lower","upper") 
  
  table_weighted <- as.data.frame(table_weighted) %>% mutate(HR = gsub(pattern = " ", replacement = "", x = HR),
                                                             lHR = nchar(HR),
                                                             HR = ifelse(lHR == 1 | lHR == 2, paste(HR, ".0", sep = ""), HR),
                                                             lower = gsub(pattern = " ", replacement = "", x = lower),
                                                             llower = nchar(lower),
                                                             lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                                             upper = gsub(pattern = " ", replacement = "", x = upper),
                                                             lupper = nchar(upper),
                                                             upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                                             HR = paste(HR, " (", lower, "-", upper,")", sep = ""))  
  table_weighted <- as.data.frame(table_weighted[, 1]) 
  colnames(table_weighted) <- "Doubly Robust Adjusted HR (95% CI)"
  
  table_weighted <- rbind("", "", "1 (Reference)", table_weighted)
  
  return(table_weighted)
}

coxweighted_dr_lab <- function(event, time2event, cohort_stopping, cohort_weight){
  cox_weighted <- coxph(Surv(time2event, event) ~ as.factor(cohort_stopping) +
                            cohort1_lab$age + cohort1_lab$age_cat + cohort1_lab$female + cohort1_lab$educ_cat + cohort1_lab$adm_egfr + 
                            cohort1_lab$adm_egfr_cat + cohort1_lab$comorb_dm + cohort1_lab$comorb_ht + cohort1_lab$comorb_mi + 
                            cohort1_lab$comorb_arr + cohort1_lab$comorb_cd + cohort1_lab$comorb_pvd + cohort1_lab$comorb_ihd + 
                            cohort1_lab$comorb_copd + cohort1_lab$comorb_ca + cohort1_lab$comorb_ld + cohort1_lab$comorb_chf + 
                            cohort1_lab$comorb_dl + cohort1_lab$comorb_hyth +  cohort1_lab$comorb_eh + cohort1_lab$comorb_vhd + 
                            cohort1_lab$med_bb + cohort1_lab$med_ccb + cohort1_lab$med_ld + cohort1_lab$med_td + cohort1_lab$med_pd + 
                            cohort1_lab$med_nsaid + cohort1_lab$med_al + cohort1_lab$med_ab + cohort1_lab$med_nt + cohort1_lab$med_ara + 
                            cohort1_lab$med_hl + cohort1_lab$med_aa + cohort1_lab$med_dx + cohort1_lab$med_ac + cohort1_lab$med_dm + 
                            cohort1_lab$med_op + cohort1_lab$kontakt_all + cohort1_lab$kontakt_cv + cohort1_lab$slv_all + 
                            cohort1_lab$slv_cv + cohort1_lab$ovr_all + cohort1_lab$ovr_cv + cohort1_lab$kontakt_all_cat + 
                            cohort1_lab$kontakt_cv_cat + cohort1_lab$slv_all_cat + cohort1_lab$slv_cv_cat + cohort1_lab$ovr_all_cat + 
                            cohort1_lab$ovr_cv_cat + cohort1_lab$hosp_cv + cohort1_lab$hosp_rs + cohort1_lab$hosp_gi + cohort1_lab$hosp_id +
                            cohort1_lab$hosp_ca + cohort1_lab$hosp_op + cohort1_lab$hosp_hm + cohort1_lab$hosp_gu + cohort1_lab$hosp_ip + 
                            cohort1_lab$hosp_ns + cohort1_lab$hosp_hk + cohort1_lab$hosp_od + cohort1_lab$pc_sp + cohort1_lab$pc_cs + 
                            cohort1_lab$pc_cc + cohort1_lab$pc_ar + cohort1_lab$pc_pn + cohort1_lab$pc_lf + cohort1_lab$pc_mi +  
                            cohort1_lab$pc_ns + cohort1_lab$dur + cohort1_lab$AKI_acoa + cohort1_lab$crit_type + cohort1_lab$AcutDial + 
                            cohort1_lab$creat_mean + cohort1_lab$creat_peak, weights = cohort_weight, robust = TRUE)

   # This code is just used to put the hazard ratios and confidence intervals in a table
  table_weighted <- format(round(cbind(summary(cox_weighted)$coef, exp(confint(cox_weighted))), 2), nsmall = 2) %>% 
    as.data.frame() %>% filter(row_number() == 1) 
  table_weighted <- table_weighted[, c(2, 7:8)] 
  colnames(table_weighted) <- c("HR","lower","upper") 
  
  table_weighted <- as.data.frame(table_weighted) %>% mutate(HR = gsub(pattern = " ", replacement = "", x = HR),
                                                             lHR = nchar(HR),
                                                             HR = ifelse(lHR == 1 | lHR == 2, paste(HR, ".0", sep = ""), HR),
                                                             lower = gsub(pattern = " ", replacement = "", x = lower),
                                                             llower = nchar(lower),
                                                             lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                                             upper = gsub(pattern = " ", replacement = "", x = upper),
                                                             lupper = nchar(upper),
                                                             upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                                             HR = paste(HR, " (", lower, "-", upper,")", sep = ""))  
  table_weighted <- as.data.frame(table_weighted[, 1]) 
  colnames(table_weighted) <- "Doubly Robust Adjusted HR (95% CI)"
  
  table_weighted <- rbind("", "", "1 (Reference)", table_weighted)
  
  return(table_weighted)
}

# These give loglik warnings, but the author mentioned these are overly sensitive. I checked the coefficients for the composite outcome
# which were fine. https://stackoverflow.com/questions/19369314/r-coxph-warning-loglik-converged-before-variable 
cox_weighted_dr_comp <- coxweighted_dr_normal(cohort1$event_comp, cohort1$time2comp, cohort1$stopping, cohort1$ow)
cox_weighted_dr_death <- coxweighted_dr_normal(cohort1$event_mort, cohort1$time2death, cohort1$stopping, cohort1$ow)
cox_weighted_dr_aki <- coxweighted_dr_normal(cohort1$event_aki, cohort1$time2aki, cohort1$stopping, cohort1$ow)
cox_weighted_dr_hf <- coxweighted_dr_normal(cohort1$event_hf, cohort1$time2hf, cohort1$stopping, cohort1$ow)
cox_weighted_dr_eskd <- coxweighted_dr_lab(cohort1_lab$event_eskd, cohort1_lab$time2eskd, cohort1_lab$stopping, cohort1_lab$ow)
cox_weighted_dr_ckd <- coxweighted_dr_lab(cohort1_lab$event_ckd, cohort1_lab$time2ckd, cohort1_lab$stopping, cohort1_lab$ow)
cox_weighted_dr_hkmod <- coxweighted_dr_lab(cohort1_lab$event_hk_moderate, cohort1_lab$time2hk_moderate, cohort1_lab$stopping, 
                                            cohort1_lab$ow)
cox_weighted_dr_mace <- coxweighted_dr_normal(cohort1$event_mace, cohort1$time2mace, cohort1$stopping, cohort1$ow)
cox_weighted_dr_ow <- rbind(cox_weighted_dr_comp, cox_weighted_dr_death, cox_weighted_dr_aki, cox_weighted_dr_hf, cox_weighted_dr_eskd, 
                         cox_weighted_dr_ckd, cox_weighted_dr_hkmod, cox_weighted_dr_mace)

table2 <- cbind(incidence_table, cox_table_unadjusted, cox_weighted_ow, cox_weighted_dr_ow)

kable(table2)

rm(cox_weighted_death, cox_weighted_aki, cox_weighted_hf, cox_weighted_eskd, cox_weighted_ckd, cox_weighted_hkmod,
   cox_weighted_mace, cox_weighted_comp, cox_weighted_dr_comp, cox_weighted_dr_death, cox_weighted_dr_aki,
   cox_weighted_dr_hf, cox_weighted_dr_eskd, cox_weighted_dr_ckd, cox_weighted_dr_hkmod, cox_weighted_dr_mace, cox_weighted_dr_ow)

### Results per component of the primary outcome
cox_weighted_comp_death <- coxweighted(cohort1$event_comp_death, cohort1$time2comp_death, cohort1$stopping, cohort1$ow)
cox_weighted_comp_mi <- coxweighted(cohort1$event_comp_mi, cohort1$time2comp_mi, cohort1$stopping, cohort1$ow)
cox_weighted_comp_stroke <- coxweighted(cohort1$event_comp_stroke, cohort1$time2comp_stroke, cohort1$stopping, cohort1$ow)
cox_weighted_comp_outcomes <- rbind(cox_weighted_comp_death, cox_weighted_comp_mi, cox_weighted_comp_stroke)

table2_component_outcomes <- cbind(incidence_table_components, cox_table_unadjusted_comp, cox_weighted_comp_outcomes)

kable(table2_component_outcomes)

```

### 1.4.6. Absolute risks
```{r}
absolute_risks <- function(formula_surv, df, name){
  surv_info <- survfit(as.formula(formula_surv), weights = ow, robust = TRUE, data = df)
  
  # Surv contains absolute risks, std.err contains standard errors. Strata are put below one another.
  surv <- as.data.frame(surv_info$surv)
  std.err <- as.data.frame(surv_info$std.err)

  row0 <- as.numeric(surv_info$strata[[1]])
  row1 <- as.numeric(length(surv$`surv_info$surv`))

  surv0 <- surv[[row0, 1]]
  surv1 <- surv[[row1, 1]]
  se0 <- std.err[[row0, 1]]
  se1 <- std.err[[row1, 1]]

  # Absolute risk & 95% CI continuing at 5 years
  ar0 <- (1 - surv0) * 100
  ll0 <- ((1 - surv0) - (1.96 * se0)) * 100
  ul0 <- ((1 - surv0) + (1.96 * se0)) * 100

  # Absolute risk & 95% CI stopping at 5 years
  ar1 <- (1 - surv1) * 100
  ll1 <- ((1 - surv1) - (1.96 * se1)) * 100
  ul1 <- ((1 - surv1) + (1.96 * se1)) * 100

  # Absolute risk difference at 5 years
  ard <- ((1 - surv1) - (1 - surv0)) * 100
  lld <- (((1 - surv1) - (1 - surv0)) - sqrt((se1 ^ 2) + (se0 ^ 2))) * 100
  uld <- (((1 - surv1) - (1 - surv0)) + sqrt((se1 ^ 2) + (se0 ^ 2))) * 100

  ar <- matrix(0, ncol = 3, nrow = 3)
  colnames(ar) <- c("risk", "lower", "upper")
  rownames(ar) <- c("Continuers", "Stoppers", "Difference")

  ar[[1, 1]] <- round(ar0, digits = 1)
  ar[[1, 2]] <- round(ll0, digits = 1)
  ar[[1, 3]] <- round(ul0, digits = 1)
  ar[[2, 1]] <- round(ar1, digits = 1)
  ar[[2, 2]] <- round(ll1, digits = 1)
  ar[[2, 3]] <- round(ul1, digits = 1)
  ar[[3, 1]] <- round(ard, digits = 1)
  ar[[3, 2]] <- round(lld, digits = 1)
  ar[[3, 3]] <- round(uld, digits = 1)
  
  ar <- as.data.frame(ar) %>% mutate(lrisk = nchar(risk),
                                     risk = ifelse(lrisk == 1 | lrisk == 2, paste(risk, ".0", sep = ""), risk),
                                     llower = nchar(lower),
                                     lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                     lupper = nchar(upper),
                                     upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                     ar_c = paste(as.character(risk), " (", as.character(lower), ", ", as.character(upper), ")", sep = ""))
  ar <- dplyr::select(ar, ar_c)
  colnames(ar) <- name
  
  return(as.data.frame(ar))
}

ar_comp <- absolute_risks(Surv(time2comp, event_comp) ~ as.factor(stopping), df = cohort1, "Composite of death and MACE")
ar_mort <- absolute_risks(Surv(time2death, event_mort) ~ as.factor(stopping), df = cohort1, "Mortality")
ar_aki <- absolute_risks(Surv(time2aki, event_aki) ~ as.factor(stopping), df = cohort1, "Recurrent AKI")
ar_hf <- absolute_risks(Surv(time2hf, event_hf) ~ as.factor(stopping), df = cohort1, "Heart failure")
ar_eskd <- absolute_risks(Surv(time2eskd, event_eskd) ~ as.factor(stopping), df = cohort1_lab, "End-stage kidney disease")
ar_ckd <- absolute_risks(Surv(time2ckd, event_ckd) ~ as.factor(stopping), df = cohort1_lab, "CKD progression")
ar_hkmod <- absolute_risks(Surv(time2hk_moderate, event_hk_moderate) ~ as.factor(stopping), df = cohort1_lab, "Moderate hyperkalemia")
ar_mace <- absolute_risks(Surv(time2mace, event_mace) ~ as.factor(stopping), df = cohort1, "MACE")

ar_table <- cbind(ar_comp, ar_mort, ar_aki, ar_hf, ar_eskd, ar_ckd, ar_hkmod, ar_mace)

kable(ar_table, caption = "Absolute risks (95% CI) and absolute risk difference (95% CI) over 5 years")

### Components of primary outcome
ar_comp_death <- absolute_risks(Surv(time2comp_death, event_comp_death) ~ as.factor(stopping), df = cohort1, "Comp death")
ar_comp_mi <- absolute_risks(Surv(time2comp_mi, event_comp_mi) ~ as.factor(stopping), df = cohort1, "Comp mi")
ar_comp_stroke <- absolute_risks(Surv(time2comp_stroke, event_comp_stroke) ~ as.factor(stopping), df = cohort1, "Comp stroke")
ar_table_comp <- cbind(ar_comp_death, ar_comp_mi, ar_comp_stroke)
kable(ar_table_comp)

```


## 1.5. Subgroup analyses
```{r}
# Subgroups:
# Creating subgroup indicators:
# Age >= 65 years: sg_age65
# Heart failure present: sg_hf
# Ischemic heart disease present: sg_ihd
# None to light CKD: sg_g1_2
# Moderate to advanced CKD: sg_g2_3
# Diabetes present: sg_dm

# Function for subgroup analyses
subgroup_hr_weighting <- function(df, sg, weighting_formula, formula_coxph, surv_formula, sg_name, ph1 = NULL, ph2 = NULL){
  ph1 <- ifelse(is.null(ph1), "Yes", ph1)
  ph2 <- ifelse(is.null(ph2), "No", ph2)
  
  hr_b <- matrix(0, nrow = 2, ncol = 1) 
  hr_se <- matrix(0, nrow = 2, ncol = 1)
  N <- matrix(0, nrow = 2, ncol = 1)
  events <- matrix(0, nrow = 2, ncol = 1)
  rate <- matrix(0, nrow = 2, ncol = 1)
  wald <- matrix(0, nrow = 2, ncol = 2)
  colnames(wald) <- c("log_hr", "se")
  
  # Create subgroup indicators
  dat.temp <- df %>% mutate(sg_age65 = ifelse(age >= 65, 1, 0),
                         sg_hf = comorb_chf,
                         sg_ihd = comorb_ihd,
                         sg_dm = comorb_dm,
                         sg_g3_4 = ifelse(adm_egfr_cat == 3 | adm_egfr_cat == 4 | adm_egfr_cat == 5, 1, 0))
                         
  # Create datasets for subgroup with criterium present 
  for (s in 1:2){
    if(sg == 1){ # Subgroup age
        dat.sub <- dat.temp %>% filter(sg_age65 == (s - 1))
      } else if(sg == 2){ # Subgroup heart failure
        dat.sub <- dat.temp %>% filter(sg_hf == (s - 1))
      } else if(sg == 3){ # Subgroup ischemic heart disease
        dat.sub <- dat.temp %>% filter(sg_ihd == (s - 1))
      } else if(sg == 4){ # Subgroup diabetes mellitus
        dat.sub <- dat.temp %>% filter(sg_dm == (s - 1))
      } else if(sg == 5){ # Subgroup moderate to severe CKD
        dat.sub <- dat.temp %>% filter(sg_g3_4 == (s - 1))
      }
  
    # Reweighting present population
    denom.fit <- glm(weighting_formula, family = binomial(), data = dat.sub)
    pred_denom <- predict(denom.fit, type = "response")
  
    dat.sub$pred_denom <- pred_denom
    normalize0 <- sum(dat.sub$pred_denom[which(dat.sub$stopping == 0)])
    normalize1 <- sum(dat.sub$pred_denom[which(dat.sub$stopping == 1)])
  
    # Weighted pseudopopulation will be as large as original population
    dat.sub$overlap_weight <- ifelse(dat.sub$stopping == 0, pred_denom / normalize0,  (1 - pred_denom) / normalize1)
  
    hr_outcome <- summary(coxph(as.formula(formula_coxph), data = dat.sub, weights = overlap_weight, robust = TRUE))$coef
    
    ir <- survRate(surv_formula, data = dat.sub) %>% 
      mutate(tstop = tstop * 100) %>% mutate_at(vars(rate, lower, upper), funs(round(., 1))) %>% 
      mutate_at(vars(tstop), funs(round(., 0)))
    ir <- ir %>% mutate(length_rate = nchar(rate),
                        rate = ifelse(length_rate == 2, paste(rate, ".0", sep = ""), 
                               ifelse(length_rate == 1, paste(rate, ".0", sep = ""), rate)),
                        length_lower = nchar(lower),
                        lower = ifelse(length_lower == 2, paste(lower, ".0", sep = ""), 
                                ifelse(length_lower == 1, paste(lower, ".0", sep = ""), lower)),
                        length_upper = nchar(upper),
                        upper = ifelse(length_upper == 2, paste(upper, ".0", sep = ""), 
                                ifelse(length_upper == 1, paste(upper, ".0", sep = ""), upper)))
    ir <- as.data.frame(ir) %>% mutate(rate = paste0(ir[, 4], " (",ir[, 5], "-",ir[, 6],")"))
    incid_rate <- ir[, 2:4] %>% dplyr::select(event, tstop, rate)
    incid_rate <- cbind(incid_rate$event[[2]], incid_rate$rate[[2]])
    
    # Here, coefficient and standard error are put in the first row and numbers and rates are put in the second row:
    # The coefficient and standard error are changed around in making the list outcome, which makes this line up.
    if(s == 1){ 
      hr_b[1] <- hr_outcome[1,1]
      hr_se[1] <- hr_outcome[1,4]
      N[2] <- nrow(dat.sub)
      events[2] <- incid_rate[[1]]
      rate[2] <- incid_rate[[2]]
      wald[2, 1] <- hr_outcome[[1]]
      wald[2, 2] <- hr_outcome[[4]]
    } else { 
      hr_b[2] <- hr_outcome[1,1]
      hr_se[2] <- hr_outcome[1,4]
      N[1] <- nrow(dat.sub)
      events[1] <- incid_rate[[1]]
      rate[1] <- incid_rate[[2]]
      wald[1, 1] <- hr_outcome[[1]]
      wald[1, 2] <- hr_outcome[[4]]
    }
  
  }
  
  hr_b_subgroup1 <- as.vector(hr_b[1,])
  hr_se_subgroup1 <- as.vector(hr_se[1,])
  hr_b_subgroup2 <- as.vector(hr_b[2,])
  hr_se_subgroup2 <- as.vector(hr_se[2,])
  
  Q1 <- c(hr_b_subgroup1, hr_se_subgroup1)
  Q2 <- c(hr_b_subgroup2, hr_se_subgroup2)
  
  # Wald test for interaction
  wald <- as.data.frame(wald)
  
  rowmax <- as.numeric(which(wald$log_hr == max(wald$log_hr)))
  rowmin <- ifelse(rowmax == 1, 2, 1)
  d <- wald[[rowmax, 1]] - wald[[rowmin, 1]]
  se <- sqrt((wald[[1, 2]] ^ 2) + (wald[[2, 2]] ^ 2))
  z <- d/se
  p <- round(2 * (1 - pnorm(z)), digits = 3)
  p <- ifelse(nchar(p) == 1, paste(p, ".000", sep = ""),
       ifelse(nchar(p) == 3, paste(p, "00", sep = ""),
       ifelse(nchar(p) == 4, paste(p, "0", sep = ""), p)))
  
  # For HR + 95%CI:
  outcome_subgroup1 <- as.matrix(round(exp(c(Q1[1],Q1[1] - 1.96*Q1[2], Q1[1] + 1.96*Q1[2])),2))  
  outcome_subgroup2 <- as.matrix(round(exp(c(Q2[1],Q2[1] - 1.96*Q2[2], Q2[1] + 1.96*Q2[2])),2))  
  outcome <- list(outcome_subgroup2, outcome_subgroup1)
  
  table <- transpose(as.data.frame(outcome))
  table <- cbind(c(ph1, ph2), as.data.frame(N), as.data.frame(events), as.data.frame(rate), table, NA)
  colnames(table) <- c("sg", "n", "events", "rate", "effect", "lower", "upper", "interaction")
  title <- transpose(as.data.frame(c(sg_name, NA, NA, NA, NA, NA, NA, p)))
  colnames(title) <- c("sg", "n", "events", "rate", "effect", "lower", "upper", "interaction")
  table <- rbind(title, table)
  
  return(table)
}

# Function per outcome
subgroup_outcome <- function(df, formula_coxph, surv_formula){
   # Age
   sg1 <- subgroup_hr_weighting(df, sg = 1, stopping ~ age + age_cat + female + educ_cat + adm_egfr + adm_egfr_cat + comorb_dm + 
                                comorb_ht + comorb_mi + comorb_arr + comorb_cd + comorb_pvd + comorb_ihd + comorb_copd + comorb_ca + 
                                comorb_ld + comorb_chf + comorb_dl + comorb_hyth + comorb_eh + comorb_vhd + med_bb + med_ccb + med_ld + 
                                med_td + med_pd + med_nsaid + med_al + med_ab + med_nt + med_ara + med_hl + med_aa + med_dx + med_ac + 
                                med_dm + med_op + kontakt_all + kontakt_cv + slv_all + slv_cv + ovr_all + ovr_cv + kontakt_all_cat + 
                                kontakt_cv_cat + slv_all_cat + slv_cv_cat + ovr_all_cat + ovr_cv_cat + hosp_cv + hosp_rs + 
                                hosp_gi + hosp_id + hosp_ca + hosp_op + hosp_hm + hosp_gu + hosp_ip + hosp_ns + hosp_hk + hosp_od + pc_sp + 
                                pc_cs + pc_cc + pc_ar + pc_pn + pc_lf + pc_mi + pc_ns + dur + AKI_acoa + crit_type + AcutDial + creat_mean +
                                creat_peak, formula_coxph, surv_formula, sg_name = "Age", ph1 = ">= 65 years", ph2 = "< 65 years")
   
   # Heart failure: remove heart failure comorbidity!
   sg2 <- subgroup_hr_weighting(df, sg = 2, stopping ~ age + age_cat + female + educ_cat + adm_egfr + adm_egfr_cat + comorb_dm + 
                                comorb_ht + comorb_mi + comorb_arr + comorb_cd + comorb_pvd + comorb_ihd + comorb_copd + comorb_ca + 
                                comorb_ld + comorb_chf + comorb_dl + comorb_hyth + comorb_eh + comorb_vhd + med_bb + med_ccb + med_ld + 
                                med_td + med_pd + med_nsaid + med_al + med_ab + med_nt + med_ara + med_hl + med_aa + med_dx + med_ac + 
                                med_dm + med_op + kontakt_all + kontakt_cv + slv_all + slv_cv + ovr_all + ovr_cv + kontakt_all_cat + 
                                kontakt_cv_cat + slv_all_cat + slv_cv_cat + ovr_all_cat + ovr_cv_cat + hosp_cv + hosp_rs + 
                                hosp_gi + hosp_id + hosp_ca + hosp_op + hosp_hm + hosp_gu + hosp_ip + hosp_ns + hosp_hk + hosp_od + pc_sp + 
                                pc_cs + pc_cc + pc_ar + pc_pn + pc_lf + pc_mi + pc_ns + dur + AKI_acoa + crit_type + AcutDial + creat_mean +
                                creat_peak, formula_coxph, surv_formula, sg_name = "Heart failure")
   
   # Ischemic heart disease: remove ischemic heart disease comorbidity!
   sg3 <- subgroup_hr_weighting(df, sg = 3, stopping ~ age + age_cat + female + educ_cat + adm_egfr + adm_egfr_cat + comorb_dm + 
                                comorb_ht + comorb_mi + comorb_arr + comorb_cd + comorb_pvd + comorb_ihd + comorb_copd + comorb_ca + 
                                comorb_ld + comorb_chf + comorb_dl + comorb_hyth + comorb_eh + comorb_vhd + med_bb + med_ccb + med_ld + 
                                med_td + med_pd + med_nsaid + med_al + med_ab + med_nt + med_ara + med_hl + med_aa + med_dx + med_ac + 
                                med_dm + med_op + kontakt_all + kontakt_cv + slv_all + slv_cv + ovr_all + ovr_cv + kontakt_all_cat + 
                                kontakt_cv_cat + slv_all_cat + slv_cv_cat + ovr_all_cat + ovr_cv_cat + hosp_cv + hosp_rs + 
                                hosp_gi + hosp_id + hosp_ca + hosp_op + hosp_hm + hosp_gu + hosp_ip + hosp_ns + hosp_hk + hosp_od + pc_sp + 
                                pc_cs + pc_cc + pc_ar + pc_pn + pc_lf + pc_mi + pc_ns + dur + AKI_acoa + crit_type + AcutDial + creat_mean +
                                creat_peak, formula_coxph, surv_formula, sg_name = "Ischemic heart disease")
   
   # Diabetes mellitus: remove diabetes mellitus comorbidity!
   sg4 <- subgroup_hr_weighting(df, sg = 4, stopping ~ age + age_cat + female + educ_cat + adm_egfr + adm_egfr_cat + comorb_dm + 
                                comorb_ht + comorb_mi + comorb_arr + comorb_cd + comorb_pvd + comorb_ihd + comorb_copd + comorb_ca + 
                                comorb_ld + comorb_chf + comorb_dl + comorb_hyth + comorb_eh + comorb_vhd + med_bb + med_ccb + med_ld + 
                                med_td + med_pd + med_nsaid + med_al + med_ab + med_nt + med_ara + med_hl + med_aa + med_dx + med_ac + 
                                med_dm + med_op + kontakt_all + kontakt_cv + slv_all + slv_cv + ovr_all + ovr_cv + kontakt_all_cat + 
                                kontakt_cv_cat + slv_all_cat + slv_cv_cat + ovr_all_cat + ovr_cv_cat + hosp_cv + hosp_rs + 
                                hosp_gi + hosp_id + hosp_ca + hosp_op + hosp_hm + hosp_gu + hosp_ip + hosp_ns + hosp_hk + hosp_od + pc_sp + 
                                pc_cs + pc_cc + pc_ar + pc_pn + pc_lf + pc_mi + pc_ns + dur + AKI_acoa + crit_type + AcutDial + creat_mean +
                                creat_peak, formula_coxph, surv_formula, sg_name = "Diabetes mellitus")
   
   # Moderate to advanced CKD
   sg5 <- subgroup_hr_weighting(df, sg = 5, stopping ~ age + age_cat + female + educ_cat + adm_egfr + adm_egfr_cat + comorb_dm + 
                                comorb_ht + comorb_mi + comorb_arr + comorb_cd + comorb_pvd + comorb_ihd + comorb_copd + comorb_ca + 
                                comorb_ld + comorb_chf + comorb_dl + comorb_hyth + comorb_eh + comorb_vhd + med_bb + med_ccb + med_ld + 
                                med_td + med_pd + med_nsaid + med_al + med_ab + med_nt + med_ara + med_hl + med_aa + med_dx + med_ac + 
                                med_dm + med_op + kontakt_all + kontakt_cv + slv_all + slv_cv + ovr_all + ovr_cv + kontakt_all_cat + 
                                kontakt_cv_cat + slv_all_cat + slv_cv_cat + ovr_all_cat + ovr_cv_cat + hosp_cv + hosp_rs + 
                                hosp_gi + hosp_id + hosp_ca + hosp_op + hosp_hm + hosp_gu + hosp_ip + hosp_ns + hosp_hk + hosp_od + pc_sp + 
                                pc_cs + pc_cc + pc_ar + pc_pn + pc_lf + pc_mi + pc_ns + dur + AKI_acoa + crit_type + AcutDial + creat_mean +
                                creat_peak, formula_coxph, surv_formula, sg_name = "Decreased kidney function")
   
   sg_analyses <- rbind(sg1, sg2, sg3, sg4, sg5)
   
   return(sg_analyses)
}

# Function to create forest plots per outcome
sg_plot <- function(df, formula_coxph, surv_formula){
  sg_table <- subgroup_outcome(df, formula_coxph, surv_formula)
  sg_table <- sg_table %>% mutate(length_effect = nchar(effect),
                                  effect = ifelse(length_effect == 3, paste(effect, "0", sep = ""),
                                          ifelse(length_effect == 1, paste(effect, ".00", sep = ""), effect)),
                                  length_lower = nchar(lower),
                                  lower = ifelse(length_lower == 3, paste(lower, "0", sep = ""),
                                          ifelse(length_lower == 1, paste(lower, ".00", sep = ""), lower)),
                                  length_upper = nchar(upper),
                                  upper = ifelse(length_upper == 3, paste(upper, "0", sep = ""),
                                          ifelse(length_upper == 1, paste(upper, ".00", sep = ""), upper)),
                                  effect_c = ifelse(is.na(effect), "", paste(as.character(effect), " (", as.character(lower), "-", 
                                                   as.character(upper), ")", sep = "")),
                                  index = nrow(sg_table) - (1:nrow(sg_table) - 1)) %>% 
    dplyr::select(-length_effect, -length_lower, -length_upper)
  return(sg_table)
}

# Start creating plots and data
sg_comp <- sg_plot(cohort1, Surv(time2comp, event_comp) ~ stopping, Surv(time2comp / (365.25 * 100), event_comp) ~ stopping)
sg_mort <- sg_plot(cohort1, Surv(time2death, event_mort) ~ stopping, Surv(time2death / (365.25 * 100), event_mort) ~ stopping)
sg_aki <- sg_plot(cohort1, Surv(time2aki, event_aki) ~ stopping, Surv(time2aki / (365.25 * 100), event_aki) ~ stopping)
sg_hf <- sg_plot(cohort1, Surv(time2hf, event_hf) ~ stopping, Surv(time2hf / (365.25 * 100), event_hf) ~ stopping)
sg_eskd <- sg_plot(cohort1_lab, Surv(time2eskd, event_eskd) ~ stopping, Surv(time2eskd / (365.25 * 100), event_eskd) ~ stopping)
sg_ckd <- sg_plot(cohort1_lab, Surv(time2ckd, event_ckd) ~ stopping, Surv(time2ckd / (365.25 * 100), event_ckd) ~ stopping)
sg_hkmod <- sg_plot(cohort1_lab, Surv(time2hk_moderate, event_hk_moderate) ~ stopping, 
                    Surv(time2hk_moderate / (365.25 * 100), event_hk_moderate) ~ stopping)
sg_mace <- sg_plot(cohort1, Surv(time2mace, event_mace) ~ stopping, Surv(time2mace / (365.25 * 100), event_mace) ~ stopping)

kable(sg_comp, caption = "Composite of death and MACE")
kable(sg_mort, caption = "Mortality")
kable(sg_aki, caption = "Recurrent AKI")
kable(sg_hf, caption = "Heart failure")
kable(sg_eskd, caption = "ESKD")
kable(sg_ckd, caption = "CKD progression")
kable(sg_hkmod, caption = "Moderate hyperkalemia")
kable(sg_mace, caption = "MACE")

## Forest plots
sg_fp <- function(df, file){
  dat <- df %>% mutate(effect_n = as.numeric(effect),
                            lower_n = as.numeric(lower),
                            upper_n = as.numeric(upper))
  
  index_max <- max(dat$index)
  lines <- seq(2.5, index_max, by = 3)
  
  fp <- ggplot(data = dat, aes(y = index, x = effect_n, xmin = lower_n, xmax = upper_n)) +
    geom_point() + geom_errorbarh(height = .1) +
    geom_hline(yintercept = lines, colour = "grey", linetype = "longdash", alpha = 0.5) +
    scale_y_continuous(name = "", breaks = 1:nrow(dat), labels = c(rep("", times = nrow(dat)))) +
    scale_x_continuous(name = "Adjusted HR* (95% CI)", breaks = seq(0.25, 2.00, by = 0.25), limits = c(0.25, 2.00)) +
    geom_vline(xintercept = 1, colour = "black", linetype = "dashed", alpha = 0.5) +
    theme(plot.margin = unit(c(0,0,0,0), "cm"),
          panel.background = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(), 
          panel.spacing = unit(0, "cm"),
          axis.line.x.bottom = element_line(colour = "black"),
          axis.ticks.y = element_blank())
 
  gg_datacolumns <- function(label, title , labels = NULL){
    p <- ggplot(data = dat, aes(y = index, x = 1)) +
    labs(title = title) + annotate("text", y = dat$index, x = 1, label = label) +
    geom_hline(yintercept = lines, colour = "grey", linetype = "longdash", alpha = 0.5) +
    scale_y_continuous(name = "", breaks = 1:nrow(dat), labels = labels) +
    scale_x_continuous(name = "", breaks = 0, labels = "") + 
    theme(plot.margin = unit(c(0,0,0,0), "cm"),
          panel.background = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(), 
          panel.spacing = unit(0, "cm"),
          axis.ticks.y = element_blank(),
          axis.text.y = element_text(colour = "black", size = 12), 
          plot.title = element_text(margin = margin(0, 0, 10, 0), face= "bold", size = 12, hjust = 0.5))
    return(p)
  }

  n <- gg_datacolumns(label = dat$n, "N", labels = rev(dat$sg))

  events <- gg_datacolumns(label = dat$events, "Events", labels = c(rep("", times = nrow(dat))))

  rate <- gg_datacolumns(label = dat$rate, "Incidence rate", labels = c(rep("", times = nrow(dat))))

  effect <- gg_datacolumns(label = dat$effect_c, "Adjusted HR* (95% CI)", labels = c(rep("", times = nrow(dat))))
  
  interaction <- gg_datacolumns(label = dat$interaction, "P-value for interaction", labels = c(rep("", times = nrow(dat))))
  
  setwd("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Figures/Workable figures/Subgroups")

  plot <- plot_grid(n, events, rate, fp, effect, interaction, rel_widths = c(1.5, 1, 1, 3, 1.2, 1.2), nrow = 1, align = "h")

  plot

  ggsave(file, width = 16, height = 5, dpi = 600)
}

sg_fp(sg_comp, "fp_comp.pdf")
sg_fp(sg_mort, "fp_mort.pdf")
sg_fp(sg_aki, "fp_aki.pdf")
sg_fp(sg_hf, "fp_hf.pdf")
sg_fp(sg_eskd, "fp_eskd.pdf")
sg_fp(sg_ckd, "fp_ckd.pdf")
sg_fp(sg_hkmod, "fp_hkmod.pdf")
sg_fp(sg_mace, "fp_mace.pdf")

```


## 1.6. Landmark figure (also for SA analysis landmark at 6 months)
```{r}
## 5 year
# Load unlandmarked cohort and medication database
load("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/cohort1.Rdata")
load("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/meds_c1.Rdata")

meds_rasi <- meds %>% filter(grepl("^C09A|^C09B|^C09C|^C09D", atc))

# Transform data
landmark_plot_data <- cohort1 %>% left_join(meds_rasi, "lopnr") %>%
  filter(edatum > dis_dt) %>%
  arrange(lopnr, edatum) %>% group_by(lopnr) %>% slice(1L) %>% ungroup() %>%
  mutate(time = as.numeric(edatum - dis_dt)) %>%
  filter(time <= (365.25 * 5)) %>%
  mutate(month = cut(time, c(seq(0, 1800, by = 30)), right = FALSE, labels = FALSE)) %>% 
  arrange(month) %>% group_by(month) %>%
  mutate(ind = 1,
         time_freq = sum(ind)) %>%
  slice(1L) %>% ungroup() %>%
  mutate(cum_time_freq = cumsum(time_freq)) %>%
  dplyr::select(month, time_freq, cum_time_freq)

landmark_plot_data <- rbind(landmark_plot_data, data.frame(month = 0, time_freq =  0, cum_time_freq = 0)) %>% arrange(month)

for(i in 1:60){
  x <- nrow(filter(landmark_plot_data, month == i))
  if(x == 1){
    landmark_plot_data <- landmark_plot_data
  } else {
    y <- filter(landmark_plot_data, month == (i - 1))
    placeholder <- as.data.frame(transpose(as.data.frame(c(i, 0, y$cum_time_freq))))
    colnames(placeholder) <- c("month", "time_freq", "cum_time_freq")
    landmark_plot_data <- rbind(landmark_plot_data, placeholder) %>% arrange(month)
  }
} 

# Theme for plot
theme_min <- function(){
    theme(panel.background = element_rect(fill = "white", colour = "black", size = 0.5),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(margin = margin(0, 0, 10, 0), face= "bold", size = 12, hjust = 0.5))
}

ggplot(landmark_plot_data, aes(x = month, y = cum_time_freq, label = cum_time_freq)) + 
  geom_line() + geom_point() + scale_y_continuous(expand = expansion(mult = c(0, .1))) +
  xlab("Time (Months)") + ylab("Cumulative count") + scale_x_continuous(breaks = seq(0, 60, 3), expand = c(0, 0)) +
  theme_min() + geom_vline(xintercept = 3, linetype = "dashed", alpha = 0.5) + 
  geom_vline(xintercept = 6, linetype = "longdash", alpha = 0.5) +
  ggtitle("Cumulative count of first RASi dispensation after discharge")

setwd("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Figures")

ggsave("landmark_plot5y.pdf", width = 8, height = 5, dpi = 600)

## 1 year
# Load unlandmarked cohort and medication database
load("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/cohort1.Rdata")
load("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/meds_c1.Rdata")

# Transform data
landmark_plot_data <- cohort1 %>% left_join(meds_rasi, "lopnr") %>%
  filter(edatum > dis_dt) %>%
  arrange(lopnr, edatum) %>% group_by(lopnr) %>% slice(1L) %>% ungroup() %>%
  mutate(time = as.numeric(edatum - dis_dt)) %>%
  filter(time <= 365.25) %>%
  mutate(month = cut(time, c(seq(0, 360, by = 30)), right = FALSE, labels = FALSE)) %>% 
  arrange(month) %>% group_by(month) %>%
  mutate(ind = 1,
         time_freq = sum(ind)) %>%
  slice(1L) %>% ungroup() %>%
  mutate(cum_time_freq = cumsum(time_freq)) %>%
  dplyr::select(month, time_freq, cum_time_freq)

landmark_plot_data <- rbind(landmark_plot_data, data.frame(month = 0, time_freq =  0, cum_time_freq = 0)) %>% arrange(month)

for(i in 1:12){
  x <- nrow(filter(landmark_plot_data, month == i))
  if(x == 1){
    landmark_plot_data <- landmark_plot_data
  } else {
    y <- filter(landmark_plot_data, month == (i - 1))
    placeholder <- as.data.frame(transpose(as.data.frame(c(i, 0, y$cum_time_freq))))
    colnames(placeholder) <- c("month", "time_freq", "cum_time_freq")
    landmark_plot_data <- rbind(landmark_plot_data, placeholder) %>% arrange(month)
  }
} 

# Theme for plot
theme_min <- function(){
    theme(panel.background = element_rect(fill = "white", colour = "black", size = 0.5),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(margin = margin(0, 0, 10, 0), face= "bold", size = 12, hjust = 0.5))
}

ggplot(landmark_plot_data, aes(x = month, y = cum_time_freq, label = cum_time_freq)) + 
  geom_line() + geom_point() + scale_y_continuous(expand = expansion(mult = c(0, .1))) +
  xlab("Time (Months)") + ylab("Cumulative count") + scale_x_continuous(breaks = seq(0, 12, 1), expand = c(0, 0)) +
  theme_min() + geom_vline(xintercept = 3, linetype = "dashed", alpha = 0.5) + 
  geom_vline(xintercept = 6, linetype = "longdash", alpha = 0.5) +
  ggtitle("Cumulative count of first RASi dispensation after discharge in the first year")

setwd("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Figures")

ggsave("landmark_plot1y.pdf", width = 8, height = 5, dpi = 600)

#### We also want to know how much people discontinue over time. 
load("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/population.Rdata")
cohort1 <- filter(population, cohort == 1)

# Create indicator to see which edatums were before (0) and which after landmark (1)
ph <- dplyr::select(cohort1, lopnr, adm_dt, index_dt, stopping, censor_dt)
meds_rev <- ph %>% left_join(meds_rasi, "lopnr") %>% filter(edatum >= (index_dt - 181)) %>% 
  mutate(ind = ifelse(edatum <= index_dt, 0, 1)) %>% dplyr::select(lopnr, edatum, atc, antnum, ind, antal) 

meds_be <- filter(meds_rev, ind == 0) %>% arrange(lopnr, desc(edatum)) %>% group_by(lopnr) %>% slice(1L) %>% ungroup() %>% 
  rename(edatum_before = edatum, antnum_before = antnum) %>% dplyr::select(lopnr, edatum_before, antnum_before)
meds_rev <- meds_rev %>% filter(ind == 1) %>% left_join(meds_be, "lopnr")

ph2 <- ph %>% left_join(meds_rev, "lopnr") %>% arrange(lopnr, edatum) %>% group_by(lopnr) %>%
    mutate(lead_edatum = lead(edatum),
           end_edatum = edatum + (antnum * antal),
           diff = as.numeric(lead_edatum - end_edatum),
           stopped = ifelse((stopping == 0 & diff > 30) | (stopping == 0 & is.na(lead_edatum)) | (stopping == 0 & is.na(edatum)), 1, 0),
           stopped_dt = end_edatum + 30,
           stopped_dt = as.Date(ifelse(is.na(stopped_dt) & stopped == 1, edatum_before + antnum_before, stopped_dt), origin = "1970-01-01"),
           stopped = ifelse(stopped_dt >= censor_dt, 0, stopped),
           yrs = as.numeric(stopped_dt - index_dt) / 365.25) %>% 
    ungroup() %>% arrange(lopnr, desc(stopping), edatum) %>% group_by(lopnr) %>% slice(1L) %>% ungroup() %>% 
    replace_na(list(stopped = 0)) %>% filter(stopped == 1) %>% mutate(yrs = as.numeric(stopped_dt - index_dt) / 365.25)

x <- length(unique(ph2$lopnr)) # continuers who stopped
y <- round(length(unique(ph2$lopnr)) / length(unique(filter(population, stopping == 1)$lopnr)) * 100, digits = 1) # proportion
z <- paste0(round(summary(ph2$yrs)[[3]], digits = 1), " (", round(summary(ph2$yrs)[[2]], digits = 1), "-", 
            round(summary(ph2$yrs)[[5]], digits = 1), ")", sep = "") # median years to stopping

df <- as.data.frame(cbind(x, y, z))
colnames(df) <- c("Stoppers", "Proportion", "Median years (IQR) until stopping")
kable(df)

# # 1 = Changed treatment (can be either stopping or continuing)
# # 2 = Stayed on treatment
# ph2 <- ph %>% left_join(meds_rev, "lopnr") %>% arrange(lopnr, edatum) %>% group_by(lopnr) %>%
#     mutate(lead_edatum = lead(edatum),
#            diff = as.numeric(lead_edatum - edatum),
#            change_trt = ifelse(diff > 30 & stopping == 0, 1, NA), # Change to stopping
#            change_trt = ifelse(stopping == 0 & diff <= 30, 0, change_trt), # Stayed on treatmnet
#            change_trt = ifelse(stopping == 1 & is.na(lead_edatum), 0, change_trt), # Stayed on treatment
#            change_trt = ifelse(stopping == 0 & is.na(lead_edatum), 1, change_trt), # Change to stopping
#            change_trt = ifelse(stopping == 1 & !is.na(lead_edatum), 1, change_trt)) %>% # Change to starting
#     ungroup() %>% arrange(lopnr, desc(change_trt), edatum) %>% group_by(lopnr) %>% slice(1L) %>% ungroup() %>%
#     mutate(trt_old = stopping,
#            trt_new = ifelse(change_trt == 0, stopping,
#                             ifelse(change_trt == 1 & stopping == 1, 0,
#                                    ifelse(change_trt == 1 & stopping == 0, 1, NA))),
#            # 30 day gap when stopping after continuing
#            change_trt_dt = as.Date(ifelse(change_trt == 1 & trt_old == 0, edatum + 30, NA), origin = "1970-01-01"), 
#            # going to starting after stopping
#            change_trt_dt = as.Date(ifelse(change_trt == 1 & trt_old == 1, edatum, NA), origin = "1970-01-01"),
#            # no change
#            change_trt_dt = as.Date(ifelse(is.na(change_trt_dt) & change_trt == 0, index_dt, change_trt_dt), origin = "1970-01-01"), 
#            # change to stopping & if not already lead_edatum used, then only one observation so stopped 30 days after index date
#            change_trt_dt = as.Date(ifelse(is.na(change_trt_dt) & trt_new == 1, index_dt + 30, change_trt_dt), origin = "1970-01-01"),
#            days = as.numeric(change_trt_dt - index_dt))

```


# 2. Sensitivity analyses
## 2.1. Also adjusting for ACR categories by making a missing category
### 2.1.0. Reloading data
```{r}
# This is used to load the data
# You need to adjust this to your own directory
rm(list = ls()) 

if(.Platform$OS.type == "windows"){
  load("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/population.Rdata")
} else {
  load("~/Onedrive/Documents/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/population.Rdata")
}

cohort1 <- filter(population, cohort == 1)
cohort2 <- filter(population, cohort == 2)
cohort1_lab <- filter(population, cohort == 1 & lab_outcome == 1)
cohort2_lab <- filter(population, cohort == 2 & lab_outcome == 1)

```

### 2.1.1. Weighting
```{r}
### Normal cohort
## Create propensity score (needed for denominator): chance of receiving treatment given covariates
# Create linear regression using covariates
denom.fit <- glm(stopping ~ age + age_cat + female + educ_cat + adm_egfr + adm_egfr_cat + comorb_dm + comorb_ht + comorb_mi + comorb_arr +
                 comorb_cd + comorb_pvd + comorb_ihd + comorb_copd + comorb_ca + comorb_ld + comorb_chf + comorb_dl + comorb_hyth + 
                 comorb_eh + comorb_vhd + med_bb + med_ccb + med_ld + med_td + med_pd + med_nsaid + med_al + med_ab + med_nt + med_ara + 
                 med_hl + med_aa + med_dx + med_ac + med_dm + med_op + kontakt_all + kontakt_cv + slv_all + slv_cv + ovr_all + ovr_cv + 
                 kontakt_all_cat + kontakt_cv_cat + slv_all_cat + slv_cv_cat + ovr_all_cat + ovr_cv_cat + hosp_cv + hosp_rs + hosp_gi + 
                 hosp_id + hosp_ca + hosp_op + hosp_hm + hosp_gu + hosp_ip + hosp_ns + hosp_hk + hosp_od + 
                 pc_sp + pc_cs + pc_cc + pc_ar + pc_pn + pc_lf + pc_mi + pc_ns + dur + AKI_acoa + crit_type + AcutDial + creat_mean +
                 creat_peak + acr_cat, family = binomial(), data = cohort1)

# Fill in regression formula per person to create propensity score
pred_denom <- predict(denom.fit, type = "response")

# Add propensity score to dataframe
cohort1$ps <- pred_denom
    
# Create numerator of weights, needed in case of stabilization 
# Normal cohort
numer.fit <- glm(stopping ~ 1, family = binomial(), data = cohort1)
pred_num <- predict(numer.fit, type = "response")

# Calculating overlap weights
cohort1$ow <- ifelse(cohort1$stopping == 0, pred_denom, (1 - pred_denom))
summary(cohort1$ow)

### Lab cohort
## Create propensity score (needed for denominator): chance of receiving treatment given covariates
# Create linear regression using covariates
denom.fit <- glm(stopping ~ age + age_cat + female + educ_cat + adm_egfr + adm_egfr_cat + comorb_dm + comorb_ht + comorb_mi + comorb_arr +
                 comorb_cd + comorb_pvd + comorb_ihd + comorb_copd + comorb_ca + comorb_ld + comorb_chf + comorb_dl + comorb_hyth + 
                 comorb_eh + comorb_vhd + med_bb + med_ccb + med_ld + med_td + med_pd + med_nsaid + med_al + med_ab + med_nt + med_ara + 
                 med_hl + med_aa + med_dx + med_ac + med_dm + med_op + kontakt_all + kontakt_cv + slv_all + slv_cv + ovr_all + ovr_cv + 
                 kontakt_all_cat + kontakt_cv_cat + slv_all_cat + slv_cv_cat + ovr_all_cat + ovr_cv_cat + hosp_cv + hosp_rs + hosp_gi + 
                 hosp_id + hosp_ca + hosp_op + hosp_hm + hosp_gu + hosp_ip + hosp_ns + hosp_hk + hosp_od + pc_sp + pc_cs + pc_cc + pc_ar + 
                 pc_pn + pc_lf + pc_mi + pc_ns + dur + AKI_acoa + crit_type + AcutDial + creat_mean + creat_peak + acr_cat, 
                 family = binomial(), data = cohort1_lab)

# Fill in regression formula per person to create propensity score
pred_denom <- predict(denom.fit, type = "response")

# Add propensity score to dataframe
cohort1_lab$ps <- pred_denom
    
# Create numerator of weights, needed in case of stabilization 
# Normal cohort
numer.fit <- glm(stopping ~ 1, family = binomial(), data = cohort1_lab)
pred_num <- predict(numer.fit, type = "response")

# Calculating overlap weights
cohort1_lab$ow <- ifelse(cohort1_lab$stopping == 0, pred_denom, (1 - pred_denom))
summary(cohort1_lab$ow)

```


### 2.1.2. Adjusted Cox models using overlap weights
```{r}
# Weighted Cox models using IPTW
# Function for model
coxweighted <- function(event, time2event, cohort_stopping, cohort_weight){
  cox_weighted <- coxph(Surv(time2event, event) ~ as.factor(cohort_stopping), weights = cohort_weight, robust = TRUE)

   # This code is just used to put the hazard ratios and confidence intervals in a table
  table_weighted <- format(round(cbind(summary(cox_weighted)$coef, exp(confint(cox_weighted))), 2), nsmall = 2) %>% 
    as.data.frame() %>% filter(row_number() == 1) 
  table_weighted <- table_weighted[, c(2, 7:8)] 
  colnames(table_weighted) <- c("HR","lower","upper") 
  
  table_weighted <- as.data.frame(table_weighted) %>% mutate(HR = gsub(pattern = " ", replacement = "", x = HR),
                                                             lHR = nchar(HR),
                                                             HR = ifelse(lHR == 1 | lHR == 2, paste(HR, ".0", sep = ""), HR),
                                                             lower = gsub(pattern = " ", replacement = "", x = lower),
                                                             llower = nchar(lower),
                                                             lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                                             upper = gsub(pattern = " ", replacement = "", x = upper),
                                                             lupper = nchar(upper),
                                                             upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                                             HR = paste(HR, " (", lower, "-", upper,")", sep = ""))  
  table_weighted <- as.data.frame(table_weighted[, 1]) 
  colnames(table_weighted) <- "Overlap Weights Adjusted HR (95% CI)"
  
  table_weighted <- rbind("", "1 (Reference)", table_weighted)
  
  return(table_weighted)
}


# Outcomes with overlap weights
cox_weighted_comp <- coxweighted(cohort1$event_comp, cohort1$time2comp, cohort1$stopping, cohort1$ow)
cox_weighted_death <- coxweighted(cohort1$event_mort, cohort1$time2death, cohort1$stopping, cohort1$ow)
cox_weighted_aki <- coxweighted(cohort1$event_aki, cohort1$time2aki, cohort1$stopping, cohort1$ow)
cox_weighted_hf <- coxweighted(cohort1$event_hf, cohort1$time2hf, cohort1$stopping, cohort1$ow)
cox_weighted_eskd <- coxweighted(cohort1_lab$event_eskd, cohort1_lab$time2eskd, cohort1_lab$stopping, cohort1_lab$ow)
cox_weighted_ckd <- coxweighted(cohort1_lab$event_ckd, cohort1_lab$time2ckd, cohort1_lab$stopping, cohort1_lab$ow)
cox_weighted_hkmod <- coxweighted(cohort1_lab$event_hk_moderate, cohort1_lab$time2hk_moderate, cohort1_lab$stopping, cohort1_lab$ow)
cox_weighted_mace <- coxweighted(cohort1$event_mace, cohort1$time2mace, cohort1$stopping, cohort1$ow)

categories <- as.data.frame(c("Continued RASi", "Stopped RASi"))
title_comp <- rbind("Composite", categories)
title_mort <- rbind("Mortality", categories)
title_aki <- rbind("Recurrent AKI", categories)
title_hf <- rbind("Heart failure", categories)
title_eskd <- rbind("ESKD", categories)
title_ckd <- rbind("CKD progression", categories)
title_hkmod <- rbind("Moderate hyperkalemia", categories)
title_mace <- rbind("MACE", categories)

titles <- rbind(title_comp, title_mort, title_aki, title_hf, title_eskd, title_ckd, title_hkmod, title_mace)

cox_weighted_ow <- cbind(titles, rbind(cox_weighted_comp, cox_weighted_death, cox_weighted_aki, cox_weighted_hf, 
                                       cox_weighted_eskd, cox_weighted_ckd, cox_weighted_hkmod, cox_weighted_mace))
colnames(cox_weighted_ow) <- c("", "Overlap weights adjusted HR (95% CI)")

kable(cox_weighted_ow)

rm(cox_weighted_death, cox_weighted_aki, cox_weighted_hf, cox_weighted_eskd, cox_weighted_ckd, cox_weighted_hkmod,
   cox_weighted_mace, coxweighted)

```


## 2.2. AKI only ascertained using N17 code (cohort2)
### 2.2.1. Baseline characteristics
```{r include=FALSE}
# This code is used to make the baseline table. We will do this before and after the propensity score weighting

# Specify which variables in the dataset you want to include in the baseline table
listvar <- c("age", "age_cat", "female", "educ_cat", "adm_egfr", "adm_egfr_cat", "comorb_dm", "comorb_ht", "comorb_mi", "comorb_arr",
             "comorb_cd", "comorb_pvd", "comorb_ihd", "comorb_copd", "comorb_ca", "comorb_ld",  "comorb_chf", "comorb_dl", "comorb_hyth", 
             "comorb_eh", "comorb_vhd", "med_bb", "med_ccb", "med_ld", "med_td", "med_pd", "med_nsaid", "med_al", "med_ab",  "med_nt", 
             "med_ara", "med_hl", "med_aa", "med_dx", "med_ac", "med_dm", "med_op", "kontakt_all", "kontakt_all_cat", "kontakt_cv",
             "kontakt_cv_cat", "ovr_all", "ovr_all_cat", "ovr_cv", "ovr_cv_cat", "slv_all", "slv_all_cat", "slv_cv", "slv_cv_cat", 
             "hosp_cv", "hosp_rs", "hosp_gi", "hosp_id", "hosp_ca", "hosp_op", "hosp_hm", "hosp_gu", "hosp_ip", 
             "hosp_ns", "hosp_hk", "hosp_od", "pc_sp", "pc_cs", "pc_cc", "pc_ar", "pc_pn", "pc_lf", "pc_mi", "pc_ns", "dur", "AKI_acoa", 
             "crit_type", "AcutDial", "creat_mean", "creat_peak", "potass_mean", "potass_peak", "acr", "acr_cat", "chol") 

# specify which variables are continuous
continuous <- c("age","adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur", "creat_mean", 
                "creat_peak", "potass_mean", "potass_peak", "acr", "chol") 

catvar <- listvar[!listvar %in% continuous] # specify that all other variables except the ones specified previously are categorical

# Give labels to the variables
labels <- c("Number of individuals",
            "Median age (IQR) (years)", 
            "Age category (years)", "< 50", "50-59", "60-69", "70-79", "> 80",
            "Female", 
            "Highest level of education achieved", "Compulsory school", "Secondary school", "University", "Missing",
            "Median eGFR before admission (IQR) (ml/min/1.73 m2)",
            "CKD categories", "G1", "G2", "G3a", "G3b", "G4",
            "Diabetes mellitus",
            "Hypertension",
            "Myocardial infarction",
            "Arrythmia",
            "Cerebrovascular disease",
            "Peripheral vascular disease",
            "Ischemic heart disease",
            "Chronic obstructive pulmonary disease",
            "Cancer",
            "Liver disease",
            "Chronic heart failure",
            "Dyslipidemia",
            "Hypothyroidism",
            "Extracranial hemorrhage",
            "Valvular heart disease",
            "Beta blockers",
            "Calcium channel blockers",
            "Loop diuretics",
            "Thiazide diuretics",
            "Potassium-sparing diuretics",
            "NSAIDs",
            "Antilipids",
            "Alpha blockers",
            "Nitrate",
            "MRAs",
            "Hydralazine",
            "Antiarrythmics",
            "Digoxin",
            "Anticoagulants",
            "Diabetes medication",
            "Opioids",
            "Median primary care context contacts (IQR)",
            "Amount of primary care contex contacts", "Zero", "One", "Two", "Three or more",
            "Cardiovascular primary care context contacts (IQR)",
            "Amount of cardiovascular primary care contex contacts", "Zero", "One", "Two", "Three or more",
            "Median specialist care context contacts (IQR)",
            "Amount of specialist care contex contacts", "Zero", "One", "Two", "Three or more",
            "Median cardiovascular specialist context care contacts (IQR)",
            "Amount of cardiovascular specialist care contex contacts", "Zero", "One", "Two", "Three or more",
            "Median number of hospitalizations (IQR)",
            "Amount of hospitalizations", "Zero", "One", "Two", "Three or more",
            "Median number of cardiovascular hospitalizations (IQR)",
            "Amount of cardiovascular hospitalizations", "Zero", "One", "Two", "Three or more",
            "Cardiovascular disease",
            "Respiratory disease",
            "Gastrointestinal, metabolic, and endocrine disease",
            "Infectious disease",
            "Cancer",
            "Musculoskeletal and connective tissue disease",
            "Hematologic disease",
            "Genitourinary disease",
            "Injury or poisoning",
            "Neurological disease",
            "Hyperkalemia",
            "Other disease",
            "Sepsis",
            "Cardiac surgery",
            "Cardiac catherization",
            "Abdominal aortic aneurysm repair",
            "Pneumonia",
            "Liver failure",
            "Acute myocardial infarction",
            "Non-cardiac surgery",
            "Median duration of stay (IQR) (days)",
            "AKI as cause of admission",
            "Stage of AKI KDIGO", 
            "Need for acute dialysis",
            "Median of average creatinine during hospitalization (IQR) (umol/L)",
            "Median of peak creatinine during hospitalization (IQR) (umol/L)",
            "Mean potassium (mmol/L)",
            "Peak potassium (mmol/L)",
            "Albumin-creatinine ratio (mg/mmol)",
            "Albumin-creatinine ratio categories", "< 3", "3-29", "30-69", "> 70", "Missing",
            "Total cholesterol (mmol/L)") 

# Makes overall baseline table
# For more information what is specified here, please see:
# https://www.rdocumentation.org/packages/tableone/versions/0.12.0/topics/CreateTableOne 
# https://www.rdocumentation.org/packages/tableone/versions/0.12.0/topics/print.TableOne
table_overall <- CreateTableOne(vars = listvar, data = cohort2, factorVars = catvar) # 
table_overall <- print(table_overall, printToggle = FALSE, noSpaces = TRUE, catDigits = 0, contDigits = 1, pDigits = 3,
                       nonnormal = c("age", "adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur",
                                     "creat_mean", "creat_peak", "acr")) 
table_overall <- as.matrix(table_overall)
row.names(table_overall) <- labels

# Makes baseline table stratified by treatment level
table_stratified <- CreateTableOne(vars = listvar, data = cohort2, factorVars = catvar, smd = TRUE, strata = "stopping")
table_stratified <- print(table_stratified, printToggle = FALSE, noSpaces = TRUE, catDigits = 0, contDigits = 1, pDigits = 3,
                          nonnormal = c("age", "adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur",
                                        "creat_mean", "creat_peak", "acr"), smd = TRUE) 
table_stratified <- as.matrix(table_stratified[, c(2, 1, 5)])
row.names(table_stratified) <- labels

# Combine tables and add notes
# No one in this cohort uses hydralazine; as such, it is noted as 100% because there is only 1 category (0 = not using). Change to 0%
table1 <- cbind(table_overall,table_stratified) 
colnames(table1) <- c("Overall","Stopped RASi","Continued RASi","SMD")

# remove objects
rm(listvar, continuous, catvar, labels, table_overall, table_stratified)

```

### 2.2.2. Total number of events, person years, and incidence rates
```{r include=FALSE}
# This is a piece of code to get the overall incidence of the outcome (not stratified by treatment)
incid_num_ovr <- function(outcome, time2outcome, cohort){
  incid_ovr <- survRate(Surv((time2outcome / (365.25 * 100)), outcome) ~ 0) %>%
    mutate(tstop = tstop * 100) %>% mutate_at(vars(rate, lower, upper), funs(round(., 1))) %>% mutate_at(vars(tstop), funs(round(., 0)))
  incid_ovr <- as.data.frame(incid_ovr) %>% mutate(rate = gsub(pattern = " ", replacement = "", x = rate),
                                                   lrate = nchar(rate),
                                                   rate = ifelse(lrate == 1 | lrate == 2, paste(rate, ".0", sep = ""), rate),
                                                   lower = gsub(pattern = " ", replacement = "", x = lower),
                                                   llower = nchar(lower),
                                                   lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                                   upper = gsub(pattern = " ", replacement = "", x = upper),
                                                   lupper = nchar(upper),
                                                   upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                                   rate = paste(rate, " (", lower, "-", upper,")", sep = ""))
  incid_ovr <- incid_ovr[, 1:4] %>% dplyr::select(event, tstop, rate) %>% 
    mutate(n = nrow(cohort)) %>% relocate(n, .before = event)
  return(incid_ovr)
}

# This is a piece of code to get the incidence stratified by treatment
incid_num_str <- function(outcome, time2outcome, cohort_stopping, cohort){
  ir <- survRate(Surv((time2outcome / (365.25 * 100)), outcome) ~ cohort_stopping) %>% 
    mutate(tstop = tstop * 100) %>% mutate_at(vars(rate, lower, upper), funs(round(., 1))) %>% mutate_at(vars(tstop), funs(round(., 0)))
  ir <- as.data.frame(ir) %>% mutate(rate = gsub(pattern = " ", replacement = "", x = rate),
                                     lrate = nchar(rate),
                                     rate = ifelse(lrate == 1 | lrate == 2, paste(rate, ".0", sep = ""), rate),
                                     lower = gsub(pattern = " ", replacement = "", x = lower),
                                     llower = nchar(lower),
                                     lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                     upper = gsub(pattern = " ", replacement = "", x = upper),
                                     lupper = nchar(upper),
                                     upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                     rate = paste(rate, " (", lower, "-", upper,")", sep = "")) 
  ir <- ir[, 2:4] %>% dplyr::select(event, tstop, rate)
  x <- as.data.frame(count(cohort, stopping))
  n <- rbind(x$n[[1]], x$n[[2]])
  ir <- cbind(n, ir)
  return(ir)
}


# Incidence table function
inctab <- function(event, time2event, cohort_stopping, cohort){
  incid_overall <- incid_num_ovr(event, time2event, cohort)
  colnames(incid_overall) <- c("N", "Events","py","Incidence rate per 100 py")
  rownames(incid_overall) <- c("Overall")
  
  incid_stratified <- incid_num_str(event, time2event, cohort_stopping, cohort)
  colnames(incid_stratified) <- c("N", "Events","py","Incidence rate per 100 py")
  rownames(incid_stratified) <- c("Continued RASi","Stopped RASi")
  
  incidence_table <- as.matrix(rbind(incid_overall, incid_stratified))
  return(incidence_table)
}

# Title function
tabtitle <- function(titlename){
  title <- transpose(as.data.frame(c("", "", "", "")))
  colnames(title) <- c("N", "Events","py","Incidence rate per 100 py")
  rownames(title) <- c(titlename)
  return(title)
}

# Outcomes
title_comp <- tabtitle("Composite")
incidence_table_comp <- inctab(cohort2$event_comp, cohort2$time2comp, cohort2$stopping, cohort2)
title_death <- tabtitle("Mortality")
incidence_table_death <- inctab(cohort2$event_mort, cohort2$time2death, cohort2$stopping, cohort2)
title_aki <- tabtitle("Recurrent AKI")
incidence_table_aki <- inctab(cohort2$event_aki, cohort2$time2aki, cohort2$stopping, cohort2)
title_hf <- tabtitle("Heart failure hospitalisation")
incidence_table_hf <- inctab(cohort2$event_hf, cohort2$time2hf, cohort2$stopping, cohort2)
title_eskd <- tabtitle("ESKD")
incidence_table_eskd <- inctab(cohort2_lab$event_eskd, cohort2_lab$time2eskd, cohort2_lab$stopping, cohort2_lab)
title_ckd <- tabtitle("CKD progression")
incidence_table_ckd <- inctab(cohort2_lab$event_ckd, cohort2_lab$time2ckd, cohort2_lab$stopping, cohort2_lab)
title_hkmod <- tabtitle("Moderate hyperkalemia")
incidence_table_hkmod <- inctab(cohort2_lab$event_hk_moderate, cohort2_lab$time2hk_moderate, cohort2_lab$stopping, cohort2_lab)
title_mace <- tabtitle("MACE")
incidence_table_mace <- inctab(cohort2$event_mace, cohort2$time2mace, cohort2$stopping, cohort2)

incidence_table <- as.matrix(rbind(title_comp, incidence_table_comp,
                                   title_death, incidence_table_death, title_aki, incidence_table_aki, title_hf, incidence_table_hf, 
                                   title_eskd, incidence_table_eskd, title_ckd, incidence_table_ckd, 
                                   title_hkmod, incidence_table_hkmod, title_mace, incidence_table_mace))
kable(incidence_table)

rm(incid_num_ovr, incid_num_str, inctab, tabtitle, title_death, incidence_table_death, title_aki, incidence_table_aki, title_hf, 
   incidence_table_hf, title_eskd, incidence_table_eskd, title_ckd, incidence_table_ckd, title_hkmod, 
   incidence_table_hkmod, title_mace, incidence_table_mace, title_comp, incidence_table_comp)
```


### 2.2.3. Unadjusted Cox regression model
```{r include=FALSE}
# Unadjusted Cox model with univariabele regression
# Function to create model and table
coxunadjusted <- function(event, time2event, cohort_stopping){
  cox_unadjusted <- coxph(Surv(time2event, event) ~ as.factor(cohort_stopping)) 
  dat <- summary(cox_unadjusted) # outputs coefficients of unadjusted Cox model and HR's with confidence intervals
  
  # This code is just used to put the hazard ratios and confidence intervals in a table
  table_unadj <- format(round(cbind(dat$coef, exp(confint(cox_unadjusted))),2), nsmall = 2) %>% as.data.frame() %>%
    filter(row_number() == 1) 
  table_unadj <- table_unadj[, c(2, 6:7)] 
  colnames(table_unadj) <- c("HR","lower","upper") 

  table_unadj <- as.data.frame(table_unadj) %>% mutate(HR = gsub(pattern = " ", replacement = "", x = HR),
                                                       lHR = nchar(HR),
                                                       HR = ifelse(lHR == 1 | lHR == 2, paste(HR, ".0", sep = ""), HR),
                                                       lower = gsub(pattern = " ", replacement = "", x = lower),
                                                       llower = nchar(lower),
                                                       lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                                       upper = gsub(pattern = " ", replacement = "", x = upper),
                                                       lupper = nchar(upper),
                                                       upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                                       HR = paste(HR, " (", lower, "-", upper,")", sep = "")) 
  table_unadj <- as.data.frame(table_unadj[, 1])  
  colnames(table_unadj) <- "Crude HR (95% CI)"
  return(table_unadj)
}

# Outcomes
table_unadj_comp <- rbind("", "" , "1 (Reference)", coxunadjusted(cohort2$event_comp, cohort2$time2comp, cohort2$stopping))
table_unadj_death <- rbind("", "", "1 (Reference)", coxunadjusted(cohort2$event_mort, cohort2$time2death, cohort2$stopping))
table_unadj_aki <- rbind("", "", "1 (Reference)", coxunadjusted(cohort2$event_aki, cohort2$time2aki, cohort2$stopping))
table_unadj_hf <- rbind("", "", "1 (Reference)", coxunadjusted(cohort2$event_hf, cohort2$time2hf, cohort2$stopping))
table_unadj_eskd <- rbind("", "", "1 (Reference)", coxunadjusted(cohort2_lab$event_eskd, cohort2_lab$time2eskd, cohort2_lab$stopping))
table_unadj_ckd <- rbind("", "", "1 (Reference)", coxunadjusted(cohort2_lab$event_ckd, cohort2_lab$time2ckd, cohort2_lab$stopping))
table_unadj_hkmod <- rbind("", "", "1 (Reference)", coxunadjusted(cohort2_lab$event_hk_moderate, cohort2_lab$time2hk_moderate, 
                                                                  cohort2_lab$stopping))
table_unadj_mace <- rbind("", "", "1 (Reference)", coxunadjusted(cohort2$event_mace, cohort2$time2mace, cohort2$stopping))

cox_table_unadjusted <- rbind(table_unadj_comp, table_unadj_death, table_unadj_aki, table_unadj_hf, table_unadj_eskd, table_unadj_ckd,
                              table_unadj_hkmod, table_unadj_mace)

rm(coxunadjusted, table_unadj_death, table_unadj_aki, table_unadj_hf, table_unadj_eskd, table_unadj_ckd, 
   table_unadj_hkmod, table_unadj_mace, table_unadj_comp)

```


### 2.2.4. Weighting
#### 2.2.4.1. Estimating overlap weights
```{r}
### Normal cohort
## Create propensity score (needed for denominator): chance of receiving treatment given covariates
# Create linear regression using covariates
denom.fit <- glm(stopping ~ age + age_cat + female + educ_cat + adm_egfr + adm_egfr_cat + comorb_dm + comorb_ht + comorb_mi + comorb_arr +
                 comorb_cd + comorb_pvd + comorb_ihd + comorb_copd + comorb_ca + comorb_ld + comorb_chf + comorb_dl + comorb_hyth + 
                 comorb_eh + comorb_vhd + med_bb + med_ccb + med_ld + med_td + med_pd + med_nsaid + med_al + med_ab + med_nt + med_ara + 
                 med_hl + med_aa + med_dx + med_ac + med_dm + med_op + kontakt_all + kontakt_cv + slv_all + slv_cv + ovr_all + ovr_cv + 
                 kontakt_all_cat + kontakt_cv_cat + slv_all_cat + slv_cv_cat + ovr_all_cat + ovr_cv_cat + hosp_cv + hosp_rs + hosp_gi + 
                 hosp_id + hosp_ca + hosp_op + hosp_hm + hosp_gu + hosp_ip + hosp_ns + hosp_hk + hosp_od + 
                 pc_sp + pc_cs + pc_cc + pc_ar + pc_pn + pc_lf + pc_mi + pc_ns + dur + AKI_acoa + crit_type + AcutDial + creat_mean +
                 creat_peak, family = binomial(), data = cohort2)

# Fill in regression formula per person to create propensity score
pred_denom <- predict(denom.fit, type = "response")

# Add propensity score to dataframe
cohort2$ps <- pred_denom
normalize0 <- sum(cohort2$ps[which(cohort2$stopping == 0)])
normalize1 <- sum(cohort2$ps[which(cohort2$stopping == 1)])

# Calculating overlap weights
# Weighted pseudopopulation will be as large as original population
cohort2$ow <- ifelse(cohort2$stopping == 0, pred_denom / normalize0,  (1 - pred_denom) / normalize1)
summary(cohort2$ow)

### Lab cohort
## Create propensity score (needed for denominator): chance of receiving treatment given covariates
# Create linear regression using covariates
denom.fit <- glm(stopping ~ age + age_cat + female + educ_cat + adm_egfr + adm_egfr_cat + comorb_dm + comorb_ht + comorb_mi + comorb_arr +
                 comorb_cd + comorb_pvd + comorb_ihd + comorb_copd + comorb_ca + comorb_ld + comorb_chf + comorb_dl + comorb_hyth + 
                 comorb_eh + comorb_vhd + med_bb + med_ccb + med_ld + med_td + med_pd + med_nsaid + med_al + med_ab + med_nt + med_ara + 
                 med_hl + med_aa + med_dx + med_ac + med_dm + med_op + kontakt_all + kontakt_cv + slv_all + slv_cv + ovr_all + ovr_cv + 
                 kontakt_all_cat + kontakt_cv_cat + slv_all_cat + slv_cv_cat + ovr_all_cat + ovr_cv_cat + hosp_cv + hosp_rs + hosp_gi + 
                 hosp_id + hosp_ca + hosp_op + hosp_hm + hosp_gu + hosp_ip + hosp_ns + hosp_hk + hosp_od + pc_sp + pc_cs + pc_cc + pc_ar + 
                 pc_pn + pc_lf + pc_mi + pc_ns + dur + AKI_acoa + crit_type + AcutDial + creat_mean + creat_peak, family = binomial(), 
                 data = cohort2_lab)

# Fill in regression formula per person to create propensity score
pred_denom <- predict(denom.fit, type = "response")

# Add propensity score to dataframe
cohort2_lab$ps <- pred_denom
normalize0 <- sum(cohort2_lab$ps[which(cohort2_lab$stopping == 0)])
normalize1 <- sum(cohort2_lab$ps[which(cohort2_lab$stopping == 1)])

# Calculating overlap weights
# Weighted pseudopopulation will be as large as original population
cohort2_lab$ow <- ifelse(cohort2_lab$stopping == 0, pred_denom / normalize0,  (1 - pred_denom) / normalize1)
summary(cohort2_lab$ow)

```

#### 2.2.4.2. Baseline characteristics after weighting
```{r}
# Create a weighted survey design object
cohort2Svy <- svydesign(ids = ~ lopnr, weights = ~ ow, data = cohort2)

# Specify which variables in the dataset you want to include in the baseline table
listvar <- c("age", "age_cat", "female", "educ_cat", "adm_egfr", "adm_egfr_cat", "comorb_dm", "comorb_ht", "comorb_mi", "comorb_arr",
             "comorb_cd", "comorb_pvd", "comorb_ihd", "comorb_copd", "comorb_ca", "comorb_ld",  "comorb_chf", "comorb_dl", "comorb_hyth", 
             "comorb_eh", "comorb_vhd", "med_bb", "med_ccb", "med_ld", "med_td", "med_pd", "med_nsaid", "med_al", "med_ab",  "med_nt", 
             "med_ara", "med_hl", "med_aa", "med_dx", "med_ac", "med_dm", "med_op", "kontakt_all", "kontakt_all_cat", "kontakt_cv",
             "kontakt_cv_cat", "ovr_all", "ovr_all_cat", "ovr_cv", "ovr_cv_cat", "slv_all", "slv_all_cat", "slv_cv", "slv_cv_cat", 
             "hosp_cv", "hosp_rs", "hosp_gi", "hosp_id", "hosp_ca", "hosp_op", "hosp_hm", "hosp_gu", "hosp_ip", 
             "hosp_ns", "hosp_hk", "hosp_od", "pc_sp", "pc_cs", "pc_cc", "pc_ar", "pc_pn", "pc_lf", "pc_mi", "pc_ns", "dur", "AKI_acoa", 
             "crit_type", "AcutDial", "creat_mean", "creat_peak", "potass_mean", "potass_peak", "acr", "acr_cat", "chol") 

# specify which variables are continuous
continuous <- c("age","adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur", "creat_mean", 
                  "creat_peak", "potass_mean", "potass_peak", "acr", "chol") 

catvar <- listvar[!listvar %in% continuous] # specify that all other variables except the ones specified previously are categorical

# Give labels to the variables
  labels <- c("Number of individuals",
              "Median age (IQR) (years)", 
              "Age category (years)", "< 50", "50-59", "60-69", "70-79", "> 80",
              "Female", 
              "Highest level of education achieved", "Compulsory school", "Secondary school", "University", "Missing", 
              "Median eGFR before admission (IQR) (ml/min/1.73 m2)",
              "CKD categories", "G1", "G2", "G3a", "G3b", "G4",
              "Diabetes mellitus",
              "Hypertension",
              "Myocardial infarction",
              "Arrythmia",
              "Cerebrovascular disease",
              "Peripheral vascular disease",
              "Ischemic heart disease",
              "Chronic obstructive pulmonary disease",
              "Cancer",
              "Liver disease",
              "Chronic heart failure",
              "Dyslipidemia",
              "Hypothyroidism",
              "Extracranial hemorrhage",
              "Valvular heart disease",
              "Beta blockers",
              "Calcium channel blockers",
              "Loop diuretics",
              "Thiazide diuretics",
              "Potassium-sparing diuretics",
              "NSAIDs",
              "Antilipids",
              "Alpha blockers",
              "Nitrate",
              "MRAs",
              "Hydralazine",
              "Antiarrythmics",
              "Digoxin",
              "Anticoagulants",
              "Diabetes medication",
              "Opioids",
              "Median primary care context contacts (IQR)",
              "Amount of primary care contex contacts", "Zero", "One", "Two", "Three or more",
              "Cardiovascular primary care context contacts (IQR)",
              "Amount of cardiovascular primary care contex contacts", "Zero", "One", "Two", "Three or more",
              "Median specialist care context contacts (IQR)",
              "Amount of specialist care contex contacts", "Zero", "One", "Two", "Three or more",
              "Median cardiovascular specialist context care contacts (IQR)",
              "Amount of cardiovascular specialist care contex contacts", "Zero", "One", "Two", "Three or more",
              "Median number of hospitalizations (IQR)",
              "Amount of hospitalizations", "Zero", "One", "Two", "Three or more",
              "Median number of cardiovascular hospitalizations (IQR)",
              "Amount of cardiovascular hospitalizations", "Zero", "One", "Two", "Three or more",
              "Cardiovascular disease",
              "Respiratory disease",
              "Gastrointestinal, metabolic, and endocrine disease",
              "Infectious disease",
              "Cancer",
              "Musculoskeletal and connective tissue disease",
              "Hematologic disease",
              "Genitourinary disease",
              "Injury or poisoning",
              "Neurological disease",
              "Hyperkalemia",
              "Other disease",
              "Sepsis",
              "Cardiac surgery",
              "Cardiac catherization",
              "Abdominal aortic aneurysm repair",
              "Pneumonia",
              "Liver failure",
              "Acute myocardial infarction",
              "Non-cardiac surgery",
              "Median duration of stay (IQR) (days)",
              "AKI as cause of admission",
              "Stage of AKI KDIGO", 
              "Need for acute dialysis",
              "Median of average creatinine during hospitalization (IQR) (umol/L)",
              "Median of peak creatinine during hospitalization (IQR) (umol/L)",
              "Mean potassium (mmol/L)",
              "Peak potassium (mmol/L)",
              "Albumin-creatinine ratio (mg/mmol)",
              "Albumin-creatinine ratio categories", "< 3", "3-29", "30-69", "> 70", "Missing",
              "Total cholesterol (mmol/L)")  

# Characteristics stratified by treatment group
table_weighted <- svyCreateTableOne(vars = listvar, data = cohort2Svy, factorVars = catvar, strata = "stopping")
table_weighted <- print(table_weighted, printToggle = FALSE, 
                        nonnormal = c("age", "adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur",
                                      "creat_mean", "creat_peak", "acr"), noSpaces = TRUE, 
                        catDigits = 0, contDigits = 1, pDigits = 3, smd = TRUE)
table_weighted <- as.matrix(table_weighted[, c(2, 1, 5)])
row.names(table_weighted) <- labels
colnames(table_weighted) <- c("Stopped RASi", "Continued RASi", "SMD")

# kable(table_weighted, align = "c", caption = title)

rm(listvar, continuous, catvar, labels, cohort2Svy) 

table1_final <- cbind(table1, table_weighted)

```

#### 2.2.4.3. SMDs for categories before and after weighting
```{r}
stand_diff <- function(pT, pC){
  d <- (pT-pC)/(sqrt((pT*(1-pT)+pC*(1-pC))/2))
  return(d)
}

# Function for calculating SMD
fillSMD <- function(weighted = NULL, row){
  # Determine whether the SMD is for the column of the weighted or unweighted population
  if(is.null(weighted)) stop("Indicate whether the SMD is for the weighted or unweighted population")
  col <- ifelse(weighted == FALSE, 4, 7)
  
  # Retrieve proportion reported in table
  pT <- as.numeric(gsub("[()]", "", str_match(table1_final[row, (col - 2)], "\\(\\d+.*\\d*\\)"))) / 100
  pC <- as.numeric(gsub("[()]", "", str_match(table1_final[row, (col - 1)], "\\(\\d+.*\\d*\\)"))) / 100
  
  # Calculate SMD
  smd <- round(stand_diff(pT, pC), 3)
  smd <- ifelse(smd < 0, smd * (-1), smd)
  smd <- ifelse(smd == 0, "<0.001", smd)
  smd <- ifelse(nchar(smd) == 3, paste(smd, "00", sep = ""), smd)
  smd <- ifelse(nchar(smd) == 4, paste(smd, "0", sep = ""), smd)
  
  # Fill in SMD
  table1_final[row, col] <- smd
  return(table1_final)
}

# Get rownumbers which need a SMD
table_rownumbers <- table1_final
colnames(table_rownumbers) <- c("ovr", "t1", "c2", "smd1", "t2", "c2", "smd2")
table_rows <- as.data.frame(table_rownumbers) %>% dplyr::select(smd1) %>% mutate(rownr = 1:nrow(table1_final)) %>% 
  filter(smd1 == "" & rownr != 1)
rows <- table_rows$rownr

# Fill SMD for each rownumber
for(i in rows){
  table1_final <- fillSMD(weighted = FALSE, row = i)
  table1_final <- fillSMD(weighted = TRUE, row = i)
}

## Start only showing percentages
# Check which data contains means (SD), as these should not have their mean deleted
table_rownumbers <- as.data.frame(table_rownumbers) %>% dplyr::select(ovr, smd1) %>% mutate(rownr = 1:nrow(table1_final))

# Omit rows 115, 116, and 124, in addition to all rows without brackets
rows <- filter(table_rownumbers, !(rownr == 115 | rownr == 116 | rownr == 124) & grepl("[()]", ovr))$rownr

for(c in c(1:3, 5:6)){
  for(i in rows){
    table1_final[i, c] <- gsub("[()]", "", str_match(table1_final[i, c], "\\(\\d+.*\\d*\\)"))
  }
}

# We want only cholesterol, ACR, and potassium to show decimals, so here we round everything
rows <- c(2, 15, 53, 59, 65, 71, 77, 83, 109, 113, 114)

for(c in c(1:3, 5:6)){
  for(i in rows){
    value <- as.character(round(as.numeric(gsub(" \\[\\d+.\\d, \\d+.\\d\\]", "", table1_final[i, c])), digits = 0))
    q1 <- as.character(round(as.numeric(gsub(", \\d+.\\d\\]", "", gsub("\\d+.\\d \\[", "", table1_final[i, c]))), digits = 0))
    q3 <- as.character(round(as.numeric(gsub("\\]", "", gsub("\\d+.\\d \\[\\d+.\\d, ", "", table1_final[i, c]))), digits = 0))
    table1_final[i, c] <- paste(value, " [", q1, ", ", q3, "]", sep = "")
  }
}

kable(table1_final, caption = "Baseline characteristics before and after weighting")

rm(i, c, table_rownumbers, rows)


```


#### 2.2.4.4. Weighted Kaplan Meier curves
```{r include = FALSE}
# Taken from KMunicate source code
# Edouard Fu modified this code (and I modified it some more):
# 1. Legend position: Left upper corner instead of right upper corner if reverse is true
# 2. Legend headings: not 0/1 but Continued/Stopped RASi
# 3. The risk table shows unweighted numbers, but the plot itself is weighted. For this I introduced both fit and fit2 (KMunicate only 
#    specified fit)
# 4. Add specifiable plot title in bold and increase distance to plot
# 5. Removed censored and event rows to only display risk rows
# Removed some annotation to clean up the code, for annotation: https://github.com/ellessenne/KMunicate-package/blob/master/R/KMunicate.R

#' @keywords internal
.fortify <- function(fit) {
  fit <- survival::survfit0(x = fit)
  out <- data.frame(
    time = fit$time,
    n.risk = fit$n.risk,
    n.event = fit$n.event,
    n.censor = fit$n.censor,
    surv = fit$surv,
    lower = fit$lower,
    upper = fit$upper
  )
  if ("strata" %in% names(fit)) {
    out$strata <- rep(names(fit$strata), times = as.numeric(fit$strata))
    out$strata <- factor(out$strata, levels = names(fit$strata), labels = gsub(".*=", "", names(fit$strata)))
  }
  return(out)
}

#' @keywords internal
.fortify_summary <- function(fit2, time_scale, risk_table) {
  summ <- summary(fit2, times = time_scale, extend = TRUE)
  
  d <- data.frame(
    time = summ$time,
    n.risk = summ$n.risk,
    n.event = summ$n.event,
    n.censor = summ$n.censor
  )
  if ("strata" %in% names(fit2)) {
    d$strata <- summ$strata
    d$strata <- factor(d$strata, levels = levels(d$strata), labels = gsub(".*=", "", levels(d$strata)))
  }
  # Use cumulative n.event and n.censor if risk_table == "KMunicate"
  if (risk_table == "KMunicate") {
    if ("strata" %in% names(fit2)) {
      dsplit <- split(x = d, f = d$strata)
    } else {
      dsplit <- list(d)
    }
    dsplit <- lapply(dsplit, function(x) {
      x$n.event <- cumsum(x$n.event)
      x$n.censor <- cumsum(x$n.censor)
      # Solve (for now) inconsistency between n.risk and the rest
      # Trusting n.censor and n.event for now...
      # See (and follow-up) over at:
      # - https://github.com/ellessenne/KMunicate-package/issues/6
      # - https://github.com/therneau/survival/issues/119
      x$n.risk <- max(x$n.risk) - x$n.censor - x$n.event
      x
    })
    d <- do.call(rbind, dsplit)
  }
  
  # Return d
  return(d)
}

KMunicate <- function(fit, fit2, time_scale, .risk_table = "KMunicate", .reverse = FALSE, .theme = NULL, 
                      .color_scale = 
                      scale_color_manual(values = c(rgb(0, 101, 172, maxColorValue = 255), rgb(243, 110, 53, maxColorValue = 255))), 
                      .fill_scale = 
                      scale_fill_manual(values = c(rgb(0, 101, 172, maxColorValue = 255), rgb(243, 110, 53, maxColorValue = 255))),
                      .linetype_scale = NULL, .annotate = NULL, .xlab = "Time", 
                      .ylab = ifelse(.reverse, "Estimated (1 - survival)", "Estimated survival"), .alpha = 0.25, 
                      .rel_heights = NULL, .ff = NULL, .risk_table_base_size = 11, .size = NULL, .legend_position = c(0, 1), title,
                      .ylim, .breaks = 0.25, .zoom = NULL, .xmin_zoom = NULL, .xmax_zoom = NULL, .ymin_zoom = NULL, .ymax_zoom = NULL,
                      .breaks_zoom = 0.05){
  
  ### Check arguments
  arg_checks <- checkmate::makeAssertCollection()
  # 'fit' must be of class 'survfit'
  checkmate::assert_class(x = fit, classes = "survfit", add = arg_checks)
  # 'time_scale' must be a numeric vector
  checkmate::assert_numeric(x = time_scale, add = arg_checks)
  # '.reverse' must be a logical value
  checkmate::assert_logical(x = .reverse, len = 1, add = arg_checks)
  # '.risk_table' must be a vector of strings, can be NULL
  checkmate::assert_string(x = .risk_table, null.ok = TRUE, add = arg_checks)
  # '.risk_table' must have specific values
  if (!is.null(.risk_table)) {
    .risk_table <- match.arg(.risk_table, choices = c("KMunicate", "survfit", NULL))
    checkmate::assert_true(x = .risk_table %in% c("KMunicate", "survfit"), add = arg_checks)
  }
  # '.theme' must be of class 'theme', 'gg' and must pass ggplot2::is.ggtheme()
  checkmate::assert_class(x = .theme, classes = c("theme", "gg"), null.ok = TRUE, add = arg_checks)
  if (!is.null(.theme)) checkmate::assert_true(x = ggplot2::is.theme(.theme), add = arg_checks)
  # '.color_scale', '.fill_scale', '.linetype_scale', '.annotate' must pass ggplot2::is.ggproto()
  if (!is.null(.color_scale)) checkmate::assert_true(x = ggplot2::is.ggproto(.color_scale), add = arg_checks)
  if (!is.null(.fill_scale)) checkmate::assert_true(x = ggplot2::is.ggproto(.fill_scale), add = arg_checks)
  if (!is.null(.linetype_scale)) checkmate::assert_true(x = ggplot2::is.ggproto(.linetype_scale), add = arg_checks)
  if (!is.null(.annotate)) checkmate::assert_true(x = ggplot2::is.ggproto(.annotate), add = arg_checks)
  # '.xlab', '.ylab' must be a string
  checkmate::assert_string(x = .xlab, add = arg_checks)
  checkmate::assert_string(x = .ylab, add = arg_checks)
  # '.alpha' must be a number
  checkmate::assert_number(x = .alpha, add = arg_checks)
  # '.rel_heights' must be a numeric vector or NULL
  checkmate::assert_numeric(x = .rel_heights, null.ok = TRUE, add = arg_checks)
  # '.ff' must be a string or NULL
  checkmate::assert_string(x = .ff, null.ok = TRUE, add = arg_checks)
  # '.risk_table_base_size', '.size' must be a number
  checkmate::assert_number(x = .risk_table_base_size, add = arg_checks)
  checkmate::assert_number(x = .size, null.ok = TRUE, add = arg_checks)
  # '.legend_position' must be a numeric vector of length 2, or a single string "none"
  checkmate::assert_true(x = (is.numeric(.legend_position) & length(.legend_position) == 2) | (is.character(.legend_position) & 
                                                             length(.legend_position) == 1), add = arg_checks)
  # Report
  if (!arg_checks$isEmpty()) checkmate::reportAssertions(arg_checks)
  
  ### Fortify data
  data <- .fortify(fit) %>% mutate(strata = ifelse(strata == 0, "Continued RASi", "Stopped RASi"))
  # If .reverse, use 1 - survival probability
  if(.reverse){
    data$surv <- 1 - data$surv
    data$lower <- 1 - data$lower
    data$upper <- 1 - data$upper
  }
  
  ### Create plot
  ## Main plot
  plot <- ggplot2::ggplot(data, ggplot2::aes(x = time, y = surv, ymin = lower, ymax = upper)) + labs(title = title) + 
    theme(plot.title = element_text(margin = margin(0, 0, 10, 0), face="bold", size = 12, hjust = 0.5))

  if ("strata" %in% names(fit)) {
    plot <- plot + pammtools::geom_stepribbon(ggplot2::aes(fill = strata), alpha = .alpha)
    if (!is.null(.size)) {
      plot <- plot +
        ggplot2::geom_step(ggplot2::aes(color = strata, linetype = strata), size = .size)
    } else {
      plot <- plot +
        ggplot2::geom_step(ggplot2::aes(color = strata, linetype = strata))
    }
  } else {
    if (!is.null(.size)) {
      plot <- plot + pammtools::geom_stepribbon(alpha = .alpha, size = .size)
    } else {
      plot <- plot + pammtools::geom_stepribbon(alpha = .alpha)
    }
    plot <- plot +
      ggplot2::geom_step()
  }
  plot <- plot +
    ggplot2::scale_x_continuous(breaks = time_scale) +
    ggplot2::scale_y_continuous(breaks = seq(0, 1, by = .breaks)) + 
    ggplot2::coord_cartesian(ylim = c(0, 1), xlim = range(time_scale)) +
    ggplot2::labs(color = "", fill = "", linetype = "", x = .xlab, y = .ylab)
  if (!is.null(.theme)) {
    plot <- plot + .theme
  } else if (!is.null(.ff)) {
    plot <- plot + ggplot2::theme_gray(base_family = .ff)
  }
  plot <- plot +
    ggplot2::theme(legend.position = .legend_position, legend.background = ggplot2::element_blank(), legend.key = ggplot2::element_blank(), 
                   plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm")) 
  if (length(.legend_position) > 1) {
    plot <- plot +
      ggplot2::theme(legend.justification = .legend_position)
  }
  if (!is.null(.color_scale)) {
    plot <- plot + .color_scale
  }
  if (!is.null(.fill_scale)) {
    plot <- plot + .fill_scale
  }
  if (!is.null(.linetype_scale)) {
    plot <- plot + .linetype_scale
  }
  if (!is.null(.annotate)) {
    plot <- plot + .annotate
  }
  
  ## Zoom plot
  zoom <- ggplot2::ggplot(data, ggplot2::aes(x = time, y = surv, ymin = lower, ymax = upper))

  if ("strata" %in% names(fit)) {
    zoom <- zoom + pammtools::geom_stepribbon(ggplot2::aes(fill = strata), alpha = .alpha)
    if (!is.null(.size)) {
      zoom <- zoom +
        ggplot2::geom_step(ggplot2::aes(color = strata, linetype = strata), size = .size)
    } else {
      zoom <- zoom +
        ggplot2::geom_step(ggplot2::aes(color = strata, linetype = strata))
    }
  } else {
    if (!is.null(.size)) {
      zoom <- zoom + pammtools::geom_stepribbon(alpha = .alpha, size = .size)
    } else {
      zoom <- zoom + pammtools::geom_stepribbon(alpha = .alpha)
    }
    zoom <- zoom +
      ggplot2::geom_step()
  }
  zoom <- zoom +
    ggplot2::scale_x_continuous(breaks = time_scale) +
    ggplot2::scale_y_continuous(breaks = seq(.ylim[[1]], .ylim[[2]], by = .breaks_zoom)) +
    ggplot2::coord_cartesian(ylim = .ylim, xlim = range(time_scale)) +
    ggplot2::labs(color = "", fill = "", linetype = "", x = "", y = "")
  if (!is.null(.theme)) {
    zoom <- zoom + .theme
  } else if (!is.null(.ff)) {
    zoom <- zoom + ggplot2::theme_gray(base_family = .ff)
  }
  zoom <- zoom +
    ggplot2::theme(legend.position = c(-2, -2), legend.background = ggplot2::element_blank(), legend.key = ggplot2::element_blank(), 
                   plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm")) 
  if (length(.legend_position) > 1) {
    zoom <- zoom +
      ggplot2::theme(legend.justification = .legend_position)
  }
  if (!is.null(.color_scale)) {
    zoom <- zoom + .color_scale
  }
  if (!is.null(.fill_scale)) {
    zoom <- zoom + .fill_scale
  }
  if (!is.null(.linetype_scale)) {
    zoom <- zoom + .linetype_scale
  }
  if (!is.null(.annotate)) {
    zoom <- zoom + .annotate
  }
  
  ### Add plots together if requested
  if (!is.null(.zoom)){
    
  plot <- plot + annotation_custom(grob = ggplotGrob(zoom), xmin = .xmin_zoom, xmax = .xmax_zoom, ymin = .ymin_zoom, ymax = .ymax_zoom)
  
  }
  
  # Create tables if requested
  if (!is.null(.risk_table)) {
    ### Create tables
    table_data <- .fortify_summary(fit2 = fit2, time_scale = time_scale, risk_table = .risk_table) %>%
      dplyr::select(-n.event, -n.censor) %>% arrange(time, strata) %>% relocate(strata, .before = n.risk)
    table_data$strata <- factor(table_data$strata, levels = c(1, 0), labels = c("Stopped RASi   ", "Continued RASi   "))
    
    ### Create table 'plots'
    if (!("strata" %in% names(fit2))) {
      table_data$strata <- "Overall"
    }
    tds <- list(table_data)
    tds <- lapply(seq_along(tds), function(i) {
      p <- ggplot2::ggplot(tds[[i]], ggplot2::aes(x = time, y = strata, label = n.risk))
      if (is.null(.ff)) {
        p <- p + ggplot2::geom_text(size = .risk_table_base_size / 3)
      } else {
        p <- p + ggplot2::geom_text(mapping = ggplot2::aes(family = .ff), size = .risk_table_base_size / 3)
      }
      p <- p +
        ggplot2::scale_x_continuous(breaks = time_scale) +
        ggplot2::coord_cartesian(xlim = range(time_scale)) +
        ggplot2::theme_void(base_size = .risk_table_base_size) +
        ggplot2::theme(plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"))
      if (is.null(.ff)) {
        p <- p + ggplot2::theme(axis.text.y = ggplot2::element_text(face = "plain"),
                                plot.title = ggplot2::element_text(face = "bold"))
      } else {
        p <- p + ggplot2::theme(axis.text.y = ggplot2::element_text(face = "plain", family = .ff), plot.title = 
                 ggplot2::element_text(family = .ff, face = "bold"))
      }
      p <- p +
        ggplot2::labs(title = "At risk")
    })
    
    ### Process relative heights
    if (is.null(.rel_heights)) {
      .rel_heights <- c(3, rep(1, length(tds)))
    }
    
    ### Combine plot and tables
    KMunicate_plot <- cowplot::plot_grid(plotlist = c(list(plot), tds), align = "hv", axis = "tlbr", ncol = 1, rel_heights = .rel_heights)
  } else {
    KMunicate_plot <- plot
  }
  
  ### Return
  return(KMunicate_plot)
}

# Theme function
theme_min <- function(){
    theme(panel.background = element_blank(),
          axis.line.x.bottom = element_line(colour = "black", size = 0.5),
          axis.line.y.left = element_line(colour = "black", size = 0.5),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())
}

# Plotting function
# .zoom_mar function is order of xmin, xmax, ymin, ymax
km_plots <- function(time2event, event, stopping, weights, ylab, title, file,
                     .breaks = 0.25, .zoom = NULL, .ylim = c(0, 0), .zoom_mar = c(0, 0, 0, 0), .breaks_zoom){
  time_scale <- seq(0, max(time2event/365.25), by = 1)
  km_before_weighting <- survfit(Surv((time2event/365.25), event) ~ stopping) 
  km_after_weighting <- survfit(Surv((time2event/365.25), event) ~ stopping, weights = weights)

  KMunicate(fit = km_after_weighting, fit2 = km_before_weighting, time_scale = time_scale, .risk_table = "survfit", 
            .ylab = ylab, .xlab = "Time (years)", .theme = theme_min(), title =  title, 
            .legend_position = c(0, 1.1), .risk_table_base_size = 9, .reverse = TRUE, .breaks = .breaks, .zoom = .zoom,
            .ylim = .ylim, .xmin_zoom = .zoom_mar[[1]], .xmax_zoom = .zoom_mar[[2]], .ymin_zoom = .zoom_mar[[3]], 
            .ymax_zoom = .zoom_mar[[4]], .breaks_zoom = .breaks_zoom)
  
  setwd("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Figures/SA")

  ggsave(file, width = 7, height = 5, dpi = 600)
}

# Start creating plots
# Composite outcome of mortality and MACE
km_plots(cohort2$time2comp, cohort2$event_comp, cohort2$stopping, cohort2$ow, "Absolute risk of death or MACE", 
         "A. Composite outcome of mortality and MACE",
         "km_composite_N17.pdf", .breaks = 0.2)

# Mortality
# To change file type, change extension in the file name (e.g., .pdf to .jpeg), DPI can be changed in the function above.
km_plots(cohort2$time2death, cohort2$event_mort, cohort2$stopping, cohort2$ow, "Absolute risk of death", "A. Mortality",
         "km_mortality_N17.pdf", .breaks = 0.2)

# Recurrent AKI
km_plots(cohort2$time2aki, cohort2$event_aki, cohort2$stopping, cohort2$ow, "Absolute risk of recurrent AKI", "B. Recurrent AKI",
         "km_aki_N17.pdf", .breaks = 0.2, .zoom = TRUE, .ylim = c(0, 0.25), .zoom_mar = c(1.25, 5, 0.25, 1), .breaks_zoom = 0.05)

# Heart failure
km_plots(cohort2$time2hf, cohort2$event_hf, cohort2$stopping, cohort2$ow, "Absolute risk of heart failure hospitalization", 
         "C. Heart failure hospitalization", "km_hf_N17.pdf", .breaks = 0.2)

# End-stage kidney disease
km_plots(cohort2_lab$time2eskd, cohort2_lab$event_eskd, cohort2_lab$stopping, cohort2_lab$ow, "Absolute risk of ESKD", "D. ESKD",
         "km_eskd_N17.pdf", .breaks = 0.2, .zoom = TRUE, .ylim = c(0, 0.15), .zoom_mar = c(1.25, 5, 0.25, 1), .breaks_zoom = 0.05)

# CKD progression
km_plots(cohort2_lab$time2ckd, cohort2_lab$event_ckd, cohort2_lab$stopping, cohort2_lab$ow, "Absolute risk of CKD progression", 
         "E. CKD progression", "km_ckd_N17.pdf", .breaks = 0.2, .zoom = TRUE, .ylim = c(0, 0.25), .zoom_mar = c(1.25, 5, 0.25, 1), 
         .breaks_zoom = 0.05)

# Moderate hyperkalemia
km_plots(cohort2_lab$time2hk_moderate, cohort2_lab$event_hk_moderate, cohort2_lab$stopping, cohort2_lab$ow, 
         "Absolute risk of moderate hyperkalemia", "F. Moderate hyperkalemia", "km_hkmod_N17.pdf", .breaks = 0.2)

# MACE 
km_plots(cohort2$time2mace, cohort2$event_mace, cohort2$stopping, cohort2$ow, "Absolute risk of MACE", "G. MACE",
         "km_mace_N17.pdf", .breaks = 0.2, .zoom = TRUE, .ylim = c(0, 0.25), .zoom_mar = c(1.25, 5, 0.25, 1), .breaks_zoom = 0.05)

``` 

#### 2.2.4.5. Adjusted Cox regression model using overlap weighting adjustment
```{r}
# Weighted Cox models using IPTW
# Function for model
coxweighted <- function(event, time2event, cohort_stopping, cohort_weight){
  cox_weighted <- coxph(Surv(time2event, event) ~ as.factor(cohort_stopping), weights = cohort_weight, robust = TRUE)

   # This code is just used to put the hazard ratios and confidence intervals in a table
  table_weighted <- format(round(cbind(summary(cox_weighted)$coef, exp(confint(cox_weighted))), 2), nsmall = 2) %>% 
    as.data.frame() %>% filter(row_number() == 1) 
  table_weighted <- table_weighted[, c(2, 7:8)] 
  colnames(table_weighted) <- c("HR","lower","upper") 
  
  table_weighted <- as.data.frame(table_weighted) %>% mutate(HR = gsub(pattern = " ", replacement = "", x = HR),
                                                             lHR = nchar(HR),
                                                             HR = ifelse(lHR == 1 | lHR == 2, paste(HR, ".0", sep = ""), HR),
                                                             lower = gsub(pattern = " ", replacement = "", x = lower),
                                                             llower = nchar(lower),
                                                             lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                                             upper = gsub(pattern = " ", replacement = "", x = upper),
                                                             lupper = nchar(upper),
                                                             upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                                             HR = paste(HR, " (", lower, "-", upper,")", sep = ""))  
  table_weighted <- as.data.frame(table_weighted[, 1]) 
  colnames(table_weighted) <- "Overlap Weights Adjusted HR (95% CI)"
  
  table_weighted <- rbind("", "", "1 (Reference)", table_weighted)
  
  return(table_weighted)
}


# Outcomes with overlap weights
cox_weighted_comp <- coxweighted(cohort2$event_comp, cohort2$time2comp, cohort2$stopping, cohort2$ow)
cox_weighted_death <- coxweighted(cohort2$event_mort, cohort2$time2death, cohort2$stopping, cohort2$ow)
cox_weighted_aki <- coxweighted(cohort2$event_aki, cohort2$time2aki, cohort2$stopping, cohort2$ow)
cox_weighted_hf <- coxweighted(cohort2$event_hf, cohort2$time2hf, cohort2$stopping, cohort2$ow)
cox_weighted_eskd <- coxweighted(cohort2_lab$event_eskd, cohort2_lab$time2eskd, cohort2_lab$stopping, cohort2_lab$ow)
cox_weighted_ckd <- coxweighted(cohort2_lab$event_ckd, cohort2_lab$time2ckd, cohort2_lab$stopping, cohort2_lab$ow)
cox_weighted_hkmod <- coxweighted(cohort2_lab$event_hk_moderate, cohort2_lab$time2hk_moderate, cohort2_lab$stopping, cohort2_lab$ow)
cox_weighted_mace <- coxweighted(cohort2$event_mace, cohort2$time2mace, cohort2$stopping, cohort2$ow)

cox_weighted_ow <- rbind(cox_weighted_comp, cox_weighted_death, cox_weighted_aki, cox_weighted_hf, cox_weighted_eskd, 
                         cox_weighted_ckd, cox_weighted_hkmod, cox_weighted_mace)

table2 <- cbind(incidence_table, cox_table_unadjusted, cox_weighted_ow)

kable(table2)

rm(cox_weighted_death, cox_weighted_aki, cox_weighted_hf, cox_weighted_eskd, cox_weighted_ckd, cox_weighted_hkmod,
   cox_weighted_mace, coxweighted, cox_weighted_comp)

```


#### 2.2.4.6. Absolute risks
```{r}
absolute_risks <- function(formula_surv, df, name){
  surv_info <- survfit(as.formula(formula_surv), weights = ow, robust = TRUE, data = df)
  
  # Surv contains absolute risks, std.err contains standard errors. Strata are put below one another.
  surv <- as.data.frame(surv_info$surv)
  std.err <- as.data.frame(surv_info$std.err)

  row0 <- as.numeric(surv_info$strata[[1]])
  row1 <- as.numeric(length(surv$`surv_info$surv`))

  surv0 <- surv[[row0, 1]]
  surv1 <- surv[[row1, 1]]
  se0 <- std.err[[row0, 1]]
  se1 <- std.err[[row1, 1]]

  # Absolute risk & 95% CI continuing at 5 years
  ar0 <- (1 - surv0) * 100
  ll0 <- ((1 - surv0) - (1.96 * se0)) * 100
  ul0 <- ((1 - surv0) + (1.96 * se0)) * 100

  # Absolute risk & 95% CI stopping at 5 years
  ar1 <- (1 - surv1) * 100
  ll1 <- ((1 - surv1) - (1.96 * se1)) * 100
  ul1 <- ((1 - surv1) + (1.96 * se1)) * 100

  # Absolute risk difference at 5 years
  ard <- ((1 - surv1) - (1 - surv0)) * 100
  lld <- (((1 - surv1) - (1 - surv0)) - sqrt((se1 ^ 2) + (se0 ^ 2))) * 100
  uld <- (((1 - surv1) - (1 - surv0)) + sqrt((se1 ^ 2) + (se0 ^ 2))) * 100

  ar <- matrix(0, ncol = 3, nrow = 3)
  colnames(ar) <- c("risk", "lower", "upper")
  rownames(ar) <- c("Continuers", "Stoppers", "Difference")

  ar[[1, 1]] <- round(ar0, digits = 1)
  ar[[1, 2]] <- round(ll0, digits = 1)
  ar[[1, 3]] <- round(ul0, digits = 1)
  ar[[2, 1]] <- round(ar1, digits = 1)
  ar[[2, 2]] <- round(ll1, digits = 1)
  ar[[2, 3]] <- round(ul1, digits = 1)
  ar[[3, 1]] <- round(ard, digits = 1)
  ar[[3, 2]] <- round(lld, digits = 1)
  ar[[3, 3]] <- round(uld, digits = 1)
  
  ar <- as.data.frame(ar) %>% mutate(lrisk = nchar(risk),
                                     risk = ifelse(lrisk == 1 | lrisk == 2, paste(risk, ".0", sep = ""), risk),
                                     llower = nchar(lower),
                                     lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                     lupper = nchar(upper),
                                     upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                     ar_c = paste(as.character(risk), " (", as.character(lower), ", ", as.character(upper), ")", sep = ""))
  ar <- dplyr::select(ar, ar_c)
  colnames(ar) <- name
  
  return(as.data.frame(ar))
}

ar_comp <- absolute_risks(Surv(time2comp, event_comp) ~ as.factor(stopping), df = cohort2, "Composite outcome")
ar_mort <- absolute_risks(Surv(time2death, event_mort) ~ as.factor(stopping), df = cohort2, "Mortality")
ar_aki <- absolute_risks(Surv(time2aki, event_aki) ~ as.factor(stopping), df = cohort2, "Recurrent AKI")
ar_hf <- absolute_risks(Surv(time2hf, event_hf) ~ as.factor(stopping), df = cohort2, "Heart failure")
ar_eskd <- absolute_risks(Surv(time2eskd, event_eskd) ~ as.factor(stopping), df = cohort2_lab, "End-stage kidney disease")
ar_ckd <- absolute_risks(Surv(time2ckd, event_ckd) ~ as.factor(stopping), df = cohort2_lab, "CKD progression")
ar_hkmod <- absolute_risks(Surv(time2hk_moderate, event_hk_moderate) ~ as.factor(stopping), df = cohort2_lab, "Moderate hyperkalemia")
ar_mace <- absolute_risks(Surv(time2mace, event_mace) ~ as.factor(stopping), df = cohort2, "MACE")

ar_table <- cbind(ar_comp, ar_mort, ar_aki, ar_hf, ar_eskd, ar_ckd, ar_hkmod, ar_mace)

kable(ar_table, caption = "Absolute risks (95% CI) and absolute risk difference (95% CI)")

```


### 2.2.5. Landmark figure
```{r}
## 5 years
# Load unlandmarked cohort and medication database
load("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/cohort2.Rdata")
load("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/meds_c2.Rdata")

meds_rasi <- meds %>% filter(grepl("^C09A|^C09B|^C09C|^C09D", atc))

# Transform data
landmark_plot_data <- cohort2 %>% left_join(meds_rasi, "lopnr") %>%
  filter(edatum > dis_dt) %>%
  arrange(lopnr, edatum) %>% group_by(lopnr) %>% slice(1L) %>% ungroup() %>%
  mutate(time = as.numeric(edatum - dis_dt)) %>%
  filter(time <= (365.25 * 5)) %>%
  mutate(month = cut(time, c(seq(0, 1800, by = 30)), right = FALSE, labels = FALSE)) %>% 
  arrange(month) %>% group_by(month) %>%
  mutate(ind = 1,
         time_freq = sum(ind)) %>%
  slice(1L) %>% ungroup() %>%
  mutate(cum_time_freq = cumsum(time_freq)) %>%
  dplyr::select(month, time_freq, cum_time_freq)

landmark_plot_data <- rbind(landmark_plot_data, data.frame(month = 0, time_freq =  0, cum_time_freq = 0)) %>% arrange(month)

for(i in 1:60){
  x <- nrow(filter(landmark_plot_data, month == i))
  if(x == 1){
    landmark_plot_data <- landmark_plot_data
  } else {
    y <- filter(landmark_plot_data, month == (i - 1))
    placeholder <- as.data.frame(transpose(as.data.frame(c(i, 0, y$cum_time_freq))))
    colnames(placeholder) <- c("month", "time_freq", "cum_time_freq")
    landmark_plot_data <- rbind(landmark_plot_data, placeholder) %>% arrange(month)
  }
} 

# Theme for plot
theme_min <- function(){
    theme(panel.background = element_rect(fill = "white", colour = "black", size = 0.5),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(margin = margin(0, 0, 10, 0), face= "bold", size = 12, hjust = 0.5))
}

ggplot(landmark_plot_data, aes(x = month, y = cum_time_freq, label = cum_time_freq)) + 
  geom_line() + geom_point() + scale_y_continuous(expand = expansion(mult = c(0, .1))) +
  xlab("Time (Months)") + ylab("Cumulative count") + scale_x_continuous(breaks = seq(0, 60, 3), expand = c(0, 0)) +
  theme_min() + geom_vline(xintercept = 3, linetype = "dashed", alpha = 0.5) + 
  ggtitle("Cumulative count of first RASi dispensation after discharge")

setwd("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Figures/SA")

ggsave("landmark_plot5y_sa_c2.pdf", width = 8, height = 5, dpi = 600)

## 1 year
# Load unlandmarked cohort and medication database
load("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/cohort2.Rdata")
load("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/meds_c2.Rdata")

# Transform data
landmark_plot_data <- cohort2 %>% left_join(meds_rasi, "lopnr") %>%
  filter(edatum > dis_dt) %>%
  arrange(lopnr, edatum) %>% group_by(lopnr) %>% slice(1L) %>% ungroup() %>%
  mutate(time = as.numeric(edatum - dis_dt)) %>%
  filter(time <= 365.25) %>%
  mutate(month = cut(time, c(seq(0, 360, by = 30)), right = FALSE, labels = FALSE)) %>% 
  arrange(month) %>% group_by(month) %>%
  mutate(ind = 1,
         time_freq = sum(ind)) %>%
  slice(1L) %>% ungroup() %>%
  mutate(cum_time_freq = cumsum(time_freq)) %>%
  dplyr::select(month, time_freq, cum_time_freq)

landmark_plot_data <- rbind(landmark_plot_data, data.frame(month = 0, time_freq =  0, cum_time_freq = 0)) %>% arrange(month)

for(i in 1:12){
  x <- nrow(filter(landmark_plot_data, month == i))
  if(x == 1){
    landmark_plot_data <- landmark_plot_data
  } else {
    y <- filter(landmark_plot_data, month == (i - 1))
    placeholder <- as.data.frame(transpose(as.data.frame(c(i, 0, y$cum_time_freq))))
    colnames(placeholder) <- c("month", "time_freq", "cum_time_freq")
    landmark_plot_data <- rbind(landmark_plot_data, placeholder) %>% arrange(month)
  }
} 

# Theme for plot
theme_min <- function(){
    theme(panel.background = element_rect(fill = "white", colour = "black", size = 0.5),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(margin = margin(0, 0, 10, 0), face= "bold", size = 12, hjust = 0.5))
}

ggplot(landmark_plot_data, aes(x = month, y = cum_time_freq, label = cum_time_freq)) + 
  geom_line() + geom_point() + scale_y_continuous(expand = expansion(mult = c(0, .1))) +
  xlab("Time (Months)") + ylab("Cumulative count") + scale_x_continuous(breaks = seq(0, 12, 1), expand = c(0, 0)) +
  theme_min() + geom_vline(xintercept = 3, linetype = "dashed", alpha = 0.5) + 
  ggtitle("Cumulative count of first RASi dispensation after discharge in the first year")

setwd("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Figures/SA")

ggsave("landmark_plot1y_sa_c2.pdf", width = 8, height = 5, dpi = 600)

```

## 2.3. Landmark at 6 months instead of 3 months
### 2.3.0. Get data
```{r}
load("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/sa_population6months.Rdata")

sa_cohort <- filter(sa_population6months, cohort == 1)
sa_cohort_lab <- filter(sa_cohort, lab_outcome == 1)

```


### 2.3.1. Baseline characteristics
```{r include=FALSE}
# This code is used to make the baseline table. We will do this before and after the propensity score weighting

# Specify which variables in the dataset you want to include in the baseline table
listvar <- c("age", "age_cat", "female", "educ_cat", "adm_egfr", "adm_egfr_cat", "comorb_dm", "comorb_ht", "comorb_mi", "comorb_arr",
             "comorb_cd", "comorb_pvd", "comorb_ihd", "comorb_copd", "comorb_ca", "comorb_ld",  "comorb_chf", "comorb_dl", "comorb_hyth", 
             "comorb_eh", "comorb_vhd", "med_bb", "med_ccb", "med_ld", "med_td", "med_pd", "med_nsaid", "med_al", "med_ab",  "med_nt", 
             "med_ara", "med_hl", "med_aa", "med_dx", "med_ac", "med_dm", "med_op", "kontakt_all", "kontakt_all_cat", "kontakt_cv",
             "kontakt_cv_cat", "ovr_all", "ovr_all_cat", "ovr_cv", "ovr_cv_cat", "slv_all", "slv_all_cat", "slv_cv", "slv_cv_cat", 
             "hosp_cv", "hosp_rs", "hosp_gi", "hosp_id", "hosp_ca", "hosp_op", "hosp_hm", "hosp_gu", "hosp_ip", 
             "hosp_ns", "hosp_hk", "hosp_od", "pc_sp", "pc_cs", "pc_cc", "pc_ar", "pc_pn", "pc_lf", "pc_mi", "pc_ns", "dur", "AKI_acoa", 
             "crit_type", "AcutDial", "creat_mean", "creat_peak", "potass_mean", "potass_peak", "acr", "acr_cat", "chol") 

# specify which variables are continuous
continuous <- c("age","adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur", "creat_mean", 
                "creat_peak", "potass_mean", "potass_peak", "acr", "chol") 

catvar <- listvar[!listvar %in% continuous] # specify that all other variables except the ones specified previously are categorical

# Give labels to the variables
labels <- c("Number of individuals",
            "Median age (IQR) (years)", 
            "Age category (years)", "< 50", "50-59", "60-69", "70-79", "> 80",
            "Female", 
            "Highest level of education achieved", "Compulsory school", "Secondary school", "University", "Missing",
            "Median eGFR before admission (IQR) (ml/min/1.73 m2)",
            "CKD categories", "G1", "G2", "G3a", "G3b", "G4",
            "Diabetes mellitus",
            "Hypertension",
            "Myocardial infarction",
            "Arrythmia",
            "Cerebrovascular disease",
            "Peripheral vascular disease",
            "Ischemic heart disease",
            "Chronic obstructive pulmonary disease",
            "Cancer",
            "Liver disease",
            "Chronic heart failure",
            "Dyslipidemia",
            "Hypothyroidism",
            "Extracranial hemorrhage",
            "Valvular heart disease",
            "Beta blockers",
            "Calcium channel blockers",
            "Loop diuretics",
            "Thiazide diuretics",
            "Potassium-sparing diuretics",
            "NSAIDs",
            "Antilipids",
            "Alpha blockers",
            "Nitrate",
            "MRAs",
            "Hydralazine",
            "Antiarrythmics",
            "Digoxin",
            "Anticoagulants",
            "Diabetes medication",
            "Opioids",
            "Median primary care context contacts (IQR)",
            "Amount of primary care contex contacts", "Zero", "One", "Two", "Three or more",
            "Cardiovascular primary care context contacts (IQR)",
            "Amount of cardiovascular primary care contex contacts", "Zero", "One", "Two", "Three or more",
            "Median specialist care context contacts (IQR)",
            "Amount of specialist care contex contacts", "Zero", "One", "Two", "Three or more",
            "Median cardiovascular specialist context care contacts (IQR)",
            "Amount of cardiovascular specialist care contex contacts", "Zero", "One", "Two", "Three or more",
            "Median number of hospitalizations (IQR)",
            "Amount of hospitalizations", "Zero", "One", "Two", "Three or more",
            "Median number of cardiovascular hospitalizations (IQR)",
            "Amount of cardiovascular hospitalizations", "Zero", "One", "Two", "Three or more",
            "Cardiovascular disease",
            "Respiratory disease",
            "Gastrointestinal, metabolic, and endocrine disease",
            "Infectious disease",
            "Cancer",
            "Musculoskeletal and connective tissue disease",
            "Hematologic disease",
            "Genitourinary disease",
            "Injury or poisoning",
            "Neurological disease",
            "Hyperkalemia",
            "Other disease",
            "Sepsis",
            "Cardiac surgery",
            "Cardiac catherization",
            "Abdominal aortic aneurysm repair",
            "Pneumonia",
            "Liver failure",
            "Acute myocardial infarction",
            "Non-cardiac surgery",
            "Median duration of stay (IQR) (days)",
            "AKI as cause of admission",
            "Stage of AKI KDIGO", "N17", "Stage II", "Stage III",
            "Need for acute dialysis",
            "Median of average creatinine during hospitalization (IQR) (umol/L)",
            "Median of peak creatinine during hospitalization (IQR) (umol/L)",
            "Mean potassium (mmol/L)",
            "Peak potassium (mmol/L)",
            "Albumin-creatinine ratio (mg/mmol)",
            "Albumin-creatinine ratio categories", "< 3", "3-29", "30-69", "> 70", "Missing",
            "Total cholesterol (mmol/L)") 

# Makes overall baseline table
# For more information what is specified here, please see:
# https://www.rdocumentation.org/packages/tableone/versions/0.12.0/topics/CreateTableOne 
# https://www.rdocumentation.org/packages/tableone/versions/0.12.0/topics/print.TableOne
table_overall <- CreateTableOne(vars = listvar, data = sa_cohort, factorVars = catvar) # 
table_overall <- print(table_overall, printToggle = FALSE, noSpaces = TRUE, catDigits = 0, contDigits = 1, pDigits = 3,
                       nonnormal = c("age", "adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur",
                                     "creat_mean", "creat_peak", "acr")) 
table_overall <- as.matrix(table_overall)
row.names(table_overall) <- labels

# Makes baseline table stratified by treatment level
table_stratified <- CreateTableOne(vars = listvar, data = sa_cohort, factorVars = catvar, smd = TRUE, strata = "stopping")
table_stratified <- print(table_stratified, printToggle = FALSE, noSpaces = TRUE, catDigits = 0, contDigits = 1, pDigits = 3,
                          nonnormal = c("age", "adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur",
                                        "creat_mean", "creat_peak", "acr"), smd = TRUE) 
table_stratified <- as.matrix(table_stratified[, c(2, 1, 5)])
row.names(table_stratified) <- labels

# Combine tables and add notes
table1 <- cbind(table_overall,table_stratified) 
colnames(table1) <- c("Overall","Stopped RASi","Continued RASi","SMD")

# remove objects
rm(listvar, continuous, catvar, labels, table_overall, table_stratified)

```


### 2.3.2. Total number of events, person years, and incidence rates
```{r include=FALSE}
# This is a piece of code to get the overall incidence of the outcome (not stratified by treatment)
incid_num_ovr <- function(outcome, time2outcome, cohort){
  incid_ovr <- survRate(Surv((time2outcome / (365.25 * 100)), outcome) ~ 0) %>%
    mutate(tstop = tstop * 100) %>% mutate_at(vars(rate, lower, upper), funs(round(., 1))) %>% mutate_at(vars(tstop), funs(round(., 0)))
  incid_ovr <- as.data.frame(incid_ovr) %>% mutate(rate = gsub(pattern = " ", replacement = "", x = rate),
                                                   lrate = nchar(rate),
                                                   rate = ifelse(lrate == 1 | lrate == 2, paste(rate, ".0", sep = ""), rate),
                                                   lower = gsub(pattern = " ", replacement = "", x = lower),
                                                   llower = nchar(lower),
                                                   lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                                   upper = gsub(pattern = " ", replacement = "", x = upper),
                                                   lupper = nchar(upper),
                                                   upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                                   rate = paste(rate, " (", lower, "-", upper,")", sep = ""))
  incid_ovr <- incid_ovr[, 1:4] %>% dplyr::select(event, tstop, rate) %>% 
    mutate(n = nrow(cohort)) %>% relocate(n, .before = event)
  return(incid_ovr)
}

# This is a piece of code to get the incidence stratified by treatment
incid_num_str <- function(outcome, time2outcome, cohort_stopping, cohort){
  ir <- survRate(Surv((time2outcome / (365.25 * 100)), outcome) ~ cohort_stopping) %>% 
    mutate(tstop = tstop * 100) %>% mutate_at(vars(rate, lower, upper), funs(round(., 1))) %>% mutate_at(vars(tstop), funs(round(., 0)))
  ir <- as.data.frame(ir) %>% mutate(rate = gsub(pattern = " ", replacement = "", x = rate),
                                     lrate = nchar(rate),
                                     rate = ifelse(lrate == 1 | lrate == 2, paste(rate, ".0", sep = ""), rate),
                                     lower = gsub(pattern = " ", replacement = "", x = lower),
                                     llower = nchar(lower),
                                     lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                     upper = gsub(pattern = " ", replacement = "", x = upper),
                                     lupper = nchar(upper),
                                     upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                     rate = paste(rate, " (", lower, "-", upper,")", sep = "")) 
  ir <- ir[, 2:4] %>% dplyr::select(event, tstop, rate)
  x <- as.data.frame(count(cohort, stopping))
  n <- rbind(x$n[[1]], x$n[[2]])
  ir <- cbind(n, ir)
  return(ir)
}


# Incidence table function
inctab <- function(event, time2event, cohort_stopping, cohort){
  incid_overall <- incid_num_ovr(event, time2event, cohort)
  colnames(incid_overall) <- c("N", "Events","py","Incidence rate per 100 py")
  rownames(incid_overall) <- c("Overall")
  
  incid_stratified <- incid_num_str(event, time2event, cohort_stopping, cohort)
  colnames(incid_stratified) <- c("N", "Events","py","Incidence rate per 100 py")
  rownames(incid_stratified) <- c("Continued RASi","Stopped RASi")
  
  incidence_table <- as.matrix(rbind(incid_overall, incid_stratified))
  return(incidence_table)
}

# Title function
tabtitle <- function(titlename){
  title <- transpose(as.data.frame(c("", "", "", "")))
  colnames(title) <- c("N", "Events","py","Incidence rate per 100 py")
  rownames(title) <- c(titlename)
  return(title)
}

# Outcomes
title_comp <- tabtitle("Composite")
incidence_table_comp <- inctab(sa_cohort$event_comp, sa_cohort$time2comp, sa_cohort$stopping, sa_cohort)
title_death <- tabtitle("Mortality")
incidence_table_death <- inctab(sa_cohort$event_mort, sa_cohort$time2death, sa_cohort$stopping, sa_cohort)
title_aki <- tabtitle("Recurrent AKI")
incidence_table_aki <- inctab(sa_cohort$event_aki, sa_cohort$time2aki, sa_cohort$stopping, sa_cohort)
title_hf <- tabtitle("Heart failure hospitalisation")
incidence_table_hf <- inctab(sa_cohort$event_hf, sa_cohort$time2hf, sa_cohort$stopping, sa_cohort)
title_eskd <- tabtitle("ESKD")
incidence_table_eskd <- inctab(sa_cohort_lab$event_eskd, sa_cohort_lab$time2eskd, sa_cohort_lab$stopping, sa_cohort_lab)
title_ckd <- tabtitle("CKD progression")
incidence_table_ckd <- inctab(sa_cohort_lab$event_ckd, sa_cohort_lab$time2ckd, sa_cohort_lab$stopping, sa_cohort_lab)
title_hkmod <- tabtitle("Moderate hyperkalemia")
incidence_table_hkmod <- inctab(sa_cohort_lab$event_hk_moderate, sa_cohort_lab$time2hk_moderate, sa_cohort_lab$stopping, sa_cohort_lab)
title_mace <- tabtitle("MACE")
incidence_table_mace <- inctab(sa_cohort$event_mace, sa_cohort$time2mace, sa_cohort$stopping, sa_cohort)

incidence_table <- as.matrix(rbind(title_comp, incidence_table_comp, title_death, incidence_table_death, title_aki, incidence_table_aki, 
                                   title_hf, incidence_table_hf, title_eskd, incidence_table_eskd, title_ckd, incidence_table_ckd, 
                                   title_hkmod, incidence_table_hkmod, title_mace, incidence_table_mace))
kable(incidence_table)

rm(incid_num_ovr, incid_num_str, inctab, tabtitle, title_death, incidence_table_death, title_aki, incidence_table_aki, title_hf, 
   incidence_table_hf, title_eskd, incidence_table_eskd, title_ckd, incidence_table_ckd, title_hkmod, 
   incidence_table_hkmod, title_mace, incidence_table_mace, title_comp, incidence_table_comp)
```


### 2.3.3. Unadjusted Cox regression model
```{r include=FALSE}
# Unadjusted Cox model with univariabele regression
# Function to create model and table
coxunadjusted <- function(event, time2event, cohort_stopping){
  cox_unadjusted <- coxph(Surv(time2event, event) ~ as.factor(cohort_stopping)) 
  dat <- summary(cox_unadjusted) # outputs coefficients of unadjusted Cox model and HR's with confidence intervals
  
  # This code is just used to put the hazard ratios and confidence intervals in a table
  table_unadj <- format(round(cbind(dat$coef, exp(confint(cox_unadjusted))),2), nsmall = 2) %>% as.data.frame() %>%
    filter(row_number() == 1) 
  table_unadj <- table_unadj[, c(2, 6:7)] 
  colnames(table_unadj) <- c("HR","lower","upper") 

  table_unadj <- as.data.frame(table_unadj) %>% mutate(HR = gsub(pattern = " ", replacement = "", x = HR),
                                                       lHR = nchar(HR),
                                                       HR = ifelse(lHR == 1 | lHR == 2, paste(HR, ".0", sep = ""), HR),
                                                       lower = gsub(pattern = " ", replacement = "", x = lower),
                                                       llower = nchar(lower),
                                                       lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                                       upper = gsub(pattern = " ", replacement = "", x = upper),
                                                       lupper = nchar(upper),
                                                       upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                                       HR = paste(HR, " (", lower, "-", upper,")", sep = "")) 
  table_unadj <- as.data.frame(table_unadj[, 1])  
  colnames(table_unadj) <- "Crude HR (95% CI)"
  return(table_unadj)
}

# Outcomes
table_unadj_comp <- rbind("", "", "1 (Reference)", coxunadjusted(sa_cohort$event_comp, sa_cohort$time2comp, sa_cohort$stopping))
table_unadj_death <- rbind("", "", "1 (Reference)", coxunadjusted(sa_cohort$event_mort, sa_cohort$time2death, sa_cohort$stopping))
table_unadj_aki <- rbind("", "", "1 (Reference)", coxunadjusted(sa_cohort$event_aki, sa_cohort$time2aki, sa_cohort$stopping))
table_unadj_hf <- rbind("", "", "1 (Reference)", coxunadjusted(sa_cohort$event_hf, sa_cohort$time2hf, sa_cohort$stopping))
table_unadj_eskd <- rbind("", "", "1 (Reference)", coxunadjusted(sa_cohort_lab$event_eskd, sa_cohort_lab$time2eskd, sa_cohort_lab$stopping))
table_unadj_ckd <- rbind("", "", "1 (Reference)", coxunadjusted(sa_cohort_lab$event_ckd, sa_cohort_lab$time2ckd, sa_cohort_lab$stopping))
table_unadj_hkmod <- rbind("", "", "1 (Reference)", coxunadjusted(sa_cohort_lab$event_hk_moderate, sa_cohort_lab$time2hk_moderate, 
                                                                  sa_cohort_lab$stopping))
table_unadj_mace <- rbind("", "", "1 (Reference)", coxunadjusted(sa_cohort$event_mace, sa_cohort$time2mace, sa_cohort$stopping))

cox_table_unadjusted <- rbind(table_unadj_comp, table_unadj_death, table_unadj_aki, table_unadj_hf, table_unadj_eskd, table_unadj_ckd,
                              table_unadj_hkmod, table_unadj_mace)

rm(coxunadjusted, table_unadj_death, table_unadj_aki, table_unadj_hf, table_unadj_eskd, table_unadj_ckd, 
   table_unadj_hkmod, table_unadj_mace, table_unadj_comp)

```


### 2.3.4. Weighting
#### 2.3.4.1. Estimating overlap weights
```{r}
### Normal cohort
## Create propensity score (needed for denominator): chance of receiving treatment given covariates
# Create linear regression using covariates
denom.fit <- glm(stopping ~ age + age_cat + female + educ_cat + adm_egfr + adm_egfr_cat + comorb_dm + comorb_ht + comorb_mi + comorb_arr +
                 comorb_cd + comorb_pvd + comorb_ihd + comorb_copd + comorb_ca + comorb_ld + comorb_chf + comorb_dl + comorb_hyth + 
                 comorb_eh + comorb_vhd + med_bb + med_ccb + med_ld + med_td + med_pd + med_nsaid + med_al + med_ab + med_nt + med_ara + 
                 med_hl + med_aa + med_dx + med_ac + med_dm + med_op + kontakt_all + kontakt_cv + slv_all + slv_cv + ovr_all + ovr_cv + 
                 kontakt_all_cat + kontakt_cv_cat + slv_all_cat + slv_cv_cat + ovr_all_cat + ovr_cv_cat + hosp_cv + hosp_rs + hosp_gi + 
                 hosp_id + hosp_ca + hosp_op + hosp_hm + hosp_gu + hosp_ip + hosp_ns + hosp_hk + hosp_od + 
                 pc_sp + pc_cs + pc_cc + pc_ar + pc_pn + pc_lf + pc_mi + pc_ns + dur + AKI_acoa + crit_type + AcutDial + creat_mean +
                 creat_peak, family = binomial(), data = sa_cohort)

# Fill in regression formula per person to create propensity score
pred_denom <- predict(denom.fit, type = "response")

# Add propensity score to dataframe
sa_cohort$ps <- pred_denom
normalize0 <- sum(sa_cohort$ps[which(sa_cohort$stopping == 0)])
normalize1 <- sum(sa_cohort$ps[which(sa_cohort$stopping == 1)])

# Calculating overlap weights
# Weighted pseudopopulation will be as large as original population
sa_cohort$ow <- ifelse(sa_cohort$stopping == 0, pred_denom / normalize0,  (1 - pred_denom) / normalize1)
summary(sa_cohort$ow)

### Lab cohort
## Create propensity score (needed for denominator): chance of receiving treatment given covariates
# Create linear regression using covariates
denom.fit <- glm(stopping ~ age + age_cat + female + educ_cat + adm_egfr + adm_egfr_cat + comorb_dm + comorb_ht + comorb_mi + comorb_arr +
                 comorb_cd + comorb_pvd + comorb_ihd + comorb_copd + comorb_ca + comorb_ld + comorb_chf + comorb_dl + comorb_hyth + 
                 comorb_eh + comorb_vhd + med_bb + med_ccb + med_ld + med_td + med_pd + med_nsaid + med_al + med_ab + med_nt + med_ara + 
                 med_hl + med_aa + med_dx + med_ac + med_dm + med_op + kontakt_all + kontakt_cv + slv_all + slv_cv + ovr_all + ovr_cv + 
                 kontakt_all_cat + kontakt_cv_cat + slv_all_cat + slv_cv_cat + ovr_all_cat + ovr_cv_cat + hosp_cv + hosp_rs + hosp_gi + 
                 hosp_id + hosp_ca + hosp_op + hosp_hm + hosp_gu + hosp_ip + hosp_ns + hosp_hk + hosp_od + pc_sp + pc_cs + pc_cc + pc_ar + 
                 pc_pn + pc_lf + pc_mi + pc_ns + dur + AKI_acoa + crit_type + AcutDial + creat_mean + creat_peak, family = binomial(), 
                 data = sa_cohort_lab)

# Fill in regression formula per person to create propensity score
pred_denom <- predict(denom.fit, type = "response")

# Add propensity score to dataframe
sa_cohort_lab$ps <- pred_denom
normalize0 <- sum(sa_cohort_lab$ps[which(sa_cohort_lab$stopping == 0)])
normalize1 <- sum(sa_cohort_lab$ps[which(sa_cohort_lab$stopping == 1)])

# Calculating overlap weights
# Weighted pseudopopulation will be as large as original population
sa_cohort_lab$ow <- ifelse(sa_cohort_lab$stopping == 0, pred_denom / normalize0,  (1 - pred_denom) / normalize1)
summary(sa_cohort_lab$ow)

```

#### 2.3.4.2. Baseline characteristics after weighting
```{r}
# Create a weighted survey design object
sa_cohortSvy <- svydesign(ids = ~ lopnr, weights = ~ ow, data = sa_cohort)

# Specify which variables in the dataset you want to include in the baseline table
listvar <- c("age", "age_cat", "female", "educ_cat", "adm_egfr", "adm_egfr_cat", "comorb_dm", "comorb_ht", "comorb_mi", "comorb_arr",
             "comorb_cd", "comorb_pvd", "comorb_ihd", "comorb_copd", "comorb_ca", "comorb_ld",  "comorb_chf", "comorb_dl", "comorb_hyth", 
             "comorb_eh", "comorb_vhd", "med_bb", "med_ccb", "med_ld", "med_td", "med_pd", "med_nsaid", "med_al", "med_ab",  "med_nt", 
             "med_ara", "med_hl", "med_aa", "med_dx", "med_ac", "med_dm", "med_op", "kontakt_all", "kontakt_all_cat", "kontakt_cv",
             "kontakt_cv_cat", "ovr_all", "ovr_all_cat", "ovr_cv", "ovr_cv_cat", "slv_all", "slv_all_cat", "slv_cv", "slv_cv_cat", 
             "hosp_cv", "hosp_rs", "hosp_gi", "hosp_id", "hosp_ca", "hosp_op", "hosp_hm", "hosp_gu", "hosp_ip", 
             "hosp_ns", "hosp_hk", "hosp_od", "pc_sp", "pc_cs", "pc_cc", "pc_ar", "pc_pn", "pc_lf", "pc_mi", "pc_ns", "dur", "AKI_acoa", 
             "crit_type", "AcutDial", "creat_mean", "creat_peak", "potass_mean", "potass_peak", "acr", "acr_cat", "chol") 

# specify which variables are continuous
continuous <- c("age","adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur", "creat_mean", 
                  "creat_peak", "potass_mean", "potass_peak", "acr", "chol") 

catvar <- listvar[!listvar %in% continuous] # specify that all other variables except the ones specified previously are categorical

# Give labels to the variables
  labels <- c("Number of individuals",
              "Median age (IQR) (years)", 
              "Age category (years)", "< 50", "50-59", "60-69", "70-79", "> 80",
              "Female", 
              "Highest level of education achieved", "Compulsory school", "Secondary school", "University", "Missing", 
              "Median eGFR before admission (IQR) (ml/min/1.73 m2)",
              "CKD categories", "G1", "G2", "G3a", "G3b", "G4",
              "Diabetes mellitus",
              "Hypertension",
              "Myocardial infarction",
              "Arrythmia",
              "Cerebrovascular disease",
              "Peripheral vascular disease",
              "Ischemic heart disease",
              "Chronic obstructive pulmonary disease",
              "Cancer",
              "Liver disease",
              "Chronic heart failure",
              "Dyslipidemia",
              "Hypothyroidism",
              "Extracranial hemorrhage",
              "Valvular heart disease",
              "Beta blockers",
              "Calcium channel blockers",
              "Loop diuretics",
              "Thiazide diuretics",
              "Potassium-sparing diuretics",
              "NSAIDs",
              "Antilipids",
              "Alpha blockers",
              "Nitrate",
              "MRAs",
              "Hydralazine",
              "Antiarrythmics",
              "Digoxin",
              "Anticoagulants",
              "Diabetes medication",
              "Opioids",
              "Median primary care context contacts (IQR)",
              "Amount of primary care contex contacts", "Zero", "One", "Two", "Three or more",
              "Cardiovascular primary care context contacts (IQR)",
              "Amount of cardiovascular primary care contex contacts", "Zero", "One", "Two", "Three or more",
              "Median specialist care context contacts (IQR)",
              "Amount of specialist care contex contacts", "Zero", "One", "Two", "Three or more",
              "Median cardiovascular specialist context care contacts (IQR)",
              "Amount of cardiovascular specialist care contex contacts", "Zero", "One", "Two", "Three or more",
              "Median number of hospitalizations (IQR)",
              "Amount of hospitalizations", "Zero", "One", "Two", "Three or more",
              "Median number of cardiovascular hospitalizations (IQR)",
              "Amount of cardiovascular hospitalizations", "Zero", "One", "Two", "Three or more",
              "Cardiovascular disease",
              "Respiratory disease",
              "Gastrointestinal, metabolic, and endocrine disease",
              "Infectious disease",
              "Cancer",
              "Musculoskeletal and connective tissue disease",
              "Hematologic disease",
              "Genitourinary disease",
              "Injury or poisoning",
              "Neurological disease",
              "Hyperkalemia",
              "Other disease",
              "Sepsis",
              "Cardiac surgery",
              "Cardiac catherization",
              "Abdominal aortic aneurysm repair",
              "Pneumonia",
              "Liver failure",
              "Acute myocardial infarction",
              "Non-cardiac surgery",
              "Median duration of stay (IQR) (days)",
              "AKI as cause of admission",
              "Stage of AKI KDIGO", "N17", "Stage II", "Stage III",
              "Need for acute dialysis",
              "Median of average creatinine during hospitalization (IQR) (umol/L)",
              "Median of peak creatinine during hospitalization (IQR) (umol/L)",
              "Mean potassium (mmol/L)",
              "Peak potassium (mmol/L)",
              "Albumin-creatinine ratio (mg/mmol)",
              "Albumin-creatinine ratio categories", "< 3", "3-29", "30-69", "> 70", "Missing",
              "Total cholesterol (mmol/L)")  

# Characteristics stratified by treatment group
table_weighted <- svyCreateTableOne(vars = listvar, data = sa_cohortSvy, factorVars = catvar, strata = "stopping")
table_weighted <- print(table_weighted, printToggle = FALSE, 
                        nonnormal = c("age", "adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur",
                                      "creat_mean", "creat_peak", "acr"), noSpaces = TRUE, 
                        catDigits = 0, contDigits = 1, pDigits = 3, smd = TRUE)
table_weighted <- as.matrix(table_weighted[, c(2, 1, 5)])
row.names(table_weighted) <- labels
colnames(table_weighted) <- c("Stopped RASi", "Continued RASi", "SMD")

# kable(table_weighted, align = "c", caption = title)

rm(listvar, continuous, catvar, labels, sa_cohortSvy) 

table1_final <- cbind(table1, table_weighted)

```

#### 2.3.4.3. SMDs for categories before and after weighting
```{r}
stand_diff <- function(pT, pC){
  d <- (pT-pC)/(sqrt((pT*(1-pT)+pC*(1-pC))/2))
  return(d)
}

# Function for calculating SMD
fillSMD <- function(weighted = NULL, row){
  # Determine whether the SMD is for the column of the weighted or unweighted population
  if(is.null(weighted)) stop("Indicate whether the SMD is for the weighted or unweighted population")
  col <- ifelse(weighted == FALSE, 4, 7)
  
  # Retrieve proportion reported in table
  pT <- as.numeric(gsub("[()]", "", str_match(table1_final[row, (col - 2)], "\\(\\d+.*\\d*\\)"))) / 100
  pC <- as.numeric(gsub("[()]", "", str_match(table1_final[row, (col - 1)], "\\(\\d+.*\\d*\\)"))) / 100
  
  # Calculate SMD
  smd <- round(stand_diff(pT, pC), 3)
  smd <- ifelse(smd < 0, smd * (-1), smd)
  smd <- ifelse(smd == 0, "<0.001", smd)
  smd <- ifelse(nchar(smd) == 3, paste(smd, "00", sep = ""), smd)
  smd <- ifelse(nchar(smd) == 4, paste(smd, "0", sep = ""), smd)
  
  # Fill in SMD
  table1_final[row, col] <- smd
  return(table1_final)
}

# Get rownumbers which need a SMD
table_rownumbers <- table1_final
colnames(table_rownumbers) <- c("ovr", "t1", "c2", "smd1", "t2", "c2", "smd2")
table_rows <- as.data.frame(table_rownumbers) %>% dplyr::select(smd1) %>% mutate(rownr = 1:nrow(table1_final)) %>% 
  filter(smd1 == "" & rownr != 1)
rows <- table_rows$rownr

# Fill SMD for each rownumber
for(i in rows){
  table1_final <- fillSMD(weighted = FALSE, row = i)
  table1_final <- fillSMD(weighted = TRUE, row = i)
}

## Start only showing percentages
# Check which data contains means (SD), as these should not have their mean deleted
table_rownumbers <- as.data.frame(table_rownumbers) %>% dplyr::select(ovr, smd1) %>% mutate(rownr = 1:nrow(table1_final))

# Omit rows 118, 119, and 127, in addition to all rows without brackets
rows <- filter(table_rownumbers, !(rownr == 118 | rownr == 119 | rownr == 127) & grepl("[()]", ovr))$rownr

for(c in c(1:3, 5:6)){
  for(i in rows){
    table1_final[i, c] <- gsub("[()]", "", str_match(table1_final[i, c], "\\(\\d+.*\\d*\\)"))
  }
}

# We want only cholesterol, ACR, and potassium to show decimals, so here we round everything
rows <- c(2, 15, 53, 59, 65, 71, 77, 83, 109, 116, 117)

for(c in c(1:3, 5:6)){
  for(i in rows){
    value <- as.character(round(as.numeric(gsub(" \\[\\d+.\\d, \\d+.\\d\\]", "", table1_final[i, c])), digits = 0))
    q1 <- as.character(round(as.numeric(gsub(", \\d+.\\d\\]", "", gsub("\\d+.\\d \\[", "", table1_final[i, c]))), digits = 0))
    q3 <- as.character(round(as.numeric(gsub("\\]", "", gsub("\\d+.\\d \\[\\d+.\\d, ", "", table1_final[i, c]))), digits = 0))
    table1_final[i, c] <- paste(value, " [", q1, ", ", q3, "]", sep = "")
  }
}

kable(table1_final, caption = "Baseline characteristics before and after weighting")

rm(i, c, table_rownumbers, rows)

```


#### 2.3.4.4. Weighted Kaplan Meier curves
```{r include = FALSE}
# Taken from KMunicate source code
# Edouard Fu modified this code (and I modified it some more):
# 1. Legend position: Left upper corner instead of right upper corner if reverse is true
# 2. Legend headings: not 0/1 but Continued/Stopped RASi
# 3. The risk table shows unweighted numbers, but the plot itself is weighted. For this I introduced both fit and fit2 (KMunicate only 
#    specified fit)
# 4. Add specifiable plot title in bold and increase distance to plot
# 5. Removed censored and event rows to only display risk rows
# Removed some annotation to clean up the code, for annotation: https://github.com/ellessenne/KMunicate-package/blob/master/R/KMunicate.R

#' @keywords internal
.fortify <- function(fit) {
  fit <- survival::survfit0(x = fit)
  out <- data.frame(
    time = fit$time,
    n.risk = fit$n.risk,
    n.event = fit$n.event,
    n.censor = fit$n.censor,
    surv = fit$surv,
    lower = fit$lower,
    upper = fit$upper
  )
  if ("strata" %in% names(fit)) {
    out$strata <- rep(names(fit$strata), times = as.numeric(fit$strata))
    out$strata <- factor(out$strata, levels = names(fit$strata), labels = gsub(".*=", "", names(fit$strata)))
  }
  return(out)
}

#' @keywords internal
.fortify_summary <- function(fit2, time_scale, risk_table) {
  summ <- summary(fit2, times = time_scale, extend = TRUE)
  
  d <- data.frame(
    time = summ$time,
    n.risk = summ$n.risk,
    n.event = summ$n.event,
    n.censor = summ$n.censor
  )
  if ("strata" %in% names(fit2)) {
    d$strata <- summ$strata
    d$strata <- factor(d$strata, levels = levels(d$strata), labels = gsub(".*=", "", levels(d$strata)))
  }
  # Use cumulative n.event and n.censor if risk_table == "KMunicate"
  if (risk_table == "KMunicate") {
    if ("strata" %in% names(fit2)) {
      dsplit <- split(x = d, f = d$strata)
    } else {
      dsplit <- list(d)
    }
    dsplit <- lapply(dsplit, function(x) {
      x$n.event <- cumsum(x$n.event)
      x$n.censor <- cumsum(x$n.censor)
      # Solve (for now) inconsistency between n.risk and the rest
      # Trusting n.censor and n.event for now...
      # See (and follow-up) over at:
      # - https://github.com/ellessenne/KMunicate-package/issues/6
      # - https://github.com/therneau/survival/issues/119
      x$n.risk <- max(x$n.risk) - x$n.censor - x$n.event
      x
    })
    d <- do.call(rbind, dsplit)
  }
  
  # Return d
  return(d)
}

KMunicate <- function(fit, fit2, time_scale, .risk_table = "KMunicate", .reverse = FALSE, .theme = NULL, 
                      .color_scale = 
                      scale_color_manual(values = c(rgb(0, 101, 172, maxColorValue = 255), rgb(243, 110, 53, maxColorValue = 255))), 
                      .fill_scale = 
                      scale_fill_manual(values = c(rgb(0, 101, 172, maxColorValue = 255), rgb(243, 110, 53, maxColorValue = 255))),
                      .linetype_scale = NULL, .annotate = NULL, .xlab = "Time", 
                      .ylab = ifelse(.reverse, "Estimated (1 - survival)", "Estimated survival"), .alpha = 0.25, 
                      .rel_heights = NULL, .ff = NULL, .risk_table_base_size = 11, .size = NULL, .legend_position = c(0, 1), title,
                      .ylim, .breaks = 0.25, .zoom = NULL, .xmin_zoom = NULL, .xmax_zoom = NULL, .ymin_zoom = NULL, .ymax_zoom = NULL,
                      .breaks_zoom = 0.05){
  
  ### Check arguments
  arg_checks <- checkmate::makeAssertCollection()
  # 'fit' must be of class 'survfit'
  checkmate::assert_class(x = fit, classes = "survfit", add = arg_checks)
  # 'time_scale' must be a numeric vector
  checkmate::assert_numeric(x = time_scale, add = arg_checks)
  # '.reverse' must be a logical value
  checkmate::assert_logical(x = .reverse, len = 1, add = arg_checks)
  # '.risk_table' must be a vector of strings, can be NULL
  checkmate::assert_string(x = .risk_table, null.ok = TRUE, add = arg_checks)
  # '.risk_table' must have specific values
  if (!is.null(.risk_table)) {
    .risk_table <- match.arg(.risk_table, choices = c("KMunicate", "survfit", NULL))
    checkmate::assert_true(x = .risk_table %in% c("KMunicate", "survfit"), add = arg_checks)
  }
  # '.theme' must be of class 'theme', 'gg' and must pass ggplot2::is.ggtheme()
  checkmate::assert_class(x = .theme, classes = c("theme", "gg"), null.ok = TRUE, add = arg_checks)
  if (!is.null(.theme)) checkmate::assert_true(x = ggplot2::is.theme(.theme), add = arg_checks)
  # '.color_scale', '.fill_scale', '.linetype_scale', '.annotate' must pass ggplot2::is.ggproto()
  if (!is.null(.color_scale)) checkmate::assert_true(x = ggplot2::is.ggproto(.color_scale), add = arg_checks)
  if (!is.null(.fill_scale)) checkmate::assert_true(x = ggplot2::is.ggproto(.fill_scale), add = arg_checks)
  if (!is.null(.linetype_scale)) checkmate::assert_true(x = ggplot2::is.ggproto(.linetype_scale), add = arg_checks)
  if (!is.null(.annotate)) checkmate::assert_true(x = ggplot2::is.ggproto(.annotate), add = arg_checks)
  # '.xlab', '.ylab' must be a string
  checkmate::assert_string(x = .xlab, add = arg_checks)
  checkmate::assert_string(x = .ylab, add = arg_checks)
  # '.alpha' must be a number
  checkmate::assert_number(x = .alpha, add = arg_checks)
  # '.rel_heights' must be a numeric vector or NULL
  checkmate::assert_numeric(x = .rel_heights, null.ok = TRUE, add = arg_checks)
  # '.ff' must be a string or NULL
  checkmate::assert_string(x = .ff, null.ok = TRUE, add = arg_checks)
  # '.risk_table_base_size', '.size' must be a number
  checkmate::assert_number(x = .risk_table_base_size, add = arg_checks)
  checkmate::assert_number(x = .size, null.ok = TRUE, add = arg_checks)
  # '.legend_position' must be a numeric vector of length 2, or a single string "none"
  checkmate::assert_true(x = (is.numeric(.legend_position) & length(.legend_position) == 2) | (is.character(.legend_position) & 
                                                             length(.legend_position) == 1), add = arg_checks)
  # Report
  if (!arg_checks$isEmpty()) checkmate::reportAssertions(arg_checks)
  
  ### Fortify data
  data <- .fortify(fit) %>% mutate(strata = ifelse(strata == 0, "Continued RASi", "Stopped RASi"))
  # If .reverse, use 1 - survival probability
  if(.reverse){
    data$surv <- 1 - data$surv
    data$lower <- 1 - data$lower
    data$upper <- 1 - data$upper
  }
  
  ### Create plot
  ## Main plot
  plot <- ggplot2::ggplot(data, ggplot2::aes(x = time, y = surv, ymin = lower, ymax = upper)) + labs(title = title) + 
    theme(plot.title = element_text(margin = margin(0, 0, 10, 0), face="bold", size = 12, hjust = 0.5))

  if ("strata" %in% names(fit)) {
    plot <- plot + pammtools::geom_stepribbon(ggplot2::aes(fill = strata), alpha = .alpha)
    if (!is.null(.size)) {
      plot <- plot +
        ggplot2::geom_step(ggplot2::aes(color = strata, linetype = strata), size = .size)
    } else {
      plot <- plot +
        ggplot2::geom_step(ggplot2::aes(color = strata, linetype = strata))
    }
  } else {
    if (!is.null(.size)) {
      plot <- plot + pammtools::geom_stepribbon(alpha = .alpha, size = .size)
    } else {
      plot <- plot + pammtools::geom_stepribbon(alpha = .alpha)
    }
    plot <- plot +
      ggplot2::geom_step()
  }
  plot <- plot +
    ggplot2::scale_x_continuous(breaks = time_scale) +
    ggplot2::scale_y_continuous(breaks = seq(0, 1, by = .breaks)) + 
    ggplot2::coord_cartesian(ylim = c(0, 1), xlim = range(time_scale)) +
    ggplot2::labs(color = "", fill = "", linetype = "", x = .xlab, y = .ylab)
  if (!is.null(.theme)) {
    plot <- plot + .theme
  } else if (!is.null(.ff)) {
    plot <- plot + ggplot2::theme_gray(base_family = .ff)
  }
  plot <- plot +
    ggplot2::theme(legend.position = .legend_position, legend.background = ggplot2::element_blank(), legend.key = ggplot2::element_blank(), 
                   plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm")) 
  if (length(.legend_position) > 1) {
    plot <- plot +
      ggplot2::theme(legend.justification = .legend_position)
  }
  if (!is.null(.color_scale)) {
    plot <- plot + .color_scale
  }
  if (!is.null(.fill_scale)) {
    plot <- plot + .fill_scale
  }
  if (!is.null(.linetype_scale)) {
    plot <- plot + .linetype_scale
  }
  if (!is.null(.annotate)) {
    plot <- plot + .annotate
  }
  
  ## Zoom plot
  zoom <- ggplot2::ggplot(data, ggplot2::aes(x = time, y = surv, ymin = lower, ymax = upper))

  if ("strata" %in% names(fit)) {
    zoom <- zoom + pammtools::geom_stepribbon(ggplot2::aes(fill = strata), alpha = .alpha)
    if (!is.null(.size)) {
      zoom <- zoom +
        ggplot2::geom_step(ggplot2::aes(color = strata, linetype = strata), size = .size)
    } else {
      zoom <- zoom +
        ggplot2::geom_step(ggplot2::aes(color = strata, linetype = strata))
    }
  } else {
    if (!is.null(.size)) {
      zoom <- zoom + pammtools::geom_stepribbon(alpha = .alpha, size = .size)
    } else {
      zoom <- zoom + pammtools::geom_stepribbon(alpha = .alpha)
    }
    zoom <- zoom +
      ggplot2::geom_step()
  }
  zoom <- zoom +
    ggplot2::scale_x_continuous(breaks = time_scale) +
    ggplot2::scale_y_continuous(breaks = seq(.ylim[[1]], .ylim[[2]], by = .breaks_zoom)) +
    ggplot2::coord_cartesian(ylim = .ylim, xlim = range(time_scale)) +
    ggplot2::labs(color = "", fill = "", linetype = "", x = "", y = "")
  if (!is.null(.theme)) {
    zoom <- zoom + .theme
  } else if (!is.null(.ff)) {
    zoom <- zoom + ggplot2::theme_gray(base_family = .ff)
  }
  zoom <- zoom +
    ggplot2::theme(legend.position = c(-2, -2), legend.background = ggplot2::element_blank(), legend.key = ggplot2::element_blank(), 
                   plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm")) 
  if (length(.legend_position) > 1) {
    zoom <- zoom +
      ggplot2::theme(legend.justification = .legend_position)
  }
  if (!is.null(.color_scale)) {
    zoom <- zoom + .color_scale
  }
  if (!is.null(.fill_scale)) {
    zoom <- zoom + .fill_scale
  }
  if (!is.null(.linetype_scale)) {
    zoom <- zoom + .linetype_scale
  }
  if (!is.null(.annotate)) {
    zoom <- zoom + .annotate
  }
  
  ### Add plots together if requested
  if (!is.null(.zoom)){
    
  plot <- plot + annotation_custom(grob = ggplotGrob(zoom), xmin = .xmin_zoom, xmax = .xmax_zoom, ymin = .ymin_zoom, ymax = .ymax_zoom)
  
  }
  
  # Create tables if requested
  if (!is.null(.risk_table)) {
    ### Create tables
    table_data <- .fortify_summary(fit2 = fit2, time_scale = time_scale, risk_table = .risk_table) %>%
      dplyr::select(-n.event, -n.censor) %>% arrange(time, strata) %>% relocate(strata, .before = n.risk)
    table_data$strata <- factor(table_data$strata, levels = c(1, 0), labels = c("Stopped RASi   ", "Continued RASi   "))
    
    ### Create table 'plots'
    if (!("strata" %in% names(fit2))) {
      table_data$strata <- "Overall"
    }
    tds <- list(table_data)
    tds <- lapply(seq_along(tds), function(i) {
      p <- ggplot2::ggplot(tds[[i]], ggplot2::aes(x = time, y = strata, label = n.risk))
      if (is.null(.ff)) {
        p <- p + ggplot2::geom_text(size = .risk_table_base_size / 3)
      } else {
        p <- p + ggplot2::geom_text(mapping = ggplot2::aes(family = .ff), size = .risk_table_base_size / 3)
      }
      p <- p +
        ggplot2::scale_x_continuous(breaks = time_scale) +
        ggplot2::coord_cartesian(xlim = range(time_scale)) +
        ggplot2::theme_void(base_size = .risk_table_base_size) +
        ggplot2::theme(plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"))
      if (is.null(.ff)) {
        p <- p + ggplot2::theme(axis.text.y = ggplot2::element_text(face = "plain"),
                                plot.title = ggplot2::element_text(face = "bold"))
      } else {
        p <- p + ggplot2::theme(axis.text.y = ggplot2::element_text(face = "plain", family = .ff), plot.title = 
                 ggplot2::element_text(family = .ff, face = "bold"))
      }
      p <- p +
        ggplot2::labs(title = "At risk")
    })
    
    ### Process relative heights
    if (is.null(.rel_heights)) {
      .rel_heights <- c(3, rep(1, length(tds)))
    }
    
    ### Combine plot and tables
    KMunicate_plot <- cowplot::plot_grid(plotlist = c(list(plot), tds), align = "hv", axis = "tlbr", ncol = 1, rel_heights = .rel_heights)
  } else {
    KMunicate_plot <- plot
  }
  
  ### Return
  return(KMunicate_plot)
}

# Theme function
theme_min <- function(){
    theme(panel.background = element_blank(),
          axis.line.x.bottom = element_line(colour = "black", size = 0.5),
          axis.line.y.left = element_line(colour = "black", size = 0.5),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())
}

# Plotting function
# .zoom_mar function is order of xmin, xmax, ymin, ymax
km_plots <- function(time2event, event, stopping, weights, ylab, title, file,
                     .breaks = 0.25, .zoom = NULL, .ylim = c(0, 0), .zoom_mar = c(0, 0, 0, 0), .breaks_zoom){
  time_scale <- seq(0, max(time2event/365.25), by = 1)
  km_before_weighting <- survfit(Surv((time2event/365.25), event) ~ stopping) 
  km_after_weighting <- survfit(Surv((time2event/365.25), event) ~ stopping, weights = weights)

  KMunicate(fit = km_after_weighting, fit2 = km_before_weighting, time_scale = time_scale, .risk_table = "survfit", 
            .ylab = ylab, .xlab = "Time (years)", .theme = theme_min(), title =  title, 
            .legend_position = c(0, 1.1), .risk_table_base_size = 9, .reverse = TRUE, .breaks = .breaks, .zoom = .zoom,
            .ylim = .ylim, .xmin_zoom = .zoom_mar[[1]], .xmax_zoom = .zoom_mar[[2]], .ymin_zoom = .zoom_mar[[3]], 
            .ymax_zoom = .zoom_mar[[4]], .breaks_zoom = .breaks_zoom)
  
  setwd("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Figures/SA")

  ggsave(file, width = 7, height = 5, dpi = 600)
}

# Start creating plots
# Composite outcome
km_plots(sa_cohort$time2comp, sa_cohort$event_comp, sa_cohort$stopping, sa_cohort$ow, "Absolute risk of death, myocardial infarction, or stroke", 
         "A. Composite outcome of mortality, myocardial infarction, and stroke", "km_comp_L6.pdf", .breaks = 0.2)

# Mortality
# To change file type, change extension in the file name (e.g., .pdf to .jpeg), DPI can be changed in the function above.
km_plots(sa_cohort$time2death, sa_cohort$event_mort, sa_cohort$stopping, sa_cohort$ow, "Absolute risk of death", "A. Mortality",
         "km_mortality_L6.pdf", .breaks = 0.2)

# Recurrent AKI
km_plots(sa_cohort$time2aki, sa_cohort$event_aki, sa_cohort$stopping, sa_cohort$ow, "Absolute risk of recurrent AKI", "B. Recurrent AKI",
         "km_aki_L6.pdf", .breaks = 0.2, .zoom = TRUE, .ylim = c(0, 0.25), .zoom_mar = c(1.25, 5, 0.25, 1), .breaks_zoom = 0.05)

# Heart failure
km_plots(sa_cohort$time2hf, sa_cohort$event_hf, sa_cohort$stopping, sa_cohort$ow, "Absolute risk of heart failure hospitalization", 
         "C. Heart failure hospitalization", "km_hf_L6.pdf", .breaks = 0.2)

# End-stage kidney disease
km_plots(sa_cohort_lab$time2eskd, sa_cohort_lab$event_eskd, sa_cohort_lab$stopping, sa_cohort_lab$ow, "Absolute risk of ESKD", "D. ESKD",
         "km_eskd_L6.pdf", .breaks = 0.2, .zoom = TRUE, .ylim = c(0, 0.15), .zoom_mar = c(1.25, 5, 0.25, 1), .breaks_zoom = 0.05)

# CKD progression
km_plots(sa_cohort_lab$time2ckd, sa_cohort_lab$event_ckd, sa_cohort_lab$stopping, sa_cohort_lab$ow, "Absolute risk of CKD progression", 
         "E. CKD progression", "km_ckd_L6.pdf", .breaks = 0.2, .zoom = TRUE, .ylim = c(0, 0.25), .zoom_mar = c(1.25, 5, 0.25, 1), 
         .breaks_zoom = 0.05)

# Moderate hyperkalemia
km_plots(sa_cohort_lab$time2hk_moderate, sa_cohort_lab$event_hk_moderate, sa_cohort_lab$stopping, sa_cohort_lab$ow, 
         "Absolute risk of moderate hyperkalemia", "F. Moderate hyperkalemia", "km_hkmod_L6.pdf", .breaks = 0.2)

# MACE 
km_plots(sa_cohort$time2mace, sa_cohort$event_mace, sa_cohort$stopping, sa_cohort$ow, "Absolute risk of MACE", "G. MACE",
         "km_mace_L6.pdf", .breaks = 0.2, .zoom = TRUE, .ylim = c(0, 0.25), .zoom_mar = c(1.25, 5, 0.25, 1), .breaks_zoom = 0.05)

``` 

#### 2.3.4.5. Adjusted Cox regression model using overlap weighting adjustment
```{r}
# Weighted Cox models using IPTW
# Function for model
coxweighted <- function(event, time2event, cohort_stopping, cohort_weight){
  cox_weighted <- coxph(Surv(time2event, event) ~ as.factor(cohort_stopping), weights = cohort_weight, robust = TRUE)

   # This code is just used to put the hazard ratios and confidence intervals in a table
  table_weighted <- format(round(cbind(summary(cox_weighted)$coef, exp(confint(cox_weighted))), 2), nsmall = 2) %>% 
    as.data.frame() %>% filter(row_number() == 1) 
  table_weighted <- table_weighted[, c(2, 7:8)] 
  colnames(table_weighted) <- c("HR","lower","upper") 
  
  table_weighted <- as.data.frame(table_weighted) %>% mutate(HR = gsub(pattern = " ", replacement = "", x = HR),
                                                             lHR = nchar(HR),
                                                             HR = ifelse(lHR == 1 | lHR == 2, paste(HR, ".0", sep = ""), HR),
                                                             lower = gsub(pattern = " ", replacement = "", x = lower),
                                                             llower = nchar(lower),
                                                             lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                                             upper = gsub(pattern = " ", replacement = "", x = upper),
                                                             lupper = nchar(upper),
                                                             upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                                             HR = paste(HR, " (", lower, "-", upper,")", sep = ""))  
  table_weighted <- as.data.frame(table_weighted[, 1]) 
  colnames(table_weighted) <- "Overlap Weights Adjusted HR (95% CI)"
  
  table_weighted <- rbind("", "", "1 (Reference)", table_weighted)
  
  return(table_weighted)
}


# Outcomes with overlap weights
cox_weighted_comp <- coxweighted(sa_cohort$event_comp, sa_cohort$time2comp, sa_cohort$stopping, sa_cohort$ow)
cox_weighted_death <- coxweighted(sa_cohort$event_mort, sa_cohort$time2death, sa_cohort$stopping, sa_cohort$ow)
cox_weighted_aki <- coxweighted(sa_cohort$event_aki, sa_cohort$time2aki, sa_cohort$stopping, sa_cohort$ow)
cox_weighted_hf <- coxweighted(sa_cohort$event_hf, sa_cohort$time2hf, sa_cohort$stopping, sa_cohort$ow)
cox_weighted_eskd <- coxweighted(sa_cohort_lab$event_eskd, sa_cohort_lab$time2eskd, sa_cohort_lab$stopping, sa_cohort_lab$ow)
cox_weighted_ckd <- coxweighted(sa_cohort_lab$event_ckd, sa_cohort_lab$time2ckd, sa_cohort_lab$stopping, sa_cohort_lab$ow)
cox_weighted_hkmod <- coxweighted(sa_cohort_lab$event_hk_moderate, sa_cohort_lab$time2hk_moderate, sa_cohort_lab$stopping, sa_cohort_lab$ow)
cox_weighted_mace <- coxweighted(sa_cohort$event_mace, sa_cohort$time2mace, sa_cohort$stopping, sa_cohort$ow)

cox_weighted_ow <- rbind(cox_weighted_comp, cox_weighted_death, cox_weighted_aki, cox_weighted_hf, cox_weighted_eskd, 
                         cox_weighted_ckd, cox_weighted_hkmod, cox_weighted_mace)

table2 <- cbind(incidence_table, cox_table_unadjusted, cox_weighted_ow)

kable(table2)

rm(cox_weighted_death, cox_weighted_aki, cox_weighted_hf, cox_weighted_eskd, cox_weighted_ckd, cox_weighted_hkmod,
   cox_weighted_mace, coxweighted, cox_weighted_comp)

```


#### 2.3.4.6. Absolute risks
```{r}
absolute_risks <- function(formula_surv, df, name){
  surv_info <- survfit(as.formula(formula_surv), weights = ow, robust = TRUE, data = df)
  
  # Surv contains absolute risks, std.err contains standard errors. Strata are put below one another.
  surv <- as.data.frame(surv_info$surv)
  std.err <- as.data.frame(surv_info$std.err)

  row0 <- as.numeric(surv_info$strata[[1]])
  row1 <- as.numeric(length(surv$`surv_info$surv`))

  surv0 <- surv[[row0, 1]]
  surv1 <- surv[[row1, 1]]
  se0 <- std.err[[row0, 1]]
  se1 <- std.err[[row1, 1]]

  # Absolute risk & 95% CI continuing at 5 years
  ar0 <- (1 - surv0) * 100
  ll0 <- ((1 - surv0) - (1.96 * se0)) * 100
  ul0 <- ((1 - surv0) + (1.96 * se0)) * 100

  # Absolute risk & 95% CI stopping at 5 years
  ar1 <- (1 - surv1) * 100
  ll1 <- ((1 - surv1) - (1.96 * se1)) * 100
  ul1 <- ((1 - surv1) + (1.96 * se1)) * 100

  # Absolute risk difference at 5 years
  ard <- ((1 - surv1) - (1 - surv0)) * 100
  lld <- (((1 - surv1) - (1 - surv0)) - sqrt((se1 ^ 2) + (se0 ^ 2))) * 100
  uld <- (((1 - surv1) - (1 - surv0)) + sqrt((se1 ^ 2) + (se0 ^ 2))) * 100

  ar <- matrix(0, ncol = 3, nrow = 3)
  colnames(ar) <- c("risk", "lower", "upper")
  rownames(ar) <- c("Continuers", "Stoppers", "Difference")

  ar[[1, 1]] <- round(ar0, digits = 1)
  ar[[1, 2]] <- round(ll0, digits = 1)
  ar[[1, 3]] <- round(ul0, digits = 1)
  ar[[2, 1]] <- round(ar1, digits = 1)
  ar[[2, 2]] <- round(ll1, digits = 1)
  ar[[2, 3]] <- round(ul1, digits = 1)
  ar[[3, 1]] <- round(ard, digits = 1)
  ar[[3, 2]] <- round(lld, digits = 1)
  ar[[3, 3]] <- round(uld, digits = 1)
  
  ar <- as.data.frame(ar) %>% mutate(lrisk = nchar(risk),
                                     risk = ifelse(lrisk == 1 | lrisk == 2, paste(risk, ".0", sep = ""), risk),
                                     llower = nchar(lower),
                                     lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                     lupper = nchar(upper),
                                     upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                     ar_c = paste(as.character(risk), " (", as.character(lower), ", ", as.character(upper), ")", sep = ""))
  ar <- dplyr::select(ar, ar_c)
  colnames(ar) <- name
  
  return(as.data.frame(ar))
}

ar_comp <- absolute_risks(Surv(time2comp, event_comp) ~ as.factor(stopping), df = sa_cohort, "Composite")
ar_mort <- absolute_risks(Surv(time2death, event_mort) ~ as.factor(stopping), df = sa_cohort, "Mortality")
ar_aki <- absolute_risks(Surv(time2aki, event_aki) ~ as.factor(stopping), df = sa_cohort, "Recurrent AKI")
ar_hf <- absolute_risks(Surv(time2hf, event_hf) ~ as.factor(stopping), df = sa_cohort, "Heart failure")
ar_eskd <- absolute_risks(Surv(time2eskd, event_eskd) ~ as.factor(stopping), df = sa_cohort_lab, "End-stage kidney disease")
ar_ckd <- absolute_risks(Surv(time2ckd, event_ckd) ~ as.factor(stopping), df = sa_cohort_lab, "CKD progression")
ar_hkmod <- absolute_risks(Surv(time2hk_moderate, event_hk_moderate) ~ as.factor(stopping), df = sa_cohort_lab, "Moderate hyperkalemia")
ar_mace <- absolute_risks(Surv(time2mace, event_mace) ~ as.factor(stopping), df = sa_cohort, "MACE")

ar_table <- cbind(ar_comp, ar_mort, ar_aki, ar_hf, ar_eskd, ar_ckd, ar_hkmod, ar_mace)

kable(ar_table, caption = "Absolute risks (95% CI) and absolute risk difference (95% CI)")

```


#### 2.3.4.7. Amount of stoppers
```{r}
#### We also want to know how much people discontinue over time. 
load("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/meds_c1.Rdata")
meds_rasi <- meds %>% filter(grepl("^C09A|^C09B|^C09C|^C09D", atc))

ph <- dplyr::select(sa_cohort, lopnr, adm_dt, index_dt, stopping)
meds_rev <- ph %>% left_join(meds_rasi, "lopnr") %>% filter(edatum > index_dt) %>% dplyr::select(lopnr, edatum, atc)

ph2 <- ph %>% left_join(meds_rev, "lopnr") %>% arrange(lopnr, edatum) %>% group_by(lopnr) %>%
    mutate(lead_edatum = lead(edatum),
           diff = as.numeric(lead_edatum - edatum),
           stopped = ifelse((stopping == 0 & diff > 30) | (stopping == 0 & is.na(lead_edatum)), 1, 0),
           stopped_dt = edatum + 30) %>%
    ungroup() %>% arrange(lopnr, desc(stopping), edatum) %>% group_by(lopnr) %>% slice(1L) %>% ungroup() %>%
    filter(stopping == 1) %>%
    mutate(yrs = as.numeric(stopped_dt - index_dt) / 365.25)

x <- length(unique(ph2$lopnr)) # continuers who stopped
y <- round(length(unique(ph2$lopnr)) / length(unique(filter(sa_cohort, stopping == 1)$lopnr)) * 100, digits = 1) # proportion
z <- paste0(round(summary(ph2$yrs)[[3]], digits = 1), " (", round(summary(ph2$yrs)[[2]], digits = 1), "-", 
            round(summary(ph2$yrs)[[5]], digits = 1), ")", sep = "") # median years to stopping

df <- as.data.frame(cbind(x, y, z))
colnames(df) <- c("Stoppers", "Proportion", "Median years (IQR) until stopping")
kable(df)

```


## 2.4. Cohort without indication for RASi being an exclusion criterium
### 2.4.0. Get data
```{r}
load("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/population_sa4.Rdata")

sa_cohort <- filter(population_sa4) %>% dplyr::select(-crit_type.x) %>% rename(crit_type = crit_type.y)
sa_cohort_lab <- filter(sa_cohort, lab_outcome == 1)

```


### 2.4.1. Baseline characteristics
```{r include=FALSE}
# This code is used to make the baseline table. We will do this before and after the propensity score weighting

# Specify which variables in the dataset you want to include in the baseline table
listvar <- c("age", "age_cat", "female", "educ_cat", "adm_egfr", "adm_egfr_cat", "comorb_dm", "comorb_ht", "comorb_mi", "comorb_arr",
             "comorb_cd", "comorb_pvd", "comorb_ihd", "comorb_copd", "comorb_ca", "comorb_ld",  "comorb_chf", "comorb_dl", "comorb_hyth", 
             "comorb_eh", "comorb_vhd", "med_bb", "med_ccb", "med_ld", "med_td", "med_pd", "med_nsaid", "med_al", "med_ab",  "med_nt", 
             "med_ara", "med_hl", "med_aa", "med_dx", "med_ac", "med_dm", "med_op", "kontakt_all", "kontakt_all_cat", "kontakt_cv",
             "kontakt_cv_cat", "ovr_all", "ovr_all_cat", "ovr_cv", "ovr_cv_cat", "slv_all", "slv_all_cat", "slv_cv", "slv_cv_cat", 
             "hosp_cv", "hosp_rs", "hosp_gi", "hosp_id", "hosp_ca", "hosp_op", "hosp_hm", "hosp_gu", "hosp_ip", 
             "hosp_ns", "hosp_hk", "hosp_od", "pc_sp", "pc_cs", "pc_cc", "pc_ar", "pc_pn", "pc_lf", "pc_mi", "pc_ns", "dur", "AKI_acoa", 
             "crit_type", "AcutDial", "creat_mean", "creat_peak", "potass_mean", "potass_peak", "acr", "acr_cat", "chol") 

# specify which variables are continuous
continuous <- c("age","adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur", "creat_mean", 
                "creat_peak", "potass_mean", "potass_peak", "acr", "chol") 

catvar <- listvar[!listvar %in% continuous] # specify that all other variables except the ones specified previously are categorical

# Give labels to the variables
labels <- c("Number of individuals",
            "Median age (IQR) (years)", 
            "Age category (years)", "< 50", "50-59", "60-69", "70-79", "> 80",
            "Female", 
            "Highest level of education achieved", "Compulsory school", "Secondary school", "University", "Missing",
            "Median eGFR before admission (IQR) (ml/min/1.73 m2)",
            "CKD categories", "G1", "G2", "G3a", "G3b", "G4",
            "Diabetes mellitus",
            "Hypertension",
            "Myocardial infarction",
            "Arrythmia",
            "Cerebrovascular disease",
            "Peripheral vascular disease",
            "Ischemic heart disease",
            "Chronic obstructive pulmonary disease",
            "Cancer",
            "Liver disease",
            "Chronic heart failure",
            "Dyslipidemia",
            "Hypothyroidism",
            "Extracranial hemorrhage",
            "Valvular heart disease",
            "Beta blockers",
            "Calcium channel blockers",
            "Loop diuretics",
            "Thiazide diuretics",
            "Potassium-sparing diuretics",
            "NSAIDs",
            "Antilipids",
            "Alpha blockers",
            "Nitrate",
            "MRAs",
            "Hydralazine",
            "Antiarrythmics",
            "Digoxin",
            "Anticoagulants",
            "Diabetes medication",
            "Opioids",
            "Median primary care context contacts (IQR)",
            "Amount of primary care contex contacts", "Zero", "One", "Two", "Three or more",
            "Cardiovascular primary care context contacts (IQR)",
            "Amount of cardiovascular primary care contex contacts", "Zero", "One", "Two", "Three or more",
            "Median specialist care context contacts (IQR)",
            "Amount of specialist care contex contacts", "Zero", "One", "Two", "Three or more",
            "Median cardiovascular specialist context care contacts (IQR)",
            "Amount of cardiovascular specialist care contex contacts", "Zero", "One", "Two", "Three or more",
            "Median number of hospitalizations (IQR)",
            "Amount of hospitalizations", "Zero", "One", "Two", "Three or more",
            "Median number of cardiovascular hospitalizations (IQR)",
            "Amount of cardiovascular hospitalizations", "Zero", "One", "Two", "Three or more",
            "Cardiovascular disease",
            "Respiratory disease",
            "Gastrointestinal, metabolic, and endocrine disease",
            "Infectious disease",
            "Cancer",
            "Musculoskeletal and connective tissue disease",
            "Hematologic disease",
            "Genitourinary disease",
            "Injury or poisoning",
            "Neurological disease",
            "Hyperkalemia",
            "Other disease",
            "Sepsis",
            "Cardiac surgery",
            "Cardiac catherization",
            "Abdominal aortic aneurysm repair",
            "Pneumonia",
            "Liver failure",
            "Acute myocardial infarction",
            "Non-cardiac surgery",
            "Median duration of stay (IQR) (days)",
            "AKI as cause of admission",
            "Stage of AKI KDIGO", "N17", "Stage II", "Stage III",
            "Need for acute dialysis",
            "Median of average creatinine during hospitalization (IQR) (umol/L)",
            "Median of peak creatinine during hospitalization (IQR) (umol/L)",
            "Mean potassium (mmol/L)",
            "Peak potassium (mmol/L)",
            "Albumin-creatinine ratio (mg/mmol)",
            "Albumin-creatinine ratio categories", "< 3", "3-29", "30-69", "> 70", "Missing",
            "Total cholesterol (mmol/L)") 

# Makes overall baseline table
# For more information what is specified here, please see:
# https://www.rdocumentation.org/packages/tableone/versions/0.12.0/topics/CreateTableOne 
# https://www.rdocumentation.org/packages/tableone/versions/0.12.0/topics/print.TableOne
table_overall <- CreateTableOne(vars = listvar, data = sa_cohort, factorVars = catvar) # 
table_overall <- print(table_overall, printToggle = FALSE, noSpaces = TRUE, catDigits = 0, contDigits = 1, pDigits = 3,
                       nonnormal = c("age", "adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur",
                                     "creat_mean", "creat_peak", "acr")) 
table_overall <- as.matrix(table_overall)
row.names(table_overall) <- labels

# Makes baseline table stratified by treatment level
table_stratified <- CreateTableOne(vars = listvar, data = sa_cohort, factorVars = catvar, smd = TRUE, strata = "stopping")
table_stratified <- print(table_stratified, printToggle = FALSE, noSpaces = TRUE, catDigits = 0, contDigits = 1, pDigits = 3,
                          nonnormal = c("age", "adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur",
                                        "creat_mean", "creat_peak", "acr"), smd = TRUE) 
table_stratified <- as.matrix(table_stratified[, c(2, 1, 5)])
row.names(table_stratified) <- labels

# Combine tables and add notes
table1 <- cbind(table_overall,table_stratified) 
colnames(table1) <- c("Overall","Stopped RASi","Continued RASi","SMD")

# remove objects
rm(listvar, continuous, catvar, labels, table_overall, table_stratified)

```


### 2.4.2. Total number of events, person years, and incidence rates
```{r include=FALSE}
# This is a piece of code to get the overall incidence of the outcome (not stratified by treatment)
incid_num_ovr <- function(outcome, time2outcome, cohort){
  incid_ovr <- survRate(Surv((time2outcome / (365.25 * 100)), outcome) ~ 0) %>%
    mutate(tstop = tstop * 100) %>% mutate_at(vars(rate, lower, upper), funs(round(., 1))) %>% mutate_at(vars(tstop), funs(round(., 0)))
  incid_ovr <- as.data.frame(incid_ovr) %>% mutate(rate = gsub(pattern = " ", replacement = "", x = rate),
                                                   lrate = nchar(rate),
                                                   rate = ifelse(lrate == 1 | lrate == 2, paste(rate, ".0", sep = ""), rate),
                                                   lower = gsub(pattern = " ", replacement = "", x = lower),
                                                   llower = nchar(lower),
                                                   lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                                   upper = gsub(pattern = " ", replacement = "", x = upper),
                                                   lupper = nchar(upper),
                                                   upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                                   rate = paste(rate, " (", lower, "-", upper,")", sep = ""))
  incid_ovr <- incid_ovr[, 1:4] %>% dplyr::select(event, tstop, rate) %>% 
    mutate(n = nrow(cohort)) %>% relocate(n, .before = event)
  return(incid_ovr)
}

# This is a piece of code to get the incidence stratified by treatment
incid_num_str <- function(outcome, time2outcome, cohort_stopping, cohort){
  ir <- survRate(Surv((time2outcome / (365.25 * 100)), outcome) ~ cohort_stopping) %>% 
    mutate(tstop = tstop * 100) %>% mutate_at(vars(rate, lower, upper), funs(round(., 1))) %>% mutate_at(vars(tstop), funs(round(., 0)))
  ir <- as.data.frame(ir) %>% mutate(rate = gsub(pattern = " ", replacement = "", x = rate),
                                     lrate = nchar(rate),
                                     rate = ifelse(lrate == 1 | lrate == 2, paste(rate, ".0", sep = ""), rate),
                                     lower = gsub(pattern = " ", replacement = "", x = lower),
                                     llower = nchar(lower),
                                     lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                     upper = gsub(pattern = " ", replacement = "", x = upper),
                                     lupper = nchar(upper),
                                     upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                     rate = paste(rate, " (", lower, "-", upper,")", sep = "")) 
  ir <- ir[, 2:4] %>% dplyr::select(event, tstop, rate)
  x <- as.data.frame(count(cohort, stopping))
  n <- rbind(x$n[[1]], x$n[[2]])
  ir <- cbind(n, ir)
  return(ir)
}


# Incidence table function
inctab <- function(event, time2event, cohort_stopping, cohort){
  incid_overall <- incid_num_ovr(event, time2event, cohort)
  colnames(incid_overall) <- c("N", "Events","py","Incidence rate per 100 py")
  rownames(incid_overall) <- c("Overall")
  
  incid_stratified <- incid_num_str(event, time2event, cohort_stopping, cohort)
  colnames(incid_stratified) <- c("N", "Events","py","Incidence rate per 100 py")
  rownames(incid_stratified) <- c("Continued RASi","Stopped RASi")
  
  incidence_table <- as.matrix(rbind(incid_overall, incid_stratified))
  return(incidence_table)
}

# Title function
tabtitle <- function(titlename){
  title <- transpose(as.data.frame(c("", "", "", "")))
  colnames(title) <- c("N", "Events","py","Incidence rate per 100 py")
  rownames(title) <- c(titlename)
  return(title)
}

# Outcomes
title_death <- tabtitle("Mortality")
incidence_table_death <- inctab(sa_cohort$event_mort, sa_cohort$time2death, sa_cohort$stopping, sa_cohort)
title_aki <- tabtitle("Recurrent AKI")
incidence_table_aki <- inctab(sa_cohort$event_aki, sa_cohort$time2aki, sa_cohort$stopping, sa_cohort)
title_hf <- tabtitle("Heart failure hospitalisation")
incidence_table_hf <- inctab(sa_cohort$event_hf, sa_cohort$time2hf, sa_cohort$stopping, sa_cohort)
title_eskd <- tabtitle("ESKD")
incidence_table_eskd <- inctab(sa_cohort_lab$event_eskd, sa_cohort_lab$time2eskd, sa_cohort_lab$stopping, sa_cohort_lab)
title_ckd <- tabtitle("CKD progression")
incidence_table_ckd <- inctab(sa_cohort_lab$event_ckd, sa_cohort_lab$time2ckd, sa_cohort_lab$stopping, sa_cohort_lab)
title_hkmod <- tabtitle("Moderate hyperkalemia")
incidence_table_hkmod <- inctab(sa_cohort_lab$event_hk_moderate, sa_cohort_lab$time2hk_moderate, sa_cohort_lab$stopping, sa_cohort_lab)
title_mace <- tabtitle("MACE")
incidence_table_mace <- inctab(sa_cohort$event_mace, sa_cohort$time2mace, sa_cohort$stopping, sa_cohort)

incidence_table <- as.matrix(rbind(title_death, incidence_table_death, title_aki, incidence_table_aki, title_hf, incidence_table_hf, 
                                   title_eskd, incidence_table_eskd, title_ckd, incidence_table_ckd, 
                                   title_hkmod, incidence_table_hkmod, title_mace, incidence_table_mace))
kable(incidence_table)

rm(incid_num_ovr, incid_num_str, inctab, tabtitle, title_death, incidence_table_death, title_aki, incidence_table_aki, title_hf, 
   incidence_table_hf, title_eskd, incidence_table_eskd, title_ckd, incidence_table_ckd, title_hkmod, 
   incidence_table_hkmod, title_mace, incidence_table_mace)
```


### 2.4.3. Unadjusted Cox regression model
```{r include=FALSE}
# Unadjusted Cox model with univariabele regression
# Function to create model and table
coxunadjusted <- function(event, time2event, cohort_stopping){
  cox_unadjusted <- coxph(Surv(time2event, event) ~ as.factor(cohort_stopping)) 
  dat <- summary(cox_unadjusted) # outputs coefficients of unadjusted Cox model and HR's with confidence intervals
  
  # This code is just used to put the hazard ratios and confidence intervals in a table
  table_unadj <- format(round(cbind(dat$coef, exp(confint(cox_unadjusted))),2), nsmall = 2) %>% as.data.frame() %>%
    filter(row_number() == 1) 
  table_unadj <- table_unadj[, c(2, 6:7)] 
  colnames(table_unadj) <- c("HR","lower","upper") 

  table_unadj <- as.data.frame(table_unadj) %>% mutate(HR = gsub(pattern = " ", replacement = "", x = HR),
                                                       lHR = nchar(HR),
                                                       HR = ifelse(lHR == 1 | lHR == 2, paste(HR, ".0", sep = ""), HR),
                                                       lower = gsub(pattern = " ", replacement = "", x = lower),
                                                       llower = nchar(lower),
                                                       lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                                       upper = gsub(pattern = " ", replacement = "", x = upper),
                                                       lupper = nchar(upper),
                                                       upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                                       HR = paste(HR, " (", lower, "-", upper,")", sep = "")) 
  table_unadj <- as.data.frame(table_unadj[, 1])  
  colnames(table_unadj) <- "Crude HR (95% CI)"
  return(table_unadj)
}

# Outcomes
table_unadj_death <- rbind("", "", "1 (Reference)", coxunadjusted(sa_cohort$event_mort, sa_cohort$time2death, sa_cohort$stopping))
table_unadj_aki <- rbind("", "", "1 (Reference)", coxunadjusted(sa_cohort$event_aki, sa_cohort$time2aki, sa_cohort$stopping))
table_unadj_hf <- rbind("", "", "1 (Reference)", coxunadjusted(sa_cohort$event_hf, sa_cohort$time2hf, sa_cohort$stopping))
table_unadj_eskd <- rbind("", "", "1 (Reference)", coxunadjusted(sa_cohort_lab$event_eskd, sa_cohort_lab$time2eskd, sa_cohort_lab$stopping))
table_unadj_ckd <- rbind("", "", "1 (Reference)", coxunadjusted(sa_cohort_lab$event_ckd, sa_cohort_lab$time2ckd, sa_cohort_lab$stopping))
table_unadj_hkmod <- rbind("", "", "1 (Reference)", coxunadjusted(sa_cohort_lab$event_hk_moderate, sa_cohort_lab$time2hk_moderate, 
                                                                  sa_cohort_lab$stopping))
table_unadj_mace <- rbind("", "", "1 (Reference)", coxunadjusted(sa_cohort$event_mace, sa_cohort$time2mace, sa_cohort$stopping))

cox_table_unadjusted <- rbind(table_unadj_death, table_unadj_aki, table_unadj_hf, table_unadj_eskd, table_unadj_ckd,
                              table_unadj_hkmod, table_unadj_mace)

rm(coxunadjusted, table_unadj_death, table_unadj_aki, table_unadj_hf, table_unadj_eskd, table_unadj_ckd, 
   table_unadj_hkmod, table_unadj_mace)

```


### 2.4.4. Weighting
#### 2.4.4.1. Estimating overlap weights
```{r}
### Normal cohort
## Create propensity score (needed for denominator): chance of receiving treatment given covariates
# Create linear regression using covariates
denom.fit <- glm(stopping ~ age + age_cat + female + educ_cat + adm_egfr + adm_egfr_cat + comorb_dm + comorb_ht + comorb_mi + comorb_arr +
                 comorb_cd + comorb_pvd + comorb_ihd + comorb_copd + comorb_ca + comorb_ld + comorb_chf + comorb_dl + comorb_hyth + 
                 comorb_eh + comorb_vhd + med_bb + med_ccb + med_ld + med_td + med_pd + med_nsaid + med_al + med_ab + med_nt + med_ara + 
                 med_hl + med_aa + med_dx + med_ac + med_dm + med_op + kontakt_all + kontakt_cv + slv_all + slv_cv + ovr_all + ovr_cv + 
                 kontakt_all_cat + kontakt_cv_cat + slv_all_cat + slv_cv_cat + ovr_all_cat + ovr_cv_cat + hosp_cv + hosp_rs + hosp_gi + 
                 hosp_id + hosp_ca + hosp_op + hosp_hm + hosp_gu + hosp_ip + hosp_ns + hosp_hk + hosp_od + 
                 pc_sp + pc_cs + pc_cc + pc_ar + pc_pn + pc_lf + pc_mi + pc_ns + dur + AKI_acoa + crit_type + AcutDial + creat_mean +
                 creat_peak, family = binomial(), data = sa_cohort)

# Fill in regression formula per person to create propensity score
pred_denom <- predict(denom.fit, type = "response")

# Add propensity score to dataframe
sa_cohort$ps <- pred_denom
normalize0 <- sum(sa_cohort$ps[which(sa_cohort$stopping == 0)])
normalize1 <- sum(sa_cohort$ps[which(sa_cohort$stopping == 1)])

# Calculating overlap weights
# Weighted pseudopopulation will be as large as original population
sa_cohort$ow <- ifelse(sa_cohort$stopping == 0, pred_denom / normalize0,  (1 - pred_denom) / normalize1)
summary(sa_cohort$ow)

### Lab cohort
## Create propensity score (needed for denominator): chance of receiving treatment given covariates
# Create linear regression using covariates
denom.fit <- glm(stopping ~ age + age_cat + female + educ_cat + adm_egfr + adm_egfr_cat + comorb_dm + comorb_ht + comorb_mi + comorb_arr +
                 comorb_cd + comorb_pvd + comorb_ihd + comorb_copd + comorb_ca + comorb_ld + comorb_chf + comorb_dl + comorb_hyth + 
                 comorb_eh + comorb_vhd + med_bb + med_ccb + med_ld + med_td + med_pd + med_nsaid + med_al + med_ab + med_nt + med_ara + 
                 med_hl + med_aa + med_dx + med_ac + med_dm + med_op + kontakt_all + kontakt_cv + slv_all + slv_cv + ovr_all + ovr_cv + 
                 kontakt_all_cat + kontakt_cv_cat + slv_all_cat + slv_cv_cat + ovr_all_cat + ovr_cv_cat + hosp_cv + hosp_rs + hosp_gi + 
                 hosp_id + hosp_ca + hosp_op + hosp_hm + hosp_gu + hosp_ip + hosp_ns + hosp_hk + hosp_od + pc_sp + pc_cs + pc_cc + pc_ar + 
                 pc_pn + pc_lf + pc_mi + pc_ns + dur + AKI_acoa + crit_type + AcutDial + creat_mean + creat_peak, family = binomial(), 
                 data = sa_cohort_lab)

# Fill in regression formula per person to create propensity score
pred_denom <- predict(denom.fit, type = "response")

# Add propensity score to dataframe
sa_cohort_lab$ps <- pred_denom
normalize0 <- sum(sa_cohort_lab$ps[which(sa_cohort_lab$stopping == 0)])
normalize1 <- sum(sa_cohort_lab$ps[which(sa_cohort_lab$stopping == 1)])

# Calculating overlap weights
# Weighted pseudopopulation will be as large as original population
sa_cohort_lab$ow <- ifelse(sa_cohort_lab$stopping == 0, pred_denom / normalize0,  (1 - pred_denom) / normalize1)
summary(sa_cohort_lab$ow)

```

#### 2.4.4.2. Baseline characteristics after weighting
```{r}
# Create a weighted survey design object
sa_cohortSvy <- svydesign(ids = ~ lopnr, weights = ~ ow, data = sa_cohort)

# Specify which variables in the dataset you want to include in the baseline table
listvar <- c("age", "age_cat", "female", "educ_cat", "adm_egfr", "adm_egfr_cat", "comorb_dm", "comorb_ht", "comorb_mi", "comorb_arr",
             "comorb_cd", "comorb_pvd", "comorb_ihd", "comorb_copd", "comorb_ca", "comorb_ld",  "comorb_chf", "comorb_dl", "comorb_hyth", 
             "comorb_eh", "comorb_vhd", "med_bb", "med_ccb", "med_ld", "med_td", "med_pd", "med_nsaid", "med_al", "med_ab",  "med_nt", 
             "med_ara", "med_hl", "med_aa", "med_dx", "med_ac", "med_dm", "med_op", "kontakt_all", "kontakt_all_cat", "kontakt_cv",
             "kontakt_cv_cat", "ovr_all", "ovr_all_cat", "ovr_cv", "ovr_cv_cat", "slv_all", "slv_all_cat", "slv_cv", "slv_cv_cat", 
             "hosp_cv", "hosp_rs", "hosp_gi", "hosp_id", "hosp_ca", "hosp_op", "hosp_hm", "hosp_gu", "hosp_ip", 
             "hosp_ns", "hosp_hk", "hosp_od", "pc_sp", "pc_cs", "pc_cc", "pc_ar", "pc_pn", "pc_lf", "pc_mi", "pc_ns", "dur", "AKI_acoa", 
             "crit_type", "AcutDial", "creat_mean", "creat_peak", "potass_mean", "potass_peak", "acr", "acr_cat", "chol") 

# specify which variables are continuous
continuous <- c("age","adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur", "creat_mean", 
                  "creat_peak", "potass_mean", "potass_peak", "acr", "chol") 

catvar <- listvar[!listvar %in% continuous] # specify that all other variables except the ones specified previously are categorical

# Give labels to the variables
  labels <- c("Number of individuals",
              "Median age (IQR) (years)", 
              "Age category (years)", "< 50", "50-59", "60-69", "70-79", "> 80",
              "Female", 
              "Highest level of education achieved", "Compulsory school", "Secondary school", "University", "Missing", 
              "Median eGFR before admission (IQR) (ml/min/1.73 m2)",
              "CKD categories", "G1", "G2", "G3a", "G3b", "G4",
              "Diabetes mellitus",
              "Hypertension",
              "Myocardial infarction",
              "Arrythmia",
              "Cerebrovascular disease",
              "Peripheral vascular disease",
              "Ischemic heart disease",
              "Chronic obstructive pulmonary disease",
              "Cancer",
              "Liver disease",
              "Chronic heart failure",
              "Dyslipidemia",
              "Hypothyroidism",
              "Extracranial hemorrhage",
              "Valvular heart disease",
              "Beta blockers",
              "Calcium channel blockers",
              "Loop diuretics",
              "Thiazide diuretics",
              "Potassium-sparing diuretics",
              "NSAIDs",
              "Antilipids",
              "Alpha blockers",
              "Nitrate",
              "MRAs",
              "Hydralazine",
              "Antiarrythmics",
              "Digoxin",
              "Anticoagulants",
              "Diabetes medication",
              "Opioids",
              "Median primary care context contacts (IQR)",
              "Amount of primary care contex contacts", "Zero", "One", "Two", "Three or more",
              "Cardiovascular primary care context contacts (IQR)",
              "Amount of cardiovascular primary care contex contacts", "Zero", "One", "Two", "Three or more",
              "Median specialist care context contacts (IQR)",
              "Amount of specialist care contex contacts", "Zero", "One", "Two", "Three or more",
              "Median cardiovascular specialist context care contacts (IQR)",
              "Amount of cardiovascular specialist care contex contacts", "Zero", "One", "Two", "Three or more",
              "Median number of hospitalizations (IQR)",
              "Amount of hospitalizations", "Zero", "One", "Two", "Three or more",
              "Median number of cardiovascular hospitalizations (IQR)",
              "Amount of cardiovascular hospitalizations", "Zero", "One", "Two", "Three or more",
              "Cardiovascular disease",
              "Respiratory disease",
              "Gastrointestinal, metabolic, and endocrine disease",
              "Infectious disease",
              "Cancer",
              "Musculoskeletal and connective tissue disease",
              "Hematologic disease",
              "Genitourinary disease",
              "Injury or poisoning",
              "Neurological disease",
              "Hyperkalemia",
              "Other disease",
              "Sepsis",
              "Cardiac surgery",
              "Cardiac catherization",
              "Abdominal aortic aneurysm repair",
              "Pneumonia",
              "Liver failure",
              "Acute myocardial infarction",
              "Non-cardiac surgery",
              "Median duration of stay (IQR) (days)",
              "AKI as cause of admission",
              "Stage of AKI KDIGO", "N17", "Stage II", "Stage III",
              "Need for acute dialysis",
              "Median of average creatinine during hospitalization (IQR) (umol/L)",
              "Median of peak creatinine during hospitalization (IQR) (umol/L)",
              "Mean potassium (mmol/L)",
              "Peak potassium (mmol/L)",
              "Albumin-creatinine ratio (mg/mmol)",
              "Albumin-creatinine ratio categories", "< 3", "3-29", "30-69", "> 70", "Missing",
              "Total cholesterol (mmol/L)")  

# Characteristics stratified by treatment group
table_weighted <- svyCreateTableOne(vars = listvar, data = sa_cohortSvy, factorVars = catvar, strata = "stopping")
table_weighted <- print(table_weighted, printToggle = FALSE, 
                        nonnormal = c("age", "adm_egfr", "kontakt_all", "kontakt_cv", "slv_all", "slv_cv", "ovr_all", "ovr_cv", "dur",
                                      "creat_mean", "creat_peak", "acr"), noSpaces = TRUE, 
                        catDigits = 0, contDigits = 1, pDigits = 3, smd = TRUE)
table_weighted <- as.matrix(table_weighted[, c(2, 1, 5)])
row.names(table_weighted) <- labels
colnames(table_weighted) <- c("Stopped RASi", "Continued RASi", "SMD")

# kable(table_weighted, align = "c", caption = title)

rm(listvar, continuous, catvar, labels, sa_cohortSvy) 

table1_final <- cbind(table1, table_weighted)

```

#### 2.4.4.3. SMDs for categories before and after weighting
```{r}
stand_diff <- function(pT, pC){
  d <- (pT-pC)/(sqrt((pT*(1-pT)+pC*(1-pC))/2))
  return(d)
}

# Function for calculating SMD
fillSMD <- function(weighted = NULL, row){
  # Determine whether the SMD is for the column of the weighted or unweighted population
  if(is.null(weighted)) stop("Indicate whether the SMD is for the weighted or unweighted population")
  col <- ifelse(weighted == FALSE, 4, 7)
  
  # Retrieve proportion reported in table
  pT <- as.numeric(gsub("[()]", "", str_match(table1_final[row, (col - 2)], "\\(\\d+.*\\d*\\)"))) / 100
  pC <- as.numeric(gsub("[()]", "", str_match(table1_final[row, (col - 1)], "\\(\\d+.*\\d*\\)"))) / 100
  
  # Calculate SMD
  smd <- round(stand_diff(pT, pC), 3)
  smd <- ifelse(smd < 0, smd * (-1), smd)
  smd <- ifelse(smd == 0, "<0.001", smd)
  smd <- ifelse(nchar(smd) == 3, paste(smd, "00", sep = ""), smd)
  smd <- ifelse(nchar(smd) == 4, paste(smd, "0", sep = ""), smd)
  
  # Fill in SMD
  table1_final[row, col] <- smd
  return(table1_final)
}

# Get rownumbers which need a SMD
table_rownumbers <- table1_final
colnames(table_rownumbers) <- c("ovr", "t1", "c2", "smd1", "t2", "c2", "smd2")
table_rows <- as.data.frame(table_rownumbers) %>% dplyr::select(smd1) %>% mutate(rownr = 1:nrow(table1_final)) %>% 
  filter(smd1 == "" & rownr != 1)
rows <- table_rows$rownr

# Fill SMD for each rownumber
for(i in rows){
  table1_final <- fillSMD(weighted = FALSE, row = i)
  table1_final <- fillSMD(weighted = TRUE, row = i)
}

## Start only showing percentages
# Check which data contains means (SD), as these should not have their mean deleted
table_rownumbers <- as.data.frame(table_rownumbers) %>% dplyr::select(ovr, smd1) %>% mutate(rownr = 1:nrow(table1_final))

# Omit rows 118, 119, and 127, in addition to all rows without brackets
rows <- filter(table_rownumbers, !(rownr == 118 | rownr == 119 | rownr == 127) & grepl("[()]", ovr))$rownr

for(c in c(1:3, 5:6)){
  for(i in rows){
    table1_final[i, c] <- gsub("[()]", "", str_match(table1_final[i, c], "\\(\\d+.*\\d*\\)"))
  }
}

# We want only cholesterol, ACR, and potassium to show decimals, so here we round everything
rows <- c(2, 15, 53, 59, 65, 71, 77, 83, 109, 116, 117)

for(c in c(1:3, 5:6)){
  for(i in rows){
    value <- as.character(round(as.numeric(gsub(" \\[\\d+.\\d, \\d+.\\d\\]", "", table1_final[i, c])), digits = 0))
    q1 <- as.character(round(as.numeric(gsub(", \\d+.\\d\\]", "", gsub("\\d+.\\d \\[", "", table1_final[i, c]))), digits = 0))
    q3 <- as.character(round(as.numeric(gsub("\\]", "", gsub("\\d+.\\d \\[\\d+.\\d, ", "", table1_final[i, c]))), digits = 0))
    table1_final[i, c] <- paste(value, " [", q1, ", ", q3, "]", sep = "")
  }
}

kable(table1_final, caption = "Baseline characteristics before and after weighting")

rm(i, c, table_rownumbers, rows)

```


#### 2.4.4.4. Weighted Kaplan Meier curves
```{r include = FALSE}
# Taken from KMunicate source code
# Edouard Fu modified this code (and I modified it some more):
# 1. Legend position: Left upper corner instead of right upper corner if reverse is true
# 2. Legend headings: not 0/1 but Continued/Stopped RASi
# 3. The risk table shows unweighted numbers, but the plot itself is weighted. For this I introduced both fit and fit2 (KMunicate only 
#    specified fit)
# 4. Add specifiable plot title in bold and increase distance to plot
# 5. Removed censored and event rows to only display risk rows
# Removed some annotation to clean up the code, for annotation: https://github.com/ellessenne/KMunicate-package/blob/master/R/KMunicate.R

#' @keywords internal
.fortify <- function(fit) {
  fit <- survival::survfit0(x = fit)
  out <- data.frame(
    time = fit$time,
    n.risk = fit$n.risk,
    n.event = fit$n.event,
    n.censor = fit$n.censor,
    surv = fit$surv,
    lower = fit$lower,
    upper = fit$upper
  )
  if ("strata" %in% names(fit)) {
    out$strata <- rep(names(fit$strata), times = as.numeric(fit$strata))
    out$strata <- factor(out$strata, levels = names(fit$strata), labels = gsub(".*=", "", names(fit$strata)))
  }
  return(out)
}

#' @keywords internal
.fortify_summary <- function(fit2, time_scale, risk_table) {
  summ <- summary(fit2, times = time_scale, extend = TRUE)
  
  d <- data.frame(
    time = summ$time,
    n.risk = summ$n.risk,
    n.event = summ$n.event,
    n.censor = summ$n.censor
  )
  if ("strata" %in% names(fit2)) {
    d$strata <- summ$strata
    d$strata <- factor(d$strata, levels = levels(d$strata), labels = gsub(".*=", "", levels(d$strata)))
  }
  # Use cumulative n.event and n.censor if risk_table == "KMunicate"
  if (risk_table == "KMunicate") {
    if ("strata" %in% names(fit2)) {
      dsplit <- split(x = d, f = d$strata)
    } else {
      dsplit <- list(d)
    }
    dsplit <- lapply(dsplit, function(x) {
      x$n.event <- cumsum(x$n.event)
      x$n.censor <- cumsum(x$n.censor)
      # Solve (for now) inconsistency between n.risk and the rest
      # Trusting n.censor and n.event for now...
      # See (and follow-up) over at:
      # - https://github.com/ellessenne/KMunicate-package/issues/6
      # - https://github.com/therneau/survival/issues/119
      x$n.risk <- max(x$n.risk) - x$n.censor - x$n.event
      x
    })
    d <- do.call(rbind, dsplit)
  }
  
  # Return d
  return(d)
}

KMunicate <- function(fit, fit2, time_scale, .risk_table = "KMunicate", .reverse = FALSE, .theme = NULL, .color_scale = NULL, 
                      .fill_scale = NULL, .linetype_scale = NULL, .annotate = NULL, .xlab = "Time", 
                      .ylab = ifelse(.reverse, "Estimated (1 - survival)", "Estimated survival"), .alpha = 0.25, 
                      .rel_heights = NULL, .ff = NULL, .risk_table_base_size = 11, .size = NULL, .legend_position = c(0, 1), title,
                      .ylim, .breaks = 0.25, .zoom = NULL, .xmin_zoom = NULL, .xmax_zoom = NULL, .ymin_zoom = NULL, .ymax_zoom = NULL,
                      .breaks_zoom = 0.05){
  
  ### Check arguments
  arg_checks <- checkmate::makeAssertCollection()
  # 'fit' must be of class 'survfit'
  checkmate::assert_class(x = fit, classes = "survfit", add = arg_checks)
  # 'time_scale' must be a numeric vector
  checkmate::assert_numeric(x = time_scale, add = arg_checks)
  # '.reverse' must be a logical value
  checkmate::assert_logical(x = .reverse, len = 1, add = arg_checks)
  # '.risk_table' must be a vector of strings, can be NULL
  checkmate::assert_string(x = .risk_table, null.ok = TRUE, add = arg_checks)
  # '.risk_table' must have specific values
  if (!is.null(.risk_table)) {
    .risk_table <- match.arg(.risk_table, choices = c("KMunicate", "survfit", NULL))
    checkmate::assert_true(x = .risk_table %in% c("KMunicate", "survfit"), add = arg_checks)
  }
  # '.theme' must be of class 'theme', 'gg' and must pass ggplot2::is.ggtheme()
  checkmate::assert_class(x = .theme, classes = c("theme", "gg"), null.ok = TRUE, add = arg_checks)
  if (!is.null(.theme)) checkmate::assert_true(x = ggplot2::is.theme(.theme), add = arg_checks)
  # '.color_scale', '.fill_scale', '.linetype_scale', '.annotate' must pass ggplot2::is.ggproto()
  if (!is.null(.color_scale)) checkmate::assert_true(x = ggplot2::is.ggproto(.color_scale), add = arg_checks)
  if (!is.null(.fill_scale)) checkmate::assert_true(x = ggplot2::is.ggproto(.fill_scale), add = arg_checks)
  if (!is.null(.linetype_scale)) checkmate::assert_true(x = ggplot2::is.ggproto(.linetype_scale), add = arg_checks)
  if (!is.null(.annotate)) checkmate::assert_true(x = ggplot2::is.ggproto(.annotate), add = arg_checks)
  # '.xlab', '.ylab' must be a string
  checkmate::assert_string(x = .xlab, add = arg_checks)
  checkmate::assert_string(x = .ylab, add = arg_checks)
  # '.alpha' must be a number
  checkmate::assert_number(x = .alpha, add = arg_checks)
  # '.rel_heights' must be a numeric vector or NULL
  checkmate::assert_numeric(x = .rel_heights, null.ok = TRUE, add = arg_checks)
  # '.ff' must be a string or NULL
  checkmate::assert_string(x = .ff, null.ok = TRUE, add = arg_checks)
  # '.risk_table_base_size', '.size' must be a number
  checkmate::assert_number(x = .risk_table_base_size, add = arg_checks)
  checkmate::assert_number(x = .size, null.ok = TRUE, add = arg_checks)
  # '.legend_position' must be a numeric vector of length 2, or a single string "none"
  checkmate::assert_true(x = (is.numeric(.legend_position) & length(.legend_position) == 2) | (is.character(.legend_position) & 
                                                             length(.legend_position) == 1), add = arg_checks)
  # Report
  if (!arg_checks$isEmpty()) checkmate::reportAssertions(arg_checks)
  
  ### Fortify data
  data <- .fortify(fit) %>% mutate(strata = ifelse(strata == 0, "Continued RASi", "Stopped RASi"))
  # If .reverse, use 1 - survival probability
  if(.reverse){
    data$surv <- 1 - data$surv
    data$lower <- 1 - data$lower
    data$upper <- 1 - data$upper
  }
  
  ### Create plot
  ## Main plot
  plot <- ggplot2::ggplot(data, ggplot2::aes(x = time, y = surv, ymin = lower, ymax = upper)) + labs(title = title) + 
    theme(plot.title = element_text(margin = margin(0, 0, 10, 0), face="bold", size = 12, hjust = 0.5))

  if ("strata" %in% names(fit)) {
    plot <- plot + pammtools::geom_stepribbon(ggplot2::aes(fill = strata), alpha = .alpha)
    if (!is.null(.size)) {
      plot <- plot +
        ggplot2::geom_step(ggplot2::aes(color = strata, linetype = strata), size = .size)
    } else {
      plot <- plot +
        ggplot2::geom_step(ggplot2::aes(color = strata, linetype = strata))
    }
  } else {
    if (!is.null(.size)) {
      plot <- plot + pammtools::geom_stepribbon(alpha = .alpha, size = .size)
    } else {
      plot <- plot + pammtools::geom_stepribbon(alpha = .alpha)
    }
    plot <- plot +
      ggplot2::geom_step()
  }
  plot <- plot +
    ggplot2::scale_x_continuous(breaks = time_scale) +
    ggplot2::scale_y_continuous(breaks = seq(0, 1, by = .breaks)) + 
    ggplot2::coord_cartesian(ylim = c(0, 1), xlim = range(time_scale)) +
    ggplot2::labs(color = "", fill = "", linetype = "", x = .xlab, y = .ylab)
  if (!is.null(.theme)) {
    plot <- plot + .theme
  } else if (!is.null(.ff)) {
    plot <- plot + ggplot2::theme_gray(base_family = .ff)
  }
  plot <- plot +
    ggplot2::theme(legend.position = .legend_position, legend.background = ggplot2::element_blank(), legend.key = ggplot2::element_blank(), 
                   plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm")) 
  if (length(.legend_position) > 1) {
    plot <- plot +
      ggplot2::theme(legend.justification = .legend_position)
  }
  if (!is.null(.color_scale)) {
    plot <- plot + .color_scale
  }
  if (!is.null(.fill_scale)) {
    plot <- plot + .fill_scale
  }
  if (!is.null(.linetype_scale)) {
    plot <- plot + .linetype_scale
  }
  if (!is.null(.annotate)) {
    plot <- plot + .annotate
  }
  
  ## Zoom plot
  zoom <- ggplot2::ggplot(data, ggplot2::aes(x = time, y = surv, ymin = lower, ymax = upper))

  if ("strata" %in% names(fit)) {
    zoom <- zoom + pammtools::geom_stepribbon(ggplot2::aes(fill = strata), alpha = .alpha)
    if (!is.null(.size)) {
      zoom <- zoom +
        ggplot2::geom_step(ggplot2::aes(color = strata, linetype = strata), size = .size)
    } else {
      zoom <- zoom +
        ggplot2::geom_step(ggplot2::aes(color = strata, linetype = strata))
    }
  } else {
    if (!is.null(.size)) {
      zoom <- zoom + pammtools::geom_stepribbon(alpha = .alpha, size = .size)
    } else {
      zoom <- zoom + pammtools::geom_stepribbon(alpha = .alpha)
    }
    zoom <- zoom +
      ggplot2::geom_step()
  }
  zoom <- zoom +
    ggplot2::scale_x_continuous(breaks = time_scale) +
    ggplot2::scale_y_continuous(breaks = seq(.ylim[[1]], .ylim[[2]], by = .breaks_zoom)) +
    ggplot2::coord_cartesian(ylim = .ylim, xlim = range(time_scale)) +
    ggplot2::labs(color = "", fill = "", linetype = "", x = "", y = "")
  if (!is.null(.theme)) {
    zoom <- zoom + .theme
  } else if (!is.null(.ff)) {
    zoom <- zoom + ggplot2::theme_gray(base_family = .ff)
  }
  zoom <- zoom +
    ggplot2::theme(legend.position = c(-2, -2), legend.background = ggplot2::element_blank(), legend.key = ggplot2::element_blank(), 
                   plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm")) 
  if (length(.legend_position) > 1) {
    zoom <- zoom +
      ggplot2::theme(legend.justification = .legend_position)
  }
  if (!is.null(.color_scale)) {
    zoom <- zoom + .color_scale
  }
  if (!is.null(.fill_scale)) {
    zoom <- zoom + .fill_scale
  }
  if (!is.null(.linetype_scale)) {
    zoom <- zoom + .linetype_scale
  }
  if (!is.null(.annotate)) {
    zoom <- zoom + .annotate
  }
  
  ### Add plots together if requested
  if (!is.null(.zoom)){
    
  plot <- plot + annotation_custom(grob = ggplotGrob(zoom), xmin = .xmin_zoom, xmax = .xmax_zoom, ymin = .ymin_zoom, ymax = .ymax_zoom)
  
  }
  
  # Create tables if requested
  if (!is.null(.risk_table)) {
    ### Create tables
    table_data <- .fortify_summary(fit2 = fit2, time_scale = time_scale, risk_table = .risk_table) %>%
      dplyr::select(-n.event, -n.censor) %>% arrange(time, strata) %>% relocate(strata, .before = n.risk)
    table_data$strata <- factor(table_data$strata, levels = c(1, 0), labels = c("Stopped RASi   ", "Continued RASi   "))
    
    ### Create table 'plots'
    if (!("strata" %in% names(fit2))) {
      table_data$strata <- "Overall"
    }
    tds <- list(table_data)
    tds <- lapply(seq_along(tds), function(i) {
      p <- ggplot2::ggplot(tds[[i]], ggplot2::aes(x = time, y = strata, label = n.risk))
      if (is.null(.ff)) {
        p <- p + ggplot2::geom_text(size = .risk_table_base_size / 3)
      } else {
        p <- p + ggplot2::geom_text(mapping = ggplot2::aes(family = .ff), size = .risk_table_base_size / 3)
      }
      p <- p +
        ggplot2::scale_x_continuous(breaks = time_scale) +
        ggplot2::coord_cartesian(xlim = range(time_scale)) +
        ggplot2::theme_void(base_size = .risk_table_base_size) +
        ggplot2::theme(plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"))
      if (is.null(.ff)) {
        p <- p + ggplot2::theme(axis.text.y = ggplot2::element_text(face = "plain"),
                                plot.title = ggplot2::element_text(face = "bold"))
      } else {
        p <- p + ggplot2::theme(axis.text.y = ggplot2::element_text(face = "plain", family = .ff), plot.title = 
                 ggplot2::element_text(family = .ff, face = "bold"))
      }
      p <- p +
        ggplot2::labs(title = "At risk")
    })
    
    ### Process relative heights
    if (is.null(.rel_heights)) {
      .rel_heights <- c(3, rep(1, length(tds)))
    }
    
    ### Combine plot and tables
    KMunicate_plot <- cowplot::plot_grid(plotlist = c(list(plot), tds), align = "hv", axis = "tlbr", ncol = 1, rel_heights = .rel_heights)
  } else {
    KMunicate_plot <- plot
  }
  
  ### Return
  return(KMunicate_plot)
}

# Theme function
theme_min <- function(){
    theme(panel.background = element_blank(),
          axis.line.x.bottom = element_line(colour = "black", size = 0.5),
          axis.line.y.left = element_line(colour = "black", size = 0.5),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())
}

# Plotting function
# .zoom_mar function is order of xmin, xmax, ymin, ymax
km_plots <- function(time2event, event, stopping, weights, ylab, title, file,
                     .breaks = 0.25, .zoom = NULL, .ylim = c(0, 0), .zoom_mar = c(0, 0, 0, 0), .breaks_zoom){
  time_scale <- seq(0, max(time2event/365.25), by = 1)
  km_before_weighting <- survfit(Surv((time2event/365.25), event) ~ stopping) 
  km_after_weighting <- survfit(Surv((time2event/365.25), event) ~ stopping, weights = weights)

  KMunicate(fit = km_after_weighting, fit2 = km_before_weighting, time_scale = time_scale, .risk_table = "survfit", 
            .ylab = ylab, .xlab = "Time (years)", .theme = theme_min(), title =  title, 
            .legend_position = c(0, 1.1), .risk_table_base_size = 9, .reverse = TRUE, .breaks = .breaks, .zoom = .zoom,
            .ylim = .ylim, .xmin_zoom = .zoom_mar[[1]], .xmax_zoom = .zoom_mar[[2]], .ymin_zoom = .zoom_mar[[3]], 
            .ymax_zoom = .zoom_mar[[4]], .breaks_zoom = .breaks_zoom)
  
  setwd("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Figures/SA")

  ggsave(file, width = 7, height = 5, dpi = 600)
}

# Start creating plots
# Mortality
# To change file type, change extension in the file name (e.g., .pdf to .jpeg), DPI can be changed in the function above.
km_plots(sa_cohort$time2death, sa_cohort$event_mort, sa_cohort$stopping, sa_cohort$ow, "Absolute risk of death", "A. Mortality",
         "km_mortality_SA4.pdf", .breaks = 0.2)

# Recurrent AKI
km_plots(sa_cohort$time2aki, sa_cohort$event_aki, sa_cohort$stopping, sa_cohort$ow, "Absolute risk of recurrent AKI", "B. Recurrent AKI",
         "km_aki_SA4.pdf", .breaks = 0.2, .zoom = TRUE, .ylim = c(0, 0.25), .zoom_mar = c(1.25, 5, 0.25, 1), .breaks_zoom = 0.05)

# Heart failure
km_plots(sa_cohort$time2hf, sa_cohort$event_hf, sa_cohort$stopping, sa_cohort$ow, "Absolute risk of heart failure hospitalization", 
         "C. Heart failure hospitalization", "km_hf_SA4.pdf", .breaks = 0.2)

# End-stage kidney disease
km_plots(sa_cohort_lab$time2eskd, sa_cohort_lab$event_eskd, sa_cohort_lab$stopping, sa_cohort_lab$ow, "Absolute risk of ESKD", "D. ESKD",
         "km_eskd_SA4.pdf", .breaks = 0.2, .zoom = TRUE, .ylim = c(0, 0.15), .zoom_mar = c(1.25, 5, 0.25, 1), .breaks_zoom = 0.05)

# CKD progression
km_plots(sa_cohort_lab$time2ckd, sa_cohort_lab$event_ckd, sa_cohort_lab$stopping, sa_cohort_lab$ow, "Absolute risk of CKD progression", 
         "E. CKD progression", "km_ckd_SA4.pdf", .breaks = 0.2, .zoom = TRUE, .ylim = c(0, 0.25), .zoom_mar = c(1.25, 5, 0.25, 1), 
         .breaks_zoom = 0.05)

# Moderate hyperkalemia
km_plots(sa_cohort_lab$time2hk_moderate, sa_cohort_lab$event_hk_moderate, sa_cohort_lab$stopping, sa_cohort_lab$ow, 
         "Absolute risk of moderate hyperkalemia", "F. Moderate hyperkalemia", "km_hkmod_SA4.pdf", .breaks = 0.2)

# MACE 
km_plots(sa_cohort$time2mace, sa_cohort$event_mace, sa_cohort$stopping, sa_cohort$ow, "Absolute risk of MACE", "G. MACE",
         "km_mace_SA4.pdf", .breaks = 0.2, .zoom = TRUE, .ylim = c(0, 0.25), .zoom_mar = c(1.25, 5, 0.25, 1), .breaks_zoom = 0.05)

``` 

#### 2.4.4.5. Adjusted Cox regression model using overlap weighting adjustment
```{r}
# Weighted Cox models using IPTW
# Function for model
coxweighted <- function(event, time2event, cohort_stopping, cohort_weight){
  cox_weighted <- coxph(Surv(time2event, event) ~ as.factor(cohort_stopping), weights = cohort_weight, robust = TRUE)

   # This code is just used to put the hazard ratios and confidence intervals in a table
  table_weighted <- format(round(cbind(summary(cox_weighted)$coef, exp(confint(cox_weighted))), 2), nsmall = 2) %>% 
    as.data.frame() %>% filter(row_number() == 1) 
  table_weighted <- table_weighted[, c(2, 7:8)] 
  colnames(table_weighted) <- c("HR","lower","upper") 
  
  table_weighted <- as.data.frame(table_weighted) %>% mutate(HR = gsub(pattern = " ", replacement = "", x = HR),
                                                             lHR = nchar(HR),
                                                             HR = ifelse(lHR == 1 | lHR == 2, paste(HR, ".0", sep = ""), HR),
                                                             lower = gsub(pattern = " ", replacement = "", x = lower),
                                                             llower = nchar(lower),
                                                             lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                                             upper = gsub(pattern = " ", replacement = "", x = upper),
                                                             lupper = nchar(upper),
                                                             upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                                             HR = paste(HR, " (", lower, "-", upper,")", sep = ""))  
  table_weighted <- as.data.frame(table_weighted[, 1]) 
  colnames(table_weighted) <- "Overlap Weights Adjusted HR (95% CI)"
  
  table_weighted <- rbind("", "", "1 (Reference)", table_weighted)
  
  return(table_weighted)
}


# Outcomes with overlap weights
cox_weighted_death <- coxweighted(sa_cohort$event_mort, sa_cohort$time2death, sa_cohort$stopping, sa_cohort$ow)
cox_weighted_aki <- coxweighted(sa_cohort$event_aki, sa_cohort$time2aki, sa_cohort$stopping, sa_cohort$ow)
cox_weighted_hf <- coxweighted(sa_cohort$event_hf, sa_cohort$time2hf, sa_cohort$stopping, sa_cohort$ow)
cox_weighted_eskd <- coxweighted(sa_cohort_lab$event_eskd, sa_cohort_lab$time2eskd, sa_cohort_lab$stopping, sa_cohort_lab$ow)
cox_weighted_ckd <- coxweighted(sa_cohort_lab$event_ckd, sa_cohort_lab$time2ckd, sa_cohort_lab$stopping, sa_cohort_lab$ow)
cox_weighted_hkmod <- coxweighted(sa_cohort_lab$event_hk_moderate, sa_cohort_lab$time2hk_moderate, sa_cohort_lab$stopping, sa_cohort_lab$ow)
cox_weighted_mace <- coxweighted(sa_cohort$event_mace, sa_cohort$time2mace, sa_cohort$stopping, sa_cohort$ow)

cox_weighted_ow <- rbind(cox_weighted_death, cox_weighted_aki, cox_weighted_hf, cox_weighted_eskd, cox_weighted_ckd, cox_weighted_hkmod, 
                         cox_weighted_mace)

table2 <- cbind(incidence_table, cox_table_unadjusted, cox_weighted_ow)

kable(table2)

rm(cox_weighted_death, cox_weighted_aki, cox_weighted_hf, cox_weighted_eskd, cox_weighted_ckd, cox_weighted_hkmod,
   cox_weighted_mace, coxweighted)

```


#### 2.4.4.6. Absolute risks
```{r}
absolute_risks <- function(formula_surv, df, name){
  surv_info <- survfit(as.formula(formula_surv), weights = ow, robust = TRUE, data = df)
  
  # Surv contains absolute risks, std.err contains standard errors. Strata are put below one another.
  surv <- as.data.frame(surv_info$surv)
  std.err <- as.data.frame(surv_info$std.err)

  row0 <- as.numeric(surv_info$strata[[1]])
  row1 <- as.numeric(length(surv$`surv_info$surv`))

  surv0 <- surv[[row0, 1]]
  surv1 <- surv[[row1, 1]]
  se0 <- std.err[[row0, 1]]
  se1 <- std.err[[row1, 1]]

  # Absolute risk & 95% CI continuing at 5 years
  ar0 <- (1 - surv0) * 100
  ll0 <- ((1 - surv0) - (1.96 * se0)) * 100
  ul0 <- ((1 - surv0) + (1.96 * se0)) * 100

  # Absolute risk & 95% CI stopping at 5 years
  ar1 <- (1 - surv1) * 100
  ll1 <- ((1 - surv1) - (1.96 * se1)) * 100
  ul1 <- ((1 - surv1) + (1.96 * se1)) * 100

  # Absolute risk difference at 5 years
  ard <- ((1 - surv1) - (1 - surv0)) * 100
  lld <- (((1 - surv1) - (1 - surv0)) - sqrt((se1 ^ 2) + (se0 ^ 2))) * 100
  uld <- (((1 - surv1) - (1 - surv0)) + sqrt((se1 ^ 2) + (se0 ^ 2))) * 100

  ar <- matrix(0, ncol = 3, nrow = 3)
  colnames(ar) <- c("risk", "lower", "upper")
  rownames(ar) <- c("Continuers", "Stoppers", "Difference")

  ar[[1, 1]] <- round(ar0, digits = 1)
  ar[[1, 2]] <- round(ll0, digits = 1)
  ar[[1, 3]] <- round(ul0, digits = 1)
  ar[[2, 1]] <- round(ar1, digits = 1)
  ar[[2, 2]] <- round(ll1, digits = 1)
  ar[[2, 3]] <- round(ul1, digits = 1)
  ar[[3, 1]] <- round(ard, digits = 1)
  ar[[3, 2]] <- round(lld, digits = 1)
  ar[[3, 3]] <- round(uld, digits = 1)
  
  ar <- as.data.frame(ar) %>% mutate(lrisk = nchar(risk),
                                     risk = ifelse(lrisk == 1 | lrisk == 2, paste(risk, ".0", sep = ""), risk),
                                     llower = nchar(lower),
                                     lower = ifelse(llower == 1 | llower == 2, paste(lower, ".0", sep = ""), lower),
                                     lupper = nchar(upper),
                                     upper = ifelse(lupper == 1 | lupper == 2, paste(upper, ".0", sep = ""), upper),
                                     ar_c = paste(as.character(risk), " (", as.character(lower), ", ", as.character(upper), ")", sep = ""))
  ar <- dplyr::select(ar, ar_c)
  colnames(ar) <- name
  
  return(as.data.frame(ar))
}

ar_mort <- absolute_risks(Surv(time2death, event_mort) ~ as.factor(stopping), df = sa_cohort, "Mortality")
ar_aki <- absolute_risks(Surv(time2aki, event_aki) ~ as.factor(stopping), df = sa_cohort, "Recurrent AKI")
ar_hf <- absolute_risks(Surv(time2hf, event_hf) ~ as.factor(stopping), df = sa_cohort, "Heart failure")
ar_eskd <- absolute_risks(Surv(time2eskd, event_eskd) ~ as.factor(stopping), df = sa_cohort_lab, "End-stage kidney disease")
ar_ckd <- absolute_risks(Surv(time2ckd, event_ckd) ~ as.factor(stopping), df = sa_cohort_lab, "CKD progression")
ar_hkmod <- absolute_risks(Surv(time2hk_moderate, event_hk_moderate) ~ as.factor(stopping), df = sa_cohort_lab, "Moderate hyperkalemia")
ar_mace <- absolute_risks(Surv(time2mace, event_mace) ~ as.factor(stopping), df = sa_cohort, "MACE")

ar_table <- cbind(ar_mort, ar_aki, ar_hf, ar_eskd, ar_ckd, ar_hkmod, ar_mace)

kable(ar_table, caption = "Absolute risks (95% CI) and absolute risk difference (95% CI)")

```


### 2.4.5. Landmark figure
```{r}
## 5 years
# Load unlandmarked cohort and medication database
load("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/cohort_sa4.Rdata")
load("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/meds_sa4.Rdata")

meds_rasi <- meds %>% filter(grepl("^C09A|^C09B|^C09C|^C09D", atc))

# Transform data
landmark_plot_data <- cohort_sa4 %>% left_join(meds_rasi, "lopnr") %>%
  filter(edatum > dis_dt) %>%
  arrange(lopnr, edatum) %>% group_by(lopnr) %>% slice(1L) %>% ungroup() %>%
  mutate(time = as.numeric(edatum - dis_dt)) %>%
  filter(time <= (365.25 * 5)) %>%
  mutate(month = cut(time, c(seq(0, 1800, by = 30)), right = FALSE, labels = FALSE)) %>% 
  arrange(month) %>% group_by(month) %>%
  mutate(ind = 1,
         time_freq = sum(ind)) %>%
  slice(1L) %>% ungroup() %>%
  mutate(cum_time_freq = cumsum(time_freq)) %>%
  dplyr::select(month, time_freq, cum_time_freq)

landmark_plot_data <- rbind(landmark_plot_data, data.frame(month = 0, time_freq =  0, cum_time_freq = 0)) %>% arrange(month)

for(i in 1:60){
  x <- nrow(filter(landmark_plot_data, month == i))
  if(x == 1){
    landmark_plot_data <- landmark_plot_data
  } else {
    y <- filter(landmark_plot_data, month == (i - 1))
    placeholder <- as.data.frame(transpose(as.data.frame(c(i, 0, y$cum_time_freq))))
    colnames(placeholder) <- c("month", "time_freq", "cum_time_freq")
    landmark_plot_data <- rbind(landmark_plot_data, placeholder) %>% arrange(month)
  }
} 

# Theme for plot
theme_min <- function(){
    theme(panel.background = element_rect(fill = "white", colour = "black", size = 0.5),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(margin = margin(0, 0, 10, 0), face= "bold", size = 12, hjust = 0.5))
}

ggplot(landmark_plot_data, aes(x = month, y = cum_time_freq, label = cum_time_freq)) + 
  geom_line() + geom_point() + scale_y_continuous(expand = expansion(mult = c(0, .1))) +
  xlab("Time (Months)") + ylab("Cumulative count") + scale_x_continuous(breaks = seq(0, 60, 3), expand = c(0, 0)) +
  theme_min() + geom_vline(xintercept = 3, linetype = "dashed", alpha = 0.5) + 
  ggtitle("Cumulative count of first RASi dispensation after discharge")

setwd("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Figures/SA")

ggsave("landmark_plot5y_sa4.pdf", width = 8, height = 5, dpi = 600)

## 1 year
# Load unlandmarked cohort and medication database
load("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/cohort_sa4.Rdata")
load("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Codes/Dataframes/meds_sa4.Rdata")

# Transform data
landmark_plot_data <- cohort_sa4 %>% left_join(meds_rasi, "lopnr") %>%
  filter(edatum > dis_dt) %>%
  arrange(lopnr, edatum) %>% group_by(lopnr) %>% slice(1L) %>% ungroup() %>%
  mutate(time = as.numeric(edatum - dis_dt)) %>%
  filter(time <= 365.25) %>%
  mutate(month = cut(time, c(seq(0, 360, by = 30)), right = FALSE, labels = FALSE)) %>% 
  arrange(month) %>% group_by(month) %>%
  mutate(ind = 1,
         time_freq = sum(ind)) %>%
  slice(1L) %>% ungroup() %>%
  mutate(cum_time_freq = cumsum(time_freq)) %>%
  dplyr::select(month, time_freq, cum_time_freq)

landmark_plot_data <- rbind(landmark_plot_data, data.frame(month = 0, time_freq =  0, cum_time_freq = 0)) %>% arrange(month)

for(i in 1:12){
  x <- nrow(filter(landmark_plot_data, month == i))
  if(x == 1){
    landmark_plot_data <- landmark_plot_data
  } else {
    y <- filter(landmark_plot_data, month == (i - 1))
    placeholder <- as.data.frame(transpose(as.data.frame(c(i, 0, y$cum_time_freq))))
    colnames(placeholder) <- c("month", "time_freq", "cum_time_freq")
    landmark_plot_data <- rbind(landmark_plot_data, placeholder) %>% arrange(month)
  }
} 

# Theme for plot
theme_min <- function(){
    theme(panel.background = element_rect(fill = "white", colour = "black", size = 0.5),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(margin = margin(0, 0, 10, 0), face= "bold", size = 12, hjust = 0.5))
}

ggplot(landmark_plot_data, aes(x = month, y = cum_time_freq, label = cum_time_freq)) + 
  geom_line() + geom_point() + scale_y_continuous(expand = expansion(mult = c(0, .1))) +
  xlab("Time (Months)") + ylab("Cumulative count") + scale_x_continuous(breaks = seq(0, 12, 1), expand = c(0, 0)) +
  theme_min() + geom_vline(xintercept = 3, linetype = "dashed", alpha = 0.5) + 
  ggtitle("Cumulative count of first RASi dispensation after discharge in the first year")

setwd("~/Research/[] Nephrology/3. AKI_ACEi-ARB/SCREAM2/Figures/SA")

ggsave("landmark_plot1y_sa4.pdf", width = 8, height = 5, dpi = 600)

```